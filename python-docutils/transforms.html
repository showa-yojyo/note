
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>サブパッケージ docutils.transforms &#8212; 読書ノート v1.5dev</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/prefab.css" />
    
    <script src="../_static/mathjax-v3.js"></script>
    <script src="../_static/mermaid.js"></script>
    
    <link rel="next" title="モジュール docutils.io" href="io.html" />
    <link rel="prev" title="サブパッケージ docutils.parsers" href="parsers.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="io.html" title="モジュール docutils.io"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="parsers.html" title="サブパッケージ docutils.parsers"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">読書ノート</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Docutils 解読ノート</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">サブパッケージ <code class="docutils literal notranslate"><span class="pre">docutils.transforms</span></code></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="docutils-transforms">
<h1><a class="toc-backref" href="#id9">サブパッケージ <code class="docutils literal notranslate"><span class="pre">docutils.transforms</span></code></a><a class="headerlink" href="#docutils-transforms" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://docutils.sourceforge.io/">Docutils</a> のサブパッケージ <code class="docutils literal notranslate"><span class="pre">docutils.transforms</span></code> について記す。モジュールの docstring によるとこのサブパッケージの機能は次のようなものだ。</p>
<ul class="simple">
<li><p>初回構文解析の残作業を仕上げる</p></li>
<li><p>文書中のハイパーリンクを自動で生成する</p></li>
<li><p>文書データから情報を抽出し、索引や目次を生成する</p></li>
</ul>
<div class="contents topic" id="id1">
<p class="topic-title">ノート目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#docutils-transforms" id="id9">サブパッケージ <code class="docutils literal notranslate"><span class="pre">docutils.transforms</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id10">クラス図</a></p></li>
<li><p><a class="reference internal" href="#transform" id="id11">クラス <code class="docutils literal notranslate"><span class="pre">Transform</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id12">データ</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id13">メソッド</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id14">サブクラス</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#transformer" id="id15">クラス <code class="docutils literal notranslate"><span class="pre">Transformer</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id16">データ</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id17">メソッド</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id8" id="id18">感想</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="id2">
<h2><a class="toc-backref" href="#id10">クラス図</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>クラス <code class="docutils literal notranslate"><span class="pre">Transformer</span></code> と <code class="docutils literal notranslate"><span class="pre">Transform</span></code> を中心に据えた簡素なクラス図を以下に示す。ただし、本節の考察対象外のクラスは掲載を省略したり、クラスを意味する矩形を灰色に塗りつぶしたりしてある。</p>
<ul class="simple">
<li><p>クラス <code class="docutils literal notranslate"><span class="pre">TransformSpec</span></code> および <code class="docutils literal notranslate"><span class="pre">Component</span></code> については
<a class="reference internal" href="base.html"><span class="doc">基礎クラス群</span></a> を参照。</p></li>
</ul>
<div align="center" class="mermaid align-center">
            classDiagram
    direction TB

    TransformSpec &lt;|-- Component
    TransformSpec &lt;|-- Transformer

    class Component{
        str component_type$
    }

    class Transformer{
        -int serialno
        +add_transform(Transform)
        +add_transforms(...)
        +add_pending(...)
        +apply_transforms()
        +get_priority_string(int) str
        +populate_from_components(components)
    }

    class TransformSpec{
        +get_transforms()
    }

    Transformer o-- Transform: transforms

    Transformer o-- Component: components
    Transformer --&gt; document: document
    %%Node --* document

    class Transform{
        #int default_priority$
        +apply()*
    }

    Transform --&gt; document: document
    Transform --&gt; Node: start_node
    Node &lt;|-- document
    Transform &lt;|-- ConcreteTransform

    class ConcreteTransform{
        #int default_priority$
        +apply()
    }

        </div>
        </section>
<section id="transform">
<h2><a class="toc-backref" href="#id11">クラス <code class="docutils literal notranslate"><span class="pre">Transform</span></code></a><a class="headerlink" href="#transform" title="Permalink to this headline">¶</a></h2>
<p>スーパークラスはなく、代わりにサブクラスが多数派生しているというクラスだ。</p>
<section id="id3">
<h3><a class="toc-backref" href="#id12">データ</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>クラススコープのメンバーデータが一つある。</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">default_priority</span></code></dt><dd><p>0 以上 999 以下の数値で、この変換オブジェクトの処理優先順位を表現するもの。サブクラスで上書きする。</p>
</dd>
</dl>
<p>オブジェクトデータは次の三つだ。</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">document</span></code></dt><dd><p>この変換オブジェクトの対象となる構文木オブジェクト。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Transformer</span></code> オブジェクトと共有。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">startnode</span></code></dt><dd><p>この変換処理の開始ノード。おそらくこのノードを根に見立てた部分木の全ノードが処理対象。</p>
<ul class="simple">
<li><p>構文木すべてのノードを対象とする変換もあり得る。その際は <code class="docutils literal notranslate"><span class="pre">startnode</span> <span class="pre">=</span> <span class="pre">None</span></code> としてもよい。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">language</span></code></dt><dd><p>言語モジュール。詳しくは <a class="reference internal" href="languages.html"><span class="doc">サブパッケージ docutils.languages</span></a> 参照。</p>
</dd>
</dl>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id13">メソッド</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">apply(self,</span> <span class="pre">**kwargs)</span></code></dt><dd><p>構文木を変換するためのメソッドだが、実装はサブクラス側になる。サブクラスでこのメソッドを上書きしないと <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> が送出されることになる。</p>
</dd>
</dl>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id14">サブクラス</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>クラス <code class="docutils literal notranslate"><span class="pre">Transform</span></code> のサブクラスは多数存在し、このサブパッケージ内にあるモジュールで定義されている。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Transform</span>
    <span class="n">components</span><span class="o">.</span><span class="n">Filter</span>
    <span class="n">frontmatter</span><span class="o">.</span><span class="n">TitlePrompter</span>
    <span class="n">frontmatter</span><span class="o">.</span><span class="n">DocInfo</span>
    <span class="n">misc</span><span class="o">.</span><span class="n">CallBack</span>
    <span class="n">misc</span><span class="o">.</span><span class="n">ClassAttribute</span>
    <span class="n">misc</span><span class="o">.</span><span class="n">Transitions</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">SectNum</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">Contents</span>
    <span class="n">peps</span><span class="o">.</span><span class="n">Headers</span>
    <span class="n">peps</span><span class="o">.</span><span class="n">Contents</span>
    <span class="n">peps</span><span class="o">.</span><span class="n">TargetNotes</span>
    <span class="n">peps</span><span class="o">.</span><span class="n">PEPZero</span>
    <span class="n">references</span><span class="o">.</span><span class="n">PropagateTargets</span>
    <span class="n">etc</span><span class="o">.</span>
</pre></div>
</div>
<p>一つ例を見よう。次のコードはモジュール <code class="docutils literal notranslate"><span class="pre">docutils.transforms.peps</span></code> から改変引用したものだ。サブクラス <code class="docutils literal notranslate"><span class="pre">Contents</span></code> は空の TOC をドキュメントの適切な位置に挿し込むような変換を施す。メソッド <code class="docutils literal notranslate"><span class="pre">apply</span></code> を上書きして、構文木ノードのサブクラス <code class="docutils literal notranslate"><span class="pre">title</span></code>, <code class="docutils literal notranslate"><span class="pre">topic</span></code>, <code class="docutils literal notranslate"><span class="pre">pending</span></code> それぞれのオブジェクトを生成する。最後にドキュメントの然るべき場所に収める。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">languages</span>
<span class="kn">from</span> <span class="nn">docutils.transforms</span> <span class="kn">import</span> <span class="n">Transform</span><span class="p">,</span> <span class="n">parts</span>

<span class="k">class</span> <span class="nc">Contents</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>

    <span class="n">default_priority</span> <span class="o">=</span> <span class="mi">380</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">languages</span><span class="o">.</span><span class="n">get_language</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">topic</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">])</span>

        <span class="o">...</span>

        <span class="n">pending</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pending</span><span class="p">(</span><span class="n">parts</span><span class="o">.</span><span class="n">Contents</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">+=</span> <span class="n">pending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_pending</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="transformer">
<h2><a class="toc-backref" href="#id15">クラス <code class="docutils literal notranslate"><span class="pre">Transformer</span></code></a><a class="headerlink" href="#transformer" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>スーパークラスは <code class="docutils literal notranslate"><span class="pre">TransformSpec</span></code> 一つ。</p></li>
<li><p>サブクラスはない。このクラスは継承を目的としていない。</p></li>
<li><p>クラス <code class="docutils literal notranslate"><span class="pre">document</span></code> の初期化メソッドで <code class="docutils literal notranslate"><span class="pre">Transformer</span></code> オブジェクトを生成して、メンバーデータ <code class="docutils literal notranslate"><span class="pre">self.transformer</span></code> に収める。</p></li>
<li><p>モジュール <code class="docutils literal notranslate"><span class="pre">docutils.core</span></code> のクラス <code class="docutils literal notranslate"><span class="pre">Publisher</span></code> に
<code class="docutils literal notranslate"><span class="pre">Transformer</span></code> のメソッドを利用する処理例が見られる。</p></li>
</ul>
<section id="id6">
<h3><a class="toc-backref" href="#id16">データ</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>メンバーデータはすべてオブジェクトの属性だ。</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.transforms</span></code></dt><dd><p>次の 4-tuple アイテムを格納するリスト。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">str</span></code>: 優先度を示す文字列。後述の <code class="docutils literal notranslate"><span class="pre">get_priority_string</span></code> の説明を参照。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transform_class</span></code>: <code class="docutils literal notranslate"><span class="pre">Transform</span></code> のサブクラスの型。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node</span></code>: 変換処理を施すノードオブジェクト。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kwargs</span></code>: メソッド <code class="docutils literal notranslate"><span class="pre">transform_class.apply</span></code> のパラメーター。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.unknown_reference_resolvers</span></code></dt><dd><p>不明。調べる気がしない。</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.document</span></code></dt><dd><p>この変換オブジェクトの対象となる構文木オブジェクト。</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.applied</span></code></dt><dd><p>変換処理が済んだものを格納するリスト。アイテムの型は <code class="docutils literal notranslate"><span class="pre">self.transforms</span></code> と同じ。</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.sorted</span></code></dt><dd><p>フラグ。メソッド <code class="docutils literal notranslate"><span class="pre">apply_transforms</span></code> 内で <code class="docutils literal notranslate"><span class="pre">transforms</span></code> のソートが済んだかどうかをマークする。</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.components</span></code></dt><dd><p>辞書オブジェクト。キーはコンポーネントタイプを意味する文字列で、値は <code class="docutils literal notranslate"><span class="pre">Component</span></code> のサブクラスのオブジェクト。</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.serialno</span></code></dt><dd><p>ソートキーの管理用。後述の <code class="docutils literal notranslate"><span class="pre">get_priority_string</span></code> の説明を参照。</p>
</dd>
</dl>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id17">メソッド</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">add_transform(self,</span> <span class="pre">transform_class,</span> <span class="pre">priority=None,</span> <span class="pre">**kwargs)</span></code></dt><dd><p>変換処理を一つだけ登録する。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">transform_class</span></code> は <code class="docutils literal notranslate"><span class="pre">Transform</span></code> のサブクラスを型として渡す。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">priority</span></code> は優先度。未指定ならば <code class="docutils literal notranslate"><span class="pre">default_priority</span></code> が適用される。以降のメソッドでも同様。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kwargs</span></code> は変換メソッド <code class="docutils literal notranslate"><span class="pre">apply</span></code> のパラメーター。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transforms</span></code> にデータが登録されるが、ここではソートし直さない。以降のメソッドでも同様。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">add_transforms(self,</span> <span class="pre">transform_list)</span></code></dt><dd><p>上述メソッドの複数オブジェクト版。</p>
<ul class="simple">
<li><p>変換処理の優先度は各 <code class="docutils literal notranslate"><span class="pre">Transform</span></code> オブジェクトの <code class="docutils literal notranslate"><span class="pre">default_priority</span></code> に基いて決まる。</p></li>
<li><p>変換処理の対象ノードとパラメーターは両方とも空。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">add_pending(self,</span> <span class="pre">pending,</span> <span class="pre">priority=None)</span></code></dt><dd><p>変換保留になったノードに対する変換処理の登録という、やや複雑な手続きを行う。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pending</span></code> はノードオブジェクト。このメンバーデータの <code class="docutils literal notranslate"><span class="pre">transform</span></code> が採用される。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">get_priority_string(self,</span> <span class="pre">priority)</span></code></dt><dd><p>メソッド <code class="docutils literal notranslate"><span class="pre">add_xxxx</span></code> 系の補助メソッド。優先度のキーは次の形式の文字列である。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;</span><span class="si">{priority:03d}</span><span class="s1">-</span><span class="si">{serialno:03d}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>このメソッドを呼び出す度に self.serialno をインクリメントする。</p></li>
</ul>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">populate_from_components(self,</span> <span class="pre">components)</span></code></dt><dd><p>詳細不明。というより見る気がしない。</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">apply_transforms(self)</span></code></dt><dd><p>格納されている変換処理を優先順位に従い適用する。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.transforms</span></code> から変換データを順次 <code class="docutils literal notranslate"><span class="pre">pop</span></code> して <code class="docutils literal notranslate"><span class="pre">apply</span></code> していく。</p></li>
<li><p>変換処理が済んだら <code class="docutils literal notranslate"><span class="pre">self.applied</span></code> に変換データを移す。</p></li>
<li><p>ループの途中で <code class="docutils literal notranslate"><span class="pre">self.transforms</span></code> を再ソートすることがあるようだ。ということは、どこかの <code class="docutils literal notranslate"><span class="pre">apply</span></code> が間接的に <code class="docutils literal notranslate"><span class="pre">self.transforms</span></code> を更新するということか。</p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id18">感想</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>構文木を構成するノードを「変形」する処理のための枠組みを与える機能群ということだろう。個々のノードの属性を更新するような変形も、ノードの構成を追加したり削除したり置換したり順序を入れ替えたりする変形もあり得る。</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="io.html" title="モジュール docutils.io"
             >next</a></li>
        <li class="right" >
          <a href="parsers.html" title="サブパッケージ docutils.parsers"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">読書ノート</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Docutils 解読ノート</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">サブパッケージ <code class="docutils literal notranslate"><span class="pre">docutils.transforms</span></code></a></li> 
      </ul>
    </div>
    <div id="footer">
      <div id="footer_logo">
        <a class="imga" href="https://showa-yojyo.github.io/" title="プレハブ小屋 Since 1999"><img src="../_static/logos.png" width="88" height="31" /></a>
      </div>
      <div id="footer_copyright">
        Since 1999<br />
        Copyright &copy; 1999-2022, プレハブ小屋 All rights reserved.
      </div>
    </div>
  </body>
</html>