<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>LibreOffice Calc Chapter 13, Macros ノート &#8212; 読書ノート 1.6dev</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=c9b0a06a" />
    <script src="../../_static/documentation_options.js?v=4354bf25"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/mermaid.js?v=578dbed1"></script>
    <link rel="next" title="Chapter 14, Calc as a Database ノート" href="calc14.html" />
    <link rel="prev" title="Calc Guide Chapter 12, Sharing and Reviewing Spreadsheets ノート" href="calc12.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
    <div class="related top">
      &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="calc12.html" title="Previous">Calc Guide Chapter 12, Sharing and Reviewing Spreadsheets ノート</a>
        </li>
      
        <li>
          &uarr;
          <a href="index.html" title="Parent">LibreOffice Calc Guide 読書ノート</a>
        </li>
        <li>
          <a href="calc14.html" title="Next">Chapter 14, Calc as a Database ノート</a>
          &rarr;
        </li>
    </ul>
  </nav>
    </div>


          <div class="body" role="main">
            
  <section id="libreoffice-calc-chapter-13-macros">
<h1>LibreOffice Calc Chapter 13, Macros ノート<a class="headerlink" href="#libreoffice-calc-chapter-13-macros" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="id1">
<p class="topic-title">章見出し</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id4">Introduction</a></p></li>
<li><p><a class="reference internal" href="#on-visual-basic-for-applications-vba-compatibility" id="id5">On Visual Basic for Applications (VBA) compatibility</a></p></li>
<li><p><a class="reference internal" href="#using-the-macro-recorder" id="id6">Using the macro recorder</a></p></li>
<li><p><a class="reference internal" href="#write-your-own-functions" id="id7">Write your own functions</a></p>
<ul>
<li><p><a class="reference internal" href="#create-a-function-macro" id="id8">Create a function macro</a></p></li>
<li><p><a class="reference internal" href="#using-a-macro-as-a-function" id="id9">Using a macro as a function</a></p></li>
<li><p><a class="reference internal" href="#macro-security-warnings" id="id10">Macro security warnings</a></p></li>
<li><p><a class="reference internal" href="#loaded-unloaded-libraries" id="id11">Loaded / unloaded libraries</a></p></li>
<li><p><a class="reference internal" href="#passing-arguments-to-a-macro" id="id12">Passing arguments to a macro</a></p></li>
<li><p><a class="reference internal" href="#arguments-are-passed-as-values" id="id13">Arguments are passed as values</a></p></li>
<li><p><a class="reference internal" href="#writing-macros-that-act-like-built-in-functions" id="id14">Writing macros that act like built-in functions</a></p></li>
<li><p><a class="reference internal" href="#deleting-libreoffice-basic-macros" id="id15">Deleting LibreOffice Basic macros</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#accessing-cells-directly" id="id16">Accessing cells directly</a></p></li>
<li><p><a class="reference internal" href="#sorting" id="id17">Sorting</a></p></li>
<li><p><a class="reference internal" href="#overview-of-beanshell-javascript-and-python-macros" id="id18">Overview of BeanShell, JavaScript, and Python macros</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id19">Introduction</a></p></li>
<li><p><a class="reference internal" href="#beanshell-macros" id="id20">BeanShell macros</a></p></li>
<li><p><a class="reference internal" href="#javascript-macros" id="id21">JavaScript macros</a></p></li>
<li><p><a class="reference internal" href="#python-macros" id="id22">Python macros</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#scriptforge-library" id="id23">ScriptForge library</a></p></li>
<li><p><a class="reference internal" href="#built-in-object-inspector" id="id24">Built-in object inspector</a></p></li>
<li><p><a class="reference internal" href="#working-with-vba-macros" id="id25">Working with VBA macros</a></p>
<ul>
<li><p><a class="reference internal" href="#loading-vba-code" id="id26">Loading VBA code</a></p></li>
<li><p><a class="reference internal" href="#option-vbasupport-statement" id="id27">Option VBASupport statement</a></p></li>
<li><p><a class="reference internal" href="#vba-userforms-libreoffice-basic-dialogs" id="id28">VBA UserForms (LibreOffice Basic Dialogs)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#conclusion" id="id29">Conclusion</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p><em>Getting Started Guide</em> の Chapter Getting Started with Macros の章では LibreOffice で使用できるマクロ機能を紹介している。この章では、Calc スプレッドシート内でのマクロの使用についてさらなる入門情報を与える。</p>
<p>マクロとは、後で使用するために保存される一連のコマンドやキー操作のことだ。例：開いているスプレッドシートの現在の升目に自分の住所を入力するマクロ。マクロを使用すると、単純なタスクと複雑なタスクの両方を自動化できる。また、Calc に組み込まれていない新しい機能を導入することもできる。</p>
<p>マクロを作成する最も簡単な方法は、Calc の UI を通じて一連の操作を記録することだ。
BASIC 言語の方言である LibreOffice Basic スクリプト言語により記録したマクロを保存する。そして LibreOffice Basic IDE を使用して編集および拡張可能。</p>
<p>マクロを作成する言語としては次の四つのスクリプト言語が対応されている：</p>
<ul class="simple">
<li><p>LibreOffice Basic</p></li>
<li><p>Python</p></li>
<li><p>JavaScript</p></li>
<li><p>BeanShell</p></li>
</ul>
<p>本章では LibreOffice Basic に焦点を当てる。</p>
</section>
<section id="on-visual-basic-for-applications-vba-compatibility">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">On Visual Basic for Applications (VBA) compatibility</a><a class="headerlink" href="#on-visual-basic-for-applications-vba-compatibility" title="Link to this heading">¶</a></h2>
<p>LibreOffice Basic 言語と VBA 言語は BASIC の方言だ。MS Excel で書かれたマクロを
LibreOffice で使用したい場合は、まず LibreOffice Basic IDE でコードを編集する必要がある。</p>
<p>VBA で書かれた Excel マクロを変換するためのコツは本章最後に詳しい。</p>
</section>
<section id="using-the-macro-recorder">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Using the macro recorder</a><a class="headerlink" href="#using-the-macro-recorder" title="Link to this heading">¶</a></h2>
<p><em>Getting Started Guide</em> の Getting Started With Macros の章にはマクロレコーダーの使用方法と生成された LibreOffice Basic スクリプトの理解方法の例が記載されている。以下の手順では <em>Getting Started Guide</em> のより詳細な説明を省略して Calc スプレッドシート固有の例を示す。スプレッドシートの升目範囲に対して、乗算を伴う特殊な貼り付けを実行するマクロを作成し、保存する。</p>
<div class="admonition- admonition">
<p class="admonition-title">利用者ノート</p>
<p><em>Getting Started Guide</em> を先に読んでおいたほうがいいかもしれない。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>まず、<span class="guilabel">Options</span> ダイアログボックス <span class="menuselection">LibreOffice‣Advanced</span> ページ でオプション <span class="guilabel">Enable
macro recording (may be limited)</span> をオンにしておけ。</p>
</div>
<ol class="arabic">
<li><p>Menu バー の <span class="menuselection"><span class="accelerator">F</span>ile‣<span class="accelerator">N</span>ew‣<span class="accelerator">S</span>preadsheet</span> で新しいスプレッドシートを作成する。</p></li>
<li><p>新しいスプレッドシートの <cite>Sheet1</cite> の 升目 A1:C3 に次の数値を入力する：</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>1</p></td>
<td><p>8</p></td>
<td><p>9</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>7</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>6</p></td>
<td><p>11</p></td>
</tr>
</tbody>
</table>
</li>
<li><p>数値 3 が入っている升目 A3 を選択し、クリップボードにコピーする。</p></li>
<li><p>範囲 A1:C3 のすべての升目を選択する。</p></li>
<li><p>Menu バー の <span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣<span class="accelerator">R</span>ecord Macro</span> で開始。テキストエディターにおけるキーボードマクロ開始のようなものだと考えられる。<span class="guilabel">Record Macro</span> 小窓が現れる。</p></li>
<li><p>Menu バー の <span class="menuselection"><span class="accelerator">E</span>dit‣Paste <span class="accelerator">S</span>pecial‣Paste <span class="accelerator">S</span>pecial…</span> を選択。<span class="guilabel">Paste Special</span> ダイアログボックス が開く。</p></li>
<li><p><span class="guilabel">Paste</span> 領域で <span class="guilabel"><span class="accelerator">A</span>ll</span> をオン、<span class="guilabel">Operations</span> 領域で <span class="guilabel">Mult<span class="accelerator">i</span>ply</span> をオンにし <span class="guilabel"><span class="accelerator">O</span>K</span> ボタン を押す。升目 A1:C3 の値が三倍になる。</p></li>
<li><p>小窓内の <span class="guilabel">Stop Recording</span> を押して収録終了。<span class="guilabel">Basic Macros</span> ダイアログボックス の変種が開く。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="guilabel">Basic Macros</span> ダイアログボックス の <span class="guilabel">Save Macros In</span> 領域に既存の LibreOffice
Basic マクロが見える。このマクロはライブラリーコンテナー、ライブラリー、モジュール、マクロに階層化されている。各ライブラリーコンテナー名の左側にあるプラスマイナス図像を使用して、そのコンテナー内のライブラリー、モジュール、マクロを見渡せる。</p>
</div>
</li>
<li><p><span class="guilabel">Save Macro In</span> で現在の文書の登録項目を選択する。この例では現在の文書は保存されていないので、既定の名前 <cite>Untitled 1</cite> で参照される。</p></li>
<li><p>保存された文書には <cite>Standard</cite> という名前のマクロライブラリーが含まれる。このライブラリーは必要になるまで作成されないので、この手順の例では、この時点では、新しい文書にはライブラリーが含まれていない。</p></li>
<li><p><span class="guilabel">New Mod<span class="accelerator">u</span>le</span> ボタンを押す。<span class="guilabel">New Module</span> ダイアログボックスが開く。新しいモジュールの名前を入力するか、既定の <cite>Module1</cite> のままにする。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ライブラリー名、モジュール名、マクロ名に使用可能な文字が規定されているので注意。一般的なプログラミング言語にありがちな規則だと思っていい。</p>
</div>
</li>
<li><p><span class="guilabel"><span class="accelerator">O</span>K</span> ボタン を押して新しいモジュールを作成する。現在の文書にはマクロライブラリーが存在しないため、<cite>Standard</cite> ライブラリーが作成される。</p></li>
<li><p><span class="guilabel">Basic Macros</span> ダイアログボックス の <span class="guilabel">Save Macro In</span> 領域で新しく作成したモジュールの登録項目を選択し、<span class="guilabel">Macro Name</span> ボックスにテキスト <cite>PasteMultiply</cite>
を入力し、 <span class="guilabel">保存 (<span class="accelerator">S</span>)</span> ボタン を押す。</p></li>
</ol>
<p>マクロは <cite>PasteMultiply</cite> という名前で、<cite>Untitled 1</cite> 文書の <cite>Standard</cite> ライブラリー内の新しく作成されたモジュールに保存される。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>LibreOffice で使用されている部品モデルは <abbr title="Universal Network Objects">UNO</abbr> であり、マクロレコーダーはほとんどのコマンドに <abbr title="Universal Network Objects">UNO</abbr> ディスパッチャーを使用している。しかし、この技術的手法には問題が二つある。一つはディスパッチが完全に文書化されておらず、変更される可能性があることだ。もう一つはマクロの記録中に開かれるダイアログボックスの値のいくつかをレコーダーが無視することだ。したがって、複雑なマクロを記録しても、実際にはすべてが期待どおりに実行されないことがある。詳細については Help
の索引を検索しろ。</p>
</div>
</section>
<section id="write-your-own-functions">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Write your own functions</a><a class="headerlink" href="#write-your-own-functions" title="Link to this heading">¶</a></h2>
<section id="create-a-function-macro">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Create a function macro</a><a class="headerlink" href="#create-a-function-macro" title="Link to this heading">¶</a></h3>
<p>マクロを作成し、関数を呼び出すようにそれを実行することが可能。単純な関数マクロの定義手順：</p>
<ol class="arabic">
<li><p>新規スプレッドシートを作成し、<code class="file docutils literal notranslate"><span class="pre">CalcTestMacros.ods</span></code> という名前で保存して、開いたままにする。</p></li>
<li><p>Menu バー から <span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣<span class="accelerator">O</span>rganize Macros‣<span class="accelerator">B</span>asic…</span> を選択して <span class="guilabel">Basic Macros</span> ダイアログボックス を開く。この状況での <span class="guilabel">Basic Macros</span> ダイアログボックス の間取りは、<span class="guilabel">Record Macro</span> ダイアログボックスの <span class="guilabel">Stop Recording</span> ボタンを押したときのものとは異なることに気をつけろ。</p></li>
<li><p><span class="guilabel">Macro From</span> 領域には、現在開いている LibreOffice 文書に関連するものも含め、利用可能なマクロライブラリーコンテナが一覧される。<cite>My Macros</cite> には使用者が作成または LibreOffice に追加したマクロが含まれ、複数の文書で使用可能だ。<cite>LibreOffice Macros</cite> には LibreOffice のインストール時に含まれている、変更されるべきではないマクロが含まれる。</p></li>
<li><p><span class="guilabel"><span class="accelerator">O</span>rganizer…</span> を押す。<span class="guilabel">Basic Macro Organizer</span> ダイアログボックス が開く。</p>
<p><span class="guilabel">Libraries</span> タブを開く。<span class="guilabel">L<span class="accelerator">o</span>cation</span> ドロップダウンリストで現在文書に合わせる <span class="guilabel"><span class="accelerator">L</span>ibrary</span> 欄の一覧が更新され、空の <cite>Standard</cite>
ライブラリーの名前が示される。</p>
</li>
<li><p><span class="guilabel"><span class="accelerator">N</span>ew…</span> を押して <span class="guilabel">New Library</span> ダイアログボックスを開き、この文書の新規ライブラリーを作成する。</p></li>
<li><p>意味のある名前を記入して <span class="guilabel"><span class="accelerator">O</span>K</span> ボタン を押してライブラリーを作成する。この説明中では名前を <cite>AuthorsCalcMacros</cite> とする。 <span class="guilabel">Basic Macro Organizer</span> ダイアログボックス の
<span class="guilabel"><span class="accelerator">L</span>ibrary</span> 領域が更新され、新しく作成されたライブラリーの名前が表示される。ライブラリー名は 30 文字まで使用できる。ダイアログボックスには名前の一部しか表示されない場合がある。</p></li>
<li><p><span class="guilabel"><span class="accelerator">L</span>ibrary</span> で <cite>AuthorsCalcMacros</cite> 項目を選択し、<span class="guilabel"><span class="accelerator">E</span>dit…</span> ボタン を押してライブラリーを編集する。<cite>Module1</cite> と <cite>Main</cite> という名前のマクロが自動的に生成する。LibreOffice Basic 統合開発環境 (IDE) が開く。</p>
<p>LibreOffice Basic IDE の既定構成は以下のとおり：</p>
<ul class="simple">
<li><p>Menu バー</p></li>
<li><p>ツールバー二つ。<span class="guilabel">Macro</span> ツールバーにはプログラムを編集したりテストしたりするための図像各種が用意されている。</p></li>
<li><p><span class="guilabel">Object Catalog</span> 窓では必要なライブラリーコンテナー、ライブラリー、モジュール、マクロを選択できる。</p></li>
<li><p>Editor  LibreOffice Basic のプログラムコードを編集する。左側の列はプログラムコードにブレイクポイントを設定するために使用する。</p></li>
<li><p><span class="guilabel">Watch</span> 窓にはシングルステップ処理中の変数や配列の内容が表示される。</p></li>
<li><p><span class="guilabel">Call Stack</span> 窓は関数のコールスタックに関する情報を与える。</p></li>
<li><p>タブが並ぶ部分</p></li>
<li><p>Status バー</p></li>
</ul>
<p>LibreOffice Basic IDE は LibreOffice Basic マクロの開発とデバッグのための強力な機能を搭載している。この機能の詳細については Help を参照しろ。</p>
</li>
<li><p>Editor Window でコードを修正する。重要な追加点は、値 5 を返す <code class="docutils literal notranslate"><span class="pre">NumberFive</span></code>
関数の作成だ。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="docutils literal notranslate"><span class="pre">Option</span> <span class="pre">Explicit</span></code> 文はすべての変数を使用する前に宣言することを強制する。
<code class="docutils literal notranslate"><span class="pre">Option</span> <span class="pre">Explicit</span></code> が省略された場合、変数は最初の使用時に自動的に
<code class="docutils literal notranslate"><span class="pre">Variant</span></code> 型として定義される。</p>
</div>
</li>
<li><p>LibreOffice Basic IDE 内で Menu バー の <span class="menuselection"><span class="accelerator">F</span>ile‣<span class="accelerator">S</span>ave</span> を選択するか、<span class="guilabel">Standard</span> ツールバー の <span class="guilabel">Save</span> 図像をクリックするか、<kbd class="kbd docutils literal notranslate">Ctrl</kbd> +
<kbd class="kbd docutils literal notranslate">S</kbd> を押して、変更した <cite>Module1</cite> を保存する。</p></li>
</ol>
</section>
<section id="using-a-macro-as-a-function">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Using a macro as a function</a><a class="headerlink" href="#using-a-macro-as-a-function" title="Link to this heading">¶</a></h3>
<p>セルを選択し、数式バーにマクロ呼び出しコードを入力すると、Calc がマクロを検出して呼び出し、そのセルに結果を表示する。</p>
<p>新しく作成した <code class="file docutils literal notranslate"><span class="pre">CalcTestMacros.ods</span></code> スプレッドシートを使用して、セルを選択し、数式 <code class="docutils literal notranslate"><span class="pre">=NumberFive()</span></code> を入力する。Calc がマクロを検出して呼び出し、そのセルに結果 (5) を表示する。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>関数名は大文字と小文字を区別しない。図では関数名は <code class="docutils literal notranslate"><span class="pre">NumberFive</span></code> と入力されているが、Calc は Formula バー に <code class="docutils literal notranslate"><span class="pre">NUMBERFIVE</span></code> と表示する。</p>
</div>
</section>
<section id="macro-security-warnings">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Macro security warnings</a><a class="headerlink" href="#macro-security-warnings" title="Link to this heading">¶</a></h3>
<div class="admonition- admonition">
<p class="admonition-title">利用者ノート</p>
<p>本節の内容が再現できない。実際にスプレッドシートを開き直すと本書のスクリーンショットのようなものは現れず。シート上部に警告が表示される。そこには
<span class="guilabel"><span class="accelerator">E</span>nable Macros</span> ボタンのようなものは存在しない。</p>
<p>これは <span class="guilabel">Options</span> ダイアログボックス <span class="menuselection">LibreOffice‣Security</span> ページ の <span class="guilabel">Macro <span class="accelerator">s</span>ecurity…</span> を押して、<span class="guilabel">Trusted Sources</span> タブの信用ファイルパス一覧を操作して回避することにする。</p>
</div>
<p>Calc 文書を保存して閉じ、再度開け。<span class="guilabel">Options</span> ダイアログボックス <span class="menuselection">LibreOffice‣Security</span> ページ にある
<span class="guilabel">Macro Securit<span class="accelerator">y</span>…</span> を使用してアクセスした <span class="guilabel">Macro Security</span> ダイアログボックス の設定によっては警告されることがある。</p>
<p>警告ダイアログボックスに <span class="guilabel"><span class="accelerator">E</span>nable Macros</span> ボタンがある場合、それを押す必要がある。文書にマクロが含まれることが予想されない場合は、マクロがウイルスである場合に備えて、<span class="guilabel"><span class="accelerator">D</span>isable Macros</span> を押す方が安全だ。</p>
<p>設定により無効である旨の警告の場合、文書内でのマクロ実行は許可されない。<span class="guilabel"><span class="accelerator">O</span>K</span> ボタン を押して警告を消す。</p>
<p>マクロを無効にして文書を読み込むと、Calc はマクロ関数を見つけることができず、影響を受けるセルにテキスト <cite>#NAME?</cite> を表示してエラーを指摘する。</p>
</section>
<section id="loaded-unloaded-libraries">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Loaded / unloaded libraries</a><a class="headerlink" href="#loaded-unloaded-libraries" title="Link to this heading">¶</a></h3>
<p>スプレッドシートを開くとき、利用可能なライブラリコンテナーで見つかるマクロライブラリーすべてを開かない。代わりに、自動的に <cite>My Macros</cite> ライブラリコンテナー内の
<cite>Standard</cite> ライブラリーと、文書自体の <cite>Standard</cite> ライブラリーしか読み込まない。</p>
<p><code class="file docutils literal notranslate"><span class="pre">CalcTestMacros.ods</span></code> スプレッドシートを再度開くと、Calc には <cite>NumberFive</cite>
という名前の関数が含まれていないため、この関数があるかどうか、表示され、読み込まれているすべてのマクロライブラリーが調べられる。<cite>LibreOffice Macros</cite>, <cite>My
Macros</cite>, および文書にロードされたライブラリーで、適切な名前の関数があるかどうかが調べられる。本章での初期実装では <cite>NumberFive</cite> 関数は <cite>AuthorsCalcMacros</cite> ライブラリーに格納されている。そのため <cite>NumberFive</cite> 関数は見つからず、呼び出された升目にエラー状態が表示される。</p>
<p>Menu バー <span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣<span class="accelerator">O</span>rganize Macros‣<span class="accelerator">B</span>asic…</span> を使用して <span class="guilabel">Basic Macros</span> ダイアログボックス を開け。ロードされたライブラリーの図像は、ロードされていないライブラリー (<cite>AuthorsCalcMacros</cite>) のそれとは見てくれが異なる。</p>
<p>ライブラリーをロードするために <cite>AuthorsCalcMacros</cite> の横にある展開図像をクリックしろ。図像の見てくれが変わり、ライブラリーがロードされたことを示唆する。<span class="guilabel"><span class="accelerator">C</span>lose</span> ボタン
を押して <span class="guilabel">Basic Macros</span> ダイアログボックス を閉じろ。</p>
<p>最初の実装では <code class="docutils literal notranslate"><span class="pre">=NumberFive()</span></code> を含む升目はまだエラーになっている。Calc は升目を編集するか何らかの方法で変更しない限り、エラー中のセルを再計算しない。通常の解決策は、関数として使用されるマクロを <cite>Standard</cite> ライブラリーに格納することだ。マクロの規模が大きい場合や数が多い場合は、希望する名前のスタブが <cite>Standard</cite> ライブラリーに格納される。スタブマクロは実装を含むライブラリーをロードし、実装を呼び出す。次の手順だ。</p>
<ol class="arabic simple">
<li><p>Menu バー <span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣<span class="accelerator">O</span>rganize Macros‣<span class="accelerator">B</span>asic…</span> を使用して、<span class="guilabel">Basic Macros</span> ダイアログボックス を開く。
<cite>NumberFive</cite> マクロを選択し、<span class="guilabel"><span class="accelerator">E</span>dit…</span> ボタン を押して編集用のマクロを開く。</p></li>
<li><p>LibreOffice Basic IDE が開く。キャレットは Editor 窓の関数 <cite>NumberFive</cite> の行に置かれる。関数のコードが TODO と一致するように、<cite>NumberFive</cite> の名前を
<cite>NumberFive_Implementation</cite> に変更する。</p></li>
<li><p>LibreOffice Basic IDE の <span class="guilabel">Standard</span> ツールバー の <span class="guilabel">Select Macro</span> ボタンを押して <span class="guilabel">Basic Macros</span> ダイアログボックス を開く。</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">CalcTestMacros.ods</span></code> 内の <cite>Standard</cite> ライブラリーを選択し、
<span class="guilabel">New</span> ボタンを押して新しいモジュールを作成する。<cite>CalcFunctions</cite> など意味のある名前を入力し、<span class="guilabel"><span class="accelerator">O</span>K</span> ボタン を押す。Calc は自動的に <cite>Main</cite> という名前のマクロを作成し、編集用にモジュールを開く。</p></li>
<li><p><cite>Standard</cite> ライブラリーの <cite>CalcFunctions</cite> モジュールに <cite>AuthorsCalcMacros</cite> ライブラリーがまだロードされていなければロードし、実装関数を呼び出すマクロを作成する。TODO</p></li>
<li><p>保存して閉じ、Calc 文書を再度開く。今度は、マクロが有効になっていれば、
<cite>NumberFive</cite> 関数は期待どおりに動作する。</p></li>
</ol>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>スプレッドシートを開くとロードされるマクロライブラリーは次の二種類だ：</p>
<ul class="simple">
<li><p><cite>My Macros</cite> ライブラリー容器内の <cite>Standard</cite> ライブラリー</p></li>
<li><p>文書自身の <cite>Standard</cite> ライブラリー</p></li>
</ul>
<p>それゆえ、先ほどのスプレッドシートを再度開くと、マクロ関数呼び出しのセルは
<code class="docutils literal notranslate"><span class="pre">#NAME?</span></code> エラーとなる。これを修正する手順は本書のように二段階に分かれる：</p>
<ol class="arabic simple">
<li><p><span class="guilabel">Basic Macros</span> ダイアログボックス を開いて、ツリーノードを選択することで対象ライブラリーをロードする。</p></li>
<li><p>マクロ実装を次のように修正する：</p>
<ul class="simple">
<li><p>本体実装を MyMacros/Standard/CalcFunctions に移転する。</p></li>
<li><p>旧関数はそのラッパーとする。</p></li>
</ul>
</li>
</ol>
</div>
</section>
<section id="passing-arguments-to-a-macro">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Passing arguments to a macro</a><a class="headerlink" href="#passing-arguments-to-a-macro" title="Link to this heading">¶</a></h3>
<p>本文で示されている関数で用いられている重要な技法とは：</p>
<ol class="arabic simple">
<li><p>仮引数に <code class="docutils literal notranslate"><span class="pre">Optional</span></code> キーワードを付ける。</p></li>
<li><p>オプション引数を関数 <code class="docutils literal notranslate"><span class="pre">IsMissing</span></code> で実引数が与えられたかをチェックする。</p></li>
<li><p>関数 <code class="docutils literal notranslate"><span class="pre">IsArray</span></code> で値が配列であるかどうかをチェックする。</p></li>
<li><p>関数に <code class="docutils literal notranslate"><span class="pre">PositiveSum(A2:B5)</span></code> のように範囲が渡される場合に備え、関数
<code class="docutils literal notranslate"><span class="pre">LBound</span></code> と <code class="docutils literal notranslate"><span class="pre">UBound</span></code> を用いて配列の境界を決定する（前者は 1 であることが確定しているが、コードの一貫性を高めるためにこう書く）。</p></li>
</ol>
<p>本書で次に示されている関数のように、引数リストは一般的なプログラミング言語のそれのように記述される。</p>
</section>
<section id="arguments-are-passed-as-values">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Arguments are passed as values</a><a class="headerlink" href="#arguments-are-passed-as-values" title="Link to this heading">¶</a></h3>
<p>Calc からマクロに渡される引数は常に値 (by-value) だ。つまり、どのセルが使用されたかを知ることはできない。どのセルが参照されたかを知る必要がある場合は、範囲を文字列として渡し、その文字列を解析して、参照されたセル内の値を取得するなどする。</p>
</section>
<section id="writing-macros-that-act-like-built-in-functions">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Writing macros that act like built-in functions</a><a class="headerlink" href="#writing-macros-that-act-like-built-in-functions" title="Link to this heading">¶</a></h3>
<p>Calc はマクロを関数として検出、呼び出すが、組み込み関数としての振る舞いはしない。例えば、マクロは関数一覧に現れない。</p>
</section>
<section id="deleting-libreoffice-basic-macros">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Deleting LibreOffice Basic macros</a><a class="headerlink" href="#deleting-libreoffice-basic-macros" title="Link to this heading">¶</a></h3>
<p>マクロを削除したい場合とモジュールを削除したい場合がある。不要なマクロを削除する手順は：</p>
<ol class="arabic simple">
<li><p>上述のように <span class="guilabel">Macros</span> ダイアログボックスを開く。</p></li>
<li><p>削除対象のマクロを選択して <span class="guilabel"><span class="accelerator">D</span>elete</span> を押す。</p></li>
<li><p>確認で <span class="guilabel"><span class="accelerator">Y</span>es</span> ボタン を押す。</p></li>
<li><p><span class="guilabel"><span class="accelerator">C</span>lose</span> ボタン を押す。</p></li>
</ol>
<p>不要なモジュールを削除する手順：</p>
<ol class="arabic simple">
<li><p>上述のように <span class="guilabel">Macros</span> ダイアログボックスを開く。</p></li>
<li><p><span class="guilabel">Organizer</span> を押して <span class="guilabel">Basic Macro Organizer</span> ダイアログボックス を開く。</p></li>
<li><p><span class="guilabel">Modules</span> タブが開いているので、削除対象モジュールを選択する。</p></li>
<li><p><span class="guilabel"><span class="accelerator">D</span>elete</span> を押す。</p></li>
<li><p>確認で <span class="guilabel"><span class="accelerator">Y</span>es</span> ボタン を押す。</p></li>
<li><p><span class="guilabel"><span class="accelerator">C</span>lose</span> ボタン を押す。</p></li>
</ol>
</section>
</section>
<section id="accessing-cells-directly">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Accessing cells directly</a><a class="headerlink" href="#accessing-cells-directly" title="Link to this heading">¶</a></h2>
<p>LibreOffice の内部オブジェクトに直接アクセスして、Calc 文書を操作できる。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ThisComponent.getSheets()</span></code> によってシートにアクセスする。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getCellByPosition(col,</span> <span class="pre">row)</span></code> で特定の行と列のセルを得る。</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>セルオブジェクトのメソッドはとりあえず次を知っておくといい。適切な値を設定するには、対応する <code class="docutils literal notranslate"><span class="pre">set</span></code> 関数を使用する：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">getValue()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getString()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getFormula()</span></code></p></li>
</ul>
</div>
<p>シートオブジェクトの <code class="docutils literal notranslate"><span class="pre">getCellRangeByName</span></code> メソッドはセルまたはセル範囲を返す。セル範囲は配列の配列としてデータを返すので、二次元の配列として扱うよりも面倒だ。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>マクロが Calc 関数として呼び出される場合、関数を含むセルを除き、マクロが呼び出されたシート内のセルの値を変更することはない。</p>
</div>
</section>
<section id="sorting">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Sorting</a><a class="headerlink" href="#sorting" title="Link to this heading">¶</a></h2>
<p>ソートをコードで実現しようとすると、本書のように案外いろいろなオブジェクトの面倒面倒を見なければならないということを覚えておけば今はいいだろう。</p>
</section>
<section id="overview-of-beanshell-javascript-and-python-macros">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Overview of BeanShell, JavaScript, and Python macros</a><a class="headerlink" href="#overview-of-beanshell-javascript-and-python-macros" title="Link to this heading">¶</a></h2>
<section id="id2">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Introduction</a><a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>ここまで見てきたコードは LibreOffice Basic という言語だ。他にも次の言語を対応している：</p>
<ul class="simple">
<li><p>BeanShell</p></li>
<li><p>JavaScript</p></li>
<li><p>Python</p></li>
</ul>
<p>マクロの構成は四つのスクリプト言語すべてで同じだ。<cite>LibreOffice Macros</cite> コンテナーには LibreOffice のインストール時に供給されるマクロすべてが含まれる。<cite>My
Macros</cite> ライブラリコンテナーには LibreOffice 文書で使用できるマクロを含む。各文書には他の文書では使用できないマクロを格納することもできる。</p>
<p>先述のマクロ記録機能を使用すると Calc は LibreOffice Basic でマクロを作成する。その他のスクリプト言語を使用するには、自分でコードを記述する必要がある。</p>
<p><span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣R<span class="accelerator">u</span>n Macro…</span> コマンドは上記の言語のいずれも実行可能だ。</p>
<p><span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣<span class="accelerator">E</span>dit Macros…</span> コマンドは Basic マクロだけ選択、編集可能だ。</p>
<p>LibreOffice で使用されているコンポーネントモデルは <abbr title="Universal Network Objects">UNO</abbr> として知られている。スクリプト言語の LibreOffice マクロは <abbr title="Universal Network Objects">UNO</abbr> 実行時 API を使用する。XSCRIPTCONTEXT
インターフェイスが四言語すべてのマクロスクリプトに対して用意され、文書に対して何らかの動作を実行するために必要となるさまざまなインターフェイスへのアクセス手段を備えている。</p>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>LibreOffice の前身である OpenOffice から存在するものらしい？</p>
</div>
</section>
<section id="beanshell-macros">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">BeanShell macros</a><a class="headerlink" href="#beanshell-macros" title="Link to this heading">¶</a></h3>
<blockquote>
<div><p>BeanShell is a Java-like scripting language that was first released in 1999.</p>
</div></blockquote>
<p>Menu バー から <span class="menuselection"><span class="accelerator">T</span>ools‣<span class="accelerator">M</span>acros‣<span class="accelerator">O</span>rganize Macros‣
B<span class="accelerator">e</span>anShell…</span> を実行すると <span class="guilabel">BeanShell Macros</span> ダイアログボックスが開く。</p>
<div class="admonition- admonition">
<p class="admonition-title">利用者ノート</p>
<p>JRE が有効になっている必要がある。無効なら確認ダイアログボックスが開く。</p>
</div>
<p><span class="guilabel"><span class="accelerator">E</span>dit…</span> ボタン を押せばデバッグウィンドウが開く。</p>
</section>
<section id="javascript-macros">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">JavaScript macros</a><a class="headerlink" href="#javascript-macros" title="Link to this heading">¶</a></h3>
<p>同じような操作で <span class="guilabel">JavaScript Macros</span> ダイアログボックスが開く。
<span class="guilabel"><span class="accelerator">E</span>dit…</span> ボタン を押すと <a class="reference external" href="https://github.com/mozilla/rhino">Rhino JavaScript</a> デバッガーが開く。</p>
</section>
<section id="python-macros">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Python macros</a><a class="headerlink" href="#python-macros" title="Link to this heading">¶</a></h3>
<p>同じような操作で <span class="guilabel">Python Macros</span> ダイアログボックスが開く。</p>
<p>Python スクリプトを編集およびデバッグする機能は、現在のところ LibreOffice の標準
UI に統合されていない。愛用テキストエディターや外部 IDE を使用して Python スクリプトを編集すればいい。Alternative Python Script Organizer (APSO) 拡張機能は、特に文書に埋め込まれた Python スクリプトの編集を容易にする。APSO を使用すると、愛用コードエディターを設定したり、統合 Python シェルを起動したり、Python スクリプトをデバッグしたりすることが可能だ。</p>
<p>詳細については LibreOffice Help システムで <em>Python macros</em> を検索し、
&lt;<a class="reference external" href="https://wiki.documentfoundation.org/Macros/Python_Design_Guide">https://wiki.documentfoundation.org/Macros/Python_Design_Guide</a>&gt; の関連節を見ろ。</p>
<div class="admonition- admonition">
<p class="admonition-title">利用者ノート</p>
<p>HelloWorld を実行したら Writer が起動する。なぜだ？</p>
</div>
</section>
</section>
<section id="scriptforge-library">
<h2><a class="toc-backref" href="#id23" role="doc-backlink">ScriptForge library</a><a class="headerlink" href="#scriptforge-library" title="Link to this heading">¶</a></h2>
<p>ScriptForge ライブラリーの目的は LibreOffice API やコマンドを学ぶことなく、マクロの作成を簡単にすることだ。</p>
<p>ScriptForge ライブラリーは LibreOffice Basic と Python を対応している。各サービスには特定のトピックに関連するメソッドやプロパティーがある。</p>
<ul class="simple">
<li><p><em>Getting Started Guide</em> の関連章に ScriptForge に関する補足説明と例が記載されている。</p></li>
<li><p>LibreOffice ヘルプシステムの索引で ScriptForge を検索すると情報があるはずだ。</p></li>
</ul>
</section>
<section id="built-in-object-inspector">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">Built-in object inspector</a><a class="headerlink" href="#built-in-object-inspector" title="Link to this heading">¶</a></h2>
<p>プログラマーにとって、<abbr title="Universal Network Objects">UNO</abbr> オブジェクト型や、サービス、メソッド、性質を発見することは主要な課題の一つだ。</p>
<p>Menu バー から <span class="menuselection"><span class="accelerator">T</span>ools‣Develo<span class="accelerator">p</span>ment Tools</span> を実行するとビューワーが開く。メインウィンドウ下部に入渠している。</p>
<p>ウィンドウの左側は DOM 案内図で構成され、使用者は文書内の物全てを渡り歩くことができる。物が選択されるとそれに関する次の情報が窓右側のタブに示される：</p>
<ul class="simple">
<li><p>実装されているインターフェイス全ての名前</p></li>
<li><p>支援するサービス全ての名前</p></li>
<li><p>利用可能な性質全ての名前と型</p></li>
<li><p>呼び出せるメソッド全ての名前、引数、戻り値の型</p></li>
</ul>
<p>DOM 案内図を使って物を検査する代わりに、Current Selection ボタンを切り替えることで文書内で現在選択されている物を直接検査することが可能。</p>
<p><em>Getting Started Guide</em> の <em>Getting Started with Macros</em> には組み込み物検査に関する追加情報が含まれている。より詳細な情報や例は LibreOffice Help の索引で <em>development tools</em>
を検索しろ。</p>
</section>
<section id="working-with-vba-macros">
<h2><a class="toc-backref" href="#id25" role="doc-backlink">Working with VBA macros</a><a class="headerlink" href="#working-with-vba-macros" title="Link to this heading">¶</a></h2>
<p>Calc が Excel ワークブックを読み込むにもかかわらず、その VBA が Calc で動作しない主な理由は、Calc がワークシート上のセルなどのワークブック部品にアクセスするために異なる仕組みを用いているためだ。</p>
<p>VBA コードを変換するには LibreOffice で VBA コードをまず読み込む必要がある。</p>
<section id="loading-vba-code">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Loading VBA code</a><a class="headerlink" href="#loading-vba-code" title="Link to this heading">¶</a></h3>
<p><span class="guilabel">Options</span> ダイアログボックス <span class="menuselection">Load/Save‣VBA Properties</span> ページでは LibreOffice
で開いた MS Office 文書のマクロを保持するかどうかを選択可能。</p>
<p><span class="guilabel">Load Basic <span class="accelerator">c</span>ode</span> をオンにすると LibreOffice でマクロを編集できる。変更したコードは <abbr title="OpenDocument Format">ODF</abbr> 文書に保存されるが、Microsoft Office 形式に保存した場合は保持されない。</p>
<p><span class="guilabel"><span class="accelerator">S</span>ave original Basic code</span> をオンにする場合、マクロは LibreOffice では動作しないが、ファイルを Microsoft Office 形式で保存すると変更されずに保持される。</p>
<p>VBA コードを含む Microsoft Word または Excel ファイルをインポートする場合、
<span class="guilabel">E<span class="accelerator">x</span>ecutable code</span> をオンにすることができる。通常、コードは保存されるが、機能停止状態になる <a class="footnote-reference brackets" href="#calc13-footnote-1" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> のに対し、オンにするとコードが実行可能状態になる。</p>
<p><span class="guilabel"><span class="accelerator">S</span>ave original Basic code</span> は <span class="guilabel">Load Basic <span class="accelerator">c</span>ode</span> より優先される。両方ともオンであり、LibreOffice で無効化されたコードを編集する場合、
Microsoft Office 形式で保存するときに元の VBA コードが保存される。</p>
<p>存在し得るマクロウイルスを Microsoft Office 文書から除去するには
<span class="guilabel"><span class="accelerator">S</span>ave original Basic code</span> をオフにする。文書は VBA コードなしで保存される。</p>
</section>
<section id="option-vbasupport-statement">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Option VBASupport statement</a><a class="headerlink" href="#option-vbasupport-statement" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Option</span> <span class="pre">VBASupport</span></code> 文は LibreOffice Basic が一部の VBA 文、関数、オブジェクトを対応することを指定する。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>VBA に対する支援は完全ではないが、一般的な使用例の大部分に及ぶ。</p>
</div>
<p>VBASupport が有効である場合、LibreOffice Basic 関数の引数および戻り値は VBA 関数の引数および戻り値と同じになる。無効になっている場合、LibreOffice Basic 関数は
VBA 関数とは異なる引数や戻り値を受け取ることがある。</p>
</section>
<section id="vba-userforms-libreoffice-basic-dialogs">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">VBA UserForms (LibreOffice Basic Dialogs)</a><a class="headerlink" href="#vba-userforms-libreoffice-basic-dialogs" title="Link to this heading">¶</a></h3>
<p>フォーム（ダイアログボックス）は VBA オプションでは自動的に変換処理されない。本書のコードのように手動で直せ。</p>
</section>
</section>
<section id="conclusion">
<h2><a class="toc-backref" href="#id29" role="doc-backlink">Conclusion</a><a class="headerlink" href="#conclusion" title="Link to this heading">¶</a></h2>
<p>本章に登場した各話題は本来は一章を割り当てるような大きいものだ。</p>
<p><a class="reference external" href="https://extensions.libreoffice.org/">LibreOffice 拡張機能のウェブサイト</a> には LibreOffice Basic クイックレファレンスカード集がある。</p>
<hr class="docutils" />
<p class="rubric">章末注</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="calc13-footnote-1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">1</a><span class="fn-bracket">]</span></span>
<p>Basic IDE で確認すると、すべてコメントアウトされていることがわかる。</p>
</aside>
</aside>
</section>
</section>


          </div>
    <div class="related bottom">
      &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="calc12.html" title="Previous">Calc Guide Chapter 12, Sharing and Reviewing Spreadsheets ノート</a>
        </li>
      
        <li>
          &uarr;
          <a href="index.html" title="Parent">LibreOffice Calc Guide 読書ノート</a>
        </li>
        <li>
          <a href="calc14.html" title="Next">Chapter 14, Calc as a Database ノート</a>
          &rarr;
        </li>
    </ul>
  </nav>
    </div>

      </div>
      <div class="clearer"></div>
    </div>
<div class="footer">
  <ul>
    <li id="footer_logo">
      <a class="image-reference" href="../../index.html" title="読書ノート Home"><img src="../../_images/logo.svg"/></a>
    </li>
    <li id="footer_copyright">
      Copyright &copy; 1999-2024, プレハブ小屋 All rights reserved.
    </li>
  </ul>
</div>
  </body>
</html>