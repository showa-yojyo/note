
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>What’s New In Bash 4 ノート &#8212; 読書ノート v1.5dev</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/prefab.css" />
    
    <script src="_static/mathjax-v3.js"></script>
    <script src="_static/mermaid.js"></script>
    
    <link rel="next" title="What’s New In C++11 ノート" href="cpp11/index.html" />
    <link rel="prev" title="What’s New In Bash 3 ノート" href="bash-v3.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="cpp11/index.html" title="What’s New In C++11 ノート"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="bash-v3.html" title="What’s New In Bash 3 ノート"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">読書ノート</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">What’s New In Bash 4 ノート</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="what-s-new-in-bash-4">
<h1><a class="toc-backref" href="#id6">What’s New In Bash 4 ノート</a><a class="headerlink" href="#what-s-new-in-bash-4" title="Permalink to this heading">¶</a></h1>
<p>Bash バージョン 4.x で追加された新機能のメモ。</p>
<div class="contents topic" id="id1">
<p class="topic-title">ノート目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#what-s-new-in-bash-4" id="id6">What’s New In Bash 4 ノート</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id7">バージョン 4.0</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id8">バージョン 4.1</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id9">バージョン 4.2</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id10">参考資料</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="id2">
<h2><a class="toc-backref" href="#id7">バージョン 4.0</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<ul>
<li><p>連想配列</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">declare</span> <span class="pre">-A</span> <span class="pre">array</span></code> の宣言が必要となる。いきなり連想配列の構築をしてもおかしなことになる。</p></li>
<li><p>キーも値も同時に定義することになる。</p></li>
<li><p>ここで <a class="reference internal" href="bash-v3.html"><span class="doc">What’s New In Bash 3 ノート</span></a> の配列の添字を展開する演算子 <code class="docutils literal notranslate"><span class="pre">${!array[&#64;]}</span></code> が有用になる。</p></li>
<li><p>キーは空白文字を含むことができるが、空白文字しか含まないものは認められない。</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">case</span></code> 文の構文が拡張。<code class="docutils literal notranslate"><span class="pre">;;&amp;</span></code> および <code class="docutils literal notranslate"><span class="pre">;&amp;</span></code> で終了することもできる。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">;;&amp;</span></code> は次の行のあるテストに進むことを意味する。つまり C/C++ の
<code class="docutils literal notranslate"><span class="pre">switch</span></code> 文でいう <code class="docutils literal notranslate"><span class="pre">break</span></code> をしない。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">;&amp;</span></code> は次の行にあるテストを無視して、そこにある式を実行する。</p></li>
<li><p>複雑な <code class="docutils literal notranslate"><span class="pre">if</span></code> 文の代わりに採用される機能とのことだ。</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">coproc</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>coproc <span class="o">[</span>coprocess_name<span class="o">]</span> <span class="o">{</span> statement* <span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>《There is a new ‘coproc’ reserved word that specifies a
coprocess: an asynchronous command run with two pipes connected to
the creating shell. Coprocs can be named. The input and output
file descriptors and the PID of the coprocess are available to the
calling shell in variables with coproc-specific names》(Chet
Ramey, <em>Bash FAQ</em>).
よそのプログラミング言語でいうコルーチンに相当するものだろう。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">coproc</span></code> で定義したブロックを coprocess と呼ぶ。これは非同期実行される。</p>
<ul>
<li><p>最初の例ではメイン処理から <code class="docutils literal notranslate"><span class="pre">read</span> <span class="pre">-u</span> <span class="pre">${COPROC[0]}</span> <span class="pre">line</span></code>
で名前なし coprocess から入力を読み取り変数 <code class="docutils literal notranslate"><span class="pre">line</span></code>
に代入する。つまり <code class="docutils literal notranslate"><span class="pre">{COPROC[0]}</span></code> は 0 番目の coprocess の file
descriptor を意味する。</p></li>
<li><p>coprocess はサブシェルなので PID を有する。</p></li>
<li><p>スクリプト末端の <code class="docutils literal notranslate"><span class="pre">kill</span> <span class="pre">$COPROC_PID</span></code> が機能しない。</p></li>
<li><p>次の例では coprocess
とメイン部分とで変数のスコープが異なることが納得できる。</p></li>
<li><p>最後の例では名前付き coprocess を使っている。その名前でその file
descriptor を得られる。</p></li>
<li><p>非同期に実行されるものなので、別の処理が coprocess
と通信を終了する前に当該 coprocess が停止することがある。困ったことに最後の例の修正案がよく理解できない。</p></li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">mapfile</span></code></p>
<ul class="simple">
<li><p>この組み込みコマンドはループやコマンド置換を用いずにテキストファイルの内容を配列にロードすることができる。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mapfile</span> <span class="pre">array</span> <span class="pre">&lt;</span> <span class="pre">filename</span></code> のように記述する。ファイル
<code class="docutils literal notranslate"><span class="pre">filename</span></code> の内容の各行が配列要素となる。</p></li>
<li><p>解説と異なり、<code class="docutils literal notranslate"><span class="pre">array=(</span> <span class="pre">$(cat</span> <span class="pre">filename)</span> <span class="pre">)</span></code> との違いがある。各単語が配列要素となる。</p></li>
<li><p>そして <code class="docutils literal notranslate"><span class="pre">read</span> <span class="pre">-a</span> <span class="pre">array</span> <span class="pre">&lt;</span> <span class="pre">filename</span></code> とも異なる。こちらは最初の一行だけを単語ごとに配列要素に代入する。</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">read</span></code></p>
<ul class="simple">
<li><p>オプション <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">timeout</span></code> は小数値を受け入れる。</p></li>
<li><p>オプション <code class="docutils literal notranslate"><span class="pre">-i</span> <span class="pre">text</span></code> は編集バッファーのプリロードを許容する。つまり、読み取る値の既定値を <code class="docutils literal notranslate"><span class="pre">text</span></code> とすると言っている。</p></li>
<li><p>ただしこれらのオプションはまだ使いやすくはない。</p></li>
</ul>
</li>
<li><p>パラメーター置換に大文字小文字変換が実装された。変数 <code class="docutils literal notranslate"><span class="pre">var</span></code>
を英単語が値であるものとすると、</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">${var^}</span></code>: 先頭の一文字を大文字に置換する。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">${var^^}</span></code>: すべての文字を大文字に置換する。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">${var,}</span></code>: 先頭の一文字を小文字に置換する。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">${var,,}</span></code>: すべての文字を小文字に置換する。</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">declare</span></code></p>
<ul class="simple">
<li><p>オプション <code class="docutils literal notranslate"><span class="pre">-l</span></code> は変数を小文字からなる単語であることを保証する。</p></li>
<li><p>オプション <code class="docutils literal notranslate"><span class="pre">-c</span></code> は変数を capitalize されている単語であることを保証する。</p></li>
</ul>
</li>
<li><p>中括弧展開演算子がさらに発展</p>
<ul class="simple">
<li><p>ステップ値の指定ができるようになった。例えば <code class="docutils literal notranslate"><span class="pre">{40..60..2}</span></code>,
<code class="docutils literal notranslate"><span class="pre">{60..40..2}</span></code> のようにする。このようにステップ値の符号は省略できる。</p></li>
<li><p>やる人はいないと思うが <code class="docutils literal notranslate"><span class="pre">{X..d..2}</span></code> なども許される。</p></li>
<li><p>ゼロ詰め。<code class="docutils literal notranslate"><span class="pre">{010..15}</span></code> とすると <code class="docutils literal notranslate"><span class="pre">010</span> <span class="pre">011</span> <span class="pre">012</span> <span class="pre">013</span> <span class="pre">014</span> <span class="pre">015</span></code> に展開される。</p></li>
</ul>
</li>
<li><p>位置パラメーターのスライスのインデックスが 0 始まりに変更。</p></li>
<li><p>ワイルドカード <code class="docutils literal notranslate"><span class="pre">**</span></code> 追加。再帰的にマッチする。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shopt</span> <span class="pre">-s</span> <span class="pre">globstar</span></code> が必要。</p></li>
</ul>
</li>
<li><p>内部変数 <code class="docutils literal notranslate"><span class="pre">BASHPID</span></code> 追加。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">command_not_found_handle</span></code></p>
<ul class="simple">
<li><p>存在しないコマンドを実行するとこの名前の関数が呼び出される。ユーザーがこの関数を定義することができると解釈してもよい。</p></li>
</ul>
</li>
</ul>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id8">バージョン 4.1</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h2>
<p>Bash 4.1 は主にバグ修正バージョンだった。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">printf</span> <span class="pre">-v</span></code> が配列のインデックスをセットするのを受け付けるようになった。</p>
<ul>
<li><p>これは意味がわからない。</p></li>
</ul>
</li>
<li><p>二重角括弧の内部で、比較演算子 <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> がロケールを適格とするようになった。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read</span> <span class="pre">-N</span></code> で読み取る文字数を指定できるようになった。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$()</span></code> によるコマンド置換の中に here document 構造が単一の <code class="docutils literal notranslate"><span class="pre">)</span></code> で終わっても構わない。</p></li>
</ul>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id9">バージョン 4.2</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h2>
<p>Bash 4.2 はバグ修正に加えて、新機能と改良の追加があった。</p>
<ul>
<li><p>Unicode エスケープを <code class="docutils literal notranslate"><span class="pre">\u</span></code> や <code class="docutils literal notranslate"><span class="pre">\U</span></code> で表せる。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ echo -e &#39;\u2622&#39;</span>
<span class="go">☢</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">shopt</span> <span class="pre">-s</span> <span class="pre">lastpipe</span></code> により、パイプの最後のコマンドがサブシェルで走らない。</p></li>
<li><p>負の配列インデックスが使えるようになった。モダンなプログラミング言語でのそれと同じ。例えば <code class="docutils literal notranslate"><span class="pre">$array[-1]</span></code> は <code class="docutils literal notranslate"><span class="pre">${array[${#array[*]}-1]}</span></code> を意味する。</p></li>
<li><p>部分文字列のスライスでも同様に負のインデックスが使えるようになった。
<code class="docutils literal notranslate"><span class="pre">${string:position:length}</span></code> における <code class="docutils literal notranslate"><span class="pre">length</span></code> が負で構わない。</p></li>
</ul>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id10">参考資料</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://tldp.org/LDP/abs/html/">Advanced Bash-Scripting Guide</a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="cpp11/index.html" title="What’s New In C++11 ノート"
             >next</a></li>
        <li class="right" >
          <a href="bash-v3.html" title="What’s New In Bash 3 ノート"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">読書ノート</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">What’s New In Bash 4 ノート</a></li> 
      </ul>
    </div>
    <div id="footer">
      <div id="footer_logo">
        <a class="imga" href="https://showa-yojyo.github.io/" title="プレハブ小屋 Since 1999"><img src="_static/logos.png" width="88" height="31" /></a>
      </div>
      <div id="footer_copyright">
        Since 1999<br />
        Copyright &copy; 1999-2022, プレハブ小屋 All rights reserved.
      </div>
    </div>
  </body>
</html>