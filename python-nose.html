<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Nose 利用ノート &#8212; 読書ノート 1.6dev documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=1a9a5cd9" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=5a6f99c4"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/mermaid.js?v=578dbed1"></script>
    <link rel="next" title="IPython 利用ノート" href="python-ipython.html" />
    <link rel="prev" title="Restview 利用ノート" href="python-restview.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
    <div class="related top">
      &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="python-restview.html" title="Previous">Restview 利用ノート</a>
        </li>
      
        <li>
          <a href="python-ipython.html" title="Next">IPython 利用ノート</a>
          &rarr;
        </li>
    </ul>
  </nav>
    </div>


          <div class="body" role="main">
            
  <section id="nose">
<h1><a class="toc-backref" href="#id13" role="doc-backlink">Nose 利用ノート</a><a class="headerlink" href="#nose" title="Permalink to this heading">¶</a></h1>
<nav class="contents" id="id1">
<p class="topic-title">ノート目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#nose" id="id13">Nose 利用ノート</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id14">関連リンク</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id15">目的</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id16">インストール</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id17">利用方法</a></p>
<ul>
<li><p><a class="reference internal" href="#nosetests" id="id18"><strong class="program">nosetests</strong></a></p>
<ul>
<li><p><a class="reference internal" href="#collect-only" id="id19"><code class="docutils literal notranslate"><span class="pre">collect-only</span></code> オプション – テスト名だけを調べる</a></p></li>
<li><p><a class="reference internal" href="#attr" id="id20"><code class="docutils literal notranslate"><span class="pre">attr</span></code> オプション – 属性を指定することで起動するテストを選択する</a></p></li>
<li><p><a class="reference internal" href="#pdb-failures" id="id21"><code class="docutils literal notranslate"><span class="pre">pdb-failures</span></code> オプション – テスト失敗時にデバッガーを起動</a></p></li>
<li><p><a class="reference internal" href="#with-coverage" id="id22"><code class="docutils literal notranslate"><span class="pre">with-coverage</span></code> オプション – コードカバレッジ</a></p></li>
<li><p><a class="reference internal" href="#with-profile" id="id23"><code class="docutils literal notranslate"><span class="pre">with-profile</span></code> オプション – プロファイリング</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id24">オプションメモ</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id25">ライブラリー</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id26">テストの書き方</a></p></li>
<li><p><a class="reference internal" href="#nose-tools" id="id27">nose.tools</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id28">テストの発見および起動法則</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id10" id="id29">プラグイン</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id11" id="id30">雑多なメモ</a></p></li>
</ul>
</li>
</ul>
</nav>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>本稿を読む前に <a class="reference external" href="https://www.python.org/">Python</a> 本体の <code class="docutils literal notranslate"><span class="pre">unittest</span></code> を理解しておくべし。</p></li>
<li><p>本稿において、利用した各パッケージのバージョンは次のとおり。</p>
<ul>
<li><p><a class="reference external" href="https://www.python.org/">Python</a> 2.6.6, 2.7.3, 3.4.1, 3.5.0, 3.5.2</p></li>
<li><p><a class="reference external" href="https://nose.readthedocs.io/en/latest/">Nose</a> 1.0.0, 1.1.2, 1.3.3, 1.3.7</p></li>
</ul>
</li>
<li><p>当ノートでは <code class="docutils literal notranslate"><span class="pre">--verbosity</span></code> オプションを多用しているが、単にノートを見返すときのわかりやすさを優先するためだけによる。実用時には省略することのほうが普通。</p></li>
</ul>
</div>
<section id="id2">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">関連リンク</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><a class="reference external" href="https://nose.readthedocs.io/en/latest/">Nose</a></dt><dd><p>パッケージ配布元。</p>
</dd>
</dl>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">目的</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://nose.readthedocs.io/en/latest/">Nose</a> 自身は、その目的をドキュメントの冒頭に &lt;nose is nicer testing for python&gt;
や &lt;nose extends unittest to make testing easier&gt; と謳っている。さらに、プログラムの狙いを次の 4 点に絞っている。</p>
<ol class="arabic simple">
<li><p>テストコードを書くのを簡単に。</p></li>
<li><p>テストを走らせるのを簡単に。</p></li>
<li><p>テスト環境の構築を簡単に。</p></li>
<li><p>やりたいことをやることを簡単に。</p></li>
</ol>
<p>そして私が <a class="reference external" href="https://nose.readthedocs.io/en/latest/">Nose</a> を利用する目的は何かというと、主に「走らせるのを簡単に」ではないかと思う。 Python 標準の <code class="docutils literal notranslate"><span class="pre">unittest</span></code> だけで単体テストをやろうとすると、
TestSuite を集めて TestRunner に渡すコードを書くという、これまでよくやってきた作業パターンが億劫に感じられるはずだ。</p>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">インストール</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h2>
<p>方法については <a class="reference internal" href="python-miniconda.html#python-pkg-proc"><span class="std std-ref">一般のサードパーティー製 Python パッケージのインストール手順</span></a> で図示したので、そちらを参照して欲しい。インストールが成功終了後は、Python 環境は次のように変化している。</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">Lib/site-packages/nose</span></code> フォルダーが存在する。当然その中には py モジュールが含まれている。</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">Scripts</span></code> フォルダーに実行ファイル <code class="file docutils literal notranslate"><span class="pre">nosetests</span></code> が存在する。特に
Windows の場合、これは exe ファイルである。</p></li>
</ul>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">利用方法</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<p><strong class="program">nosetests</strong> と Nose ライブラリー本体の利用方法に分けて理解する。</p>
<section id="nosetests">
<h3><a class="toc-backref" href="#id18" role="doc-backlink"><strong class="program">nosetests</strong></a><a class="headerlink" href="#nosetests" title="Permalink to this heading">¶</a></h3>
<p>Nose をインストールすると、Python パッケージだけでなく、<strong class="program">nosetests</strong> というスクリプトか実行ファイルが <code class="file docutils literal notranslate"><span class="pre">Scripts</span></code> フォルダーにインストールされる。</p>
<ul>
<li><p>これは py ファイルからテストを自動的に発見し、実行することができる便利なツールだ。</p></li>
<li><p>引数なしで起動すると、おそらくカレントディレクトリーにあるすべての py ファイルから、すべてのテストを発見し、片っ端から実行するというはたらきをするのではないだろうか。</p></li>
<li><p>普通は <strong class="program">nosetests</strong> にコマンドライン引数を指定して利用する。次のコマンドライン例は Nose のドキュメントから引用したものだ。モジュール名を指定したり、さらにテスト名を指定したり、あるいはモジュールフルパスプラステスト名という指定の仕方がサポートされているようだ。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ nosetests test.module</span>
<span class="go">bash$ nosetests another.test:TestCase.test_method</span>
<span class="go">bash$ nosetests a.test:TestCase</span>
<span class="go">bash$ nosetests /path/to/test/file.py:test_function</span>
</pre></div>
</div>
</li>
<li><p>ディレクトリーごと指示するやり方もある。その場合、複数パス指定が許される。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ nosetests /path/to/tests /another/path/to/tests</span>
</pre></div>
</div>
<p>なので、実は <code class="docutils literal notranslate"><span class="pre">-w</span></code>, <code class="docutils literal notranslate"><span class="pre">--where</span></code> オプションは無用の長物。</p>
</li>
<li><p><strong class="program">nosetests</strong> は豊富なコマンドラインオプションを提供している。</p></li>
<li><p>コマンドラインオプションと同等の設定を設定ファイルからも行える。</p>
<ul>
<li><p>デフォルトの設定ファイルは <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> にある <code class="file docutils literal notranslate"><span class="pre">.noserc</span></code> または
<code class="file docutils literal notranslate"><span class="pre">nose.cfg</span></code> だ。</p></li>
<li><p>任意の設定ファイルパスをコマンドラインから <code class="docutils literal notranslate"><span class="pre">--config</span></code> オプションを利用することで指定できる。</p></li>
<li><p>設定ファイルの書き方で注意が要るのは、設定項目を <code class="docutils literal notranslate"><span class="pre">[nosetests]</span></code> セクションに書かねばならないことだ。</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[nosetests]</span>
<span class="na">verbosity</span><span class="o">=</span><span class="s">2</span>
<span class="na">with-doctest</span><span class="o">=</span><span class="s">true</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>テスト結果の出力書式は、標準の <code class="docutils literal notranslate"><span class="pre">unittest</span></code> のそれと基本的には同一。</p></li>
</ul>
<p>次に、使えそうなオプションを調べてみよう。</p>
<section id="collect-only">
<h4><a class="toc-backref" href="#id19" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">collect-only</span></code> オプション – テスト名だけを調べる</a><a class="headerlink" href="#collect-only" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">--collect-only</span></code> オプションでテストを実行せずにテスト名だけを確認できる。</p>
<ul class="simple">
<li><p>さらに <code class="docutils literal notranslate"><span class="pre">--with-id</span></code> を併用し、テストのインデックスリストも得られる。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--verbosity</span></code> オプションを併用して、テスト名等を明示させるのがコツ。</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ nosetests --collect-only --with-id --verbosity=2</span>
<span class="gp">#</span><span class="m">1</span><span class="w"> </span>A<span class="w"> </span>regular<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="k">case</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">2</span><span class="w"> </span>A<span class="w"> </span>very<span class="w"> </span>slow<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="k">case</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">3</span><span class="w"> </span>A<span class="w"> </span><span class="nb">test</span><span class="w"> </span>with<span class="w"> </span>attribute<span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">4</span><span class="w"> </span>A<span class="w"> </span><span class="nb">test</span><span class="w"> </span>with<span class="w"> </span>attribute<span class="w"> </span>specific<span class="w"> </span>value<span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">5</span><span class="w"> </span>testattr.test_tags<span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">6</span><span class="w"> </span>testattr2.test_load_all_images<span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">7</span><span class="w"> </span>testattr2.test_download_hardcore_images<span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">8</span><span class="w"> </span>testeven.test_evens<span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">8</span><span class="w"> </span>testeven.test_evens<span class="o">(</span><span class="m">1</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="go">   testeven.test_evens(2, 6) ... ok</span>
<span class="go">   testeven.test_evens(3, 9) ... ok</span>
<span class="go">   testeven.test_evens(4, 12) ... ok</span>
<span class="gp">#</span><span class="m">9</span><span class="w"> </span>test_choice<span class="w"> </span><span class="o">(</span>testrandom.TestSequenceFunctions<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">10</span><span class="w"> </span>test_sample<span class="w"> </span><span class="o">(</span>testrandom.TestSequenceFunctions<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">11</span><span class="w"> </span>test_shuffle<span class="w"> </span><span class="o">(</span>testrandom.TestSequenceFunctions<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">12</span><span class="w"> </span>test_default_size<span class="w"> </span><span class="o">(</span>testwidget.WidgetTestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">13</span><span class="w"> </span>test_resize<span class="w"> </span><span class="o">(</span>testwidget.WidgetTestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok

<span class="go">----------------------------------------------------------------------</span>
<span class="go">Ran 17 tests in 0.101s</span>

<span class="go">OK</span>
</pre></div>
</div>
</section>
<section id="attr">
<h4><a class="toc-backref" href="#id20" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">attr</span></code> オプション – 属性を指定することで起動するテストを選択する</a><a class="headerlink" href="#attr" title="Permalink to this heading">¶</a></h4>
<p>テストケースをいっぱい書いたはいいが、「今はこのテストだけをやりたいンだ」「このテストは通常はやりたくないンだ」という状況に陥りがち。そんなときには <code class="docutils literal notranslate"><span class="pre">--attr</span></code>,
<code class="docutils literal notranslate"><span class="pre">--eval-attr</span></code> オプションの仕組みをうまくテストコードに組み込む。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot; testattr2.py: Demonstrate Nose.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">nose.plugins.attrib</span> <span class="kn">import</span> <span class="n">attr</span>

<span class="nd">@attr</span><span class="p">(</span><span class="n">speed</span><span class="o">=</span><span class="s1">&#39;slow&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_load_all_images</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A test cast that takes several minutes.&quot;&quot;&quot;</span>
    <span class="c1"># ...</span>
    <span class="k">pass</span>

<span class="nd">@attr</span><span class="p">(</span><span class="n">online</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_download_hardcore_images</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A test that makes sense only with network access.&quot;&quot;&quot;</span>
    <span class="c1"># ...</span>
    <span class="k">pass</span>

<span class="c1"># Other test cases...</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ nosetests -a &#39;!online&#39; testattr2.py</span>
<span class="go">bash$ nosetests -A &quot;speed != slow&quot; testattr2.py</span>
</pre></div>
</div>
<ul class="simple">
<li><p>上のコマンドラインの実行では <code class="docutils literal notranslate"><span class="pre">test_download_hardcore_images</span></code> は実行されない。</p></li>
<li><p>下のコマンドラインの実行では <code class="docutils literal notranslate"><span class="pre">test_load_all_images</span></code> は実行されない。</p></li>
</ul>
</section>
<section id="pdb-failures">
<h4><a class="toc-backref" href="#id21" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">pdb-failures</span></code> オプション – テスト失敗時にデバッガーを起動</a><a class="headerlink" href="#pdb-failures" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">--pdb-failures</span></code> オプションを指定しておくと、テストが FAILURE になった地点で
Python の <strong class="program">pdb</strong> デバッガが起動する。</p>
<ul class="simple">
<li><p>通常使いたいのは <code class="docutils literal notranslate"><span class="pre">--pdb</span></code> ではなく <code class="docutils literal notranslate"><span class="pre">--pdb-faillures</span></code> のほうだと思う。</p></li>
<li><p><strong class="program">pdb</strong> はコンソールベースのデバッガ。正直なところ不慣れなツールだが、この際慣れておく。</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ nosetests --pdb-failures testeven.py</span>
<span class="go">.&gt; d:\home\yojyo\devel\all-note\notebook\source\_sample\nose\testeven.py(13)check_even()</span>
<span class="go">-&gt; assert val1 % 2 == 0 or val2 % 2 == 0</span>
<span class="gp gp-VirtualEnv">(Pdb)</span> <span class="go">l</span>
<span class="go">  8         for i in range(0, 5):</span>
<span class="go">  9             yield check_even, i, i * 3</span>
<span class="go"> 10</span>
<span class="go"> 11     def check_even(val1, val2):</span>
<span class="go"> 12         &quot;&quot;&quot;Determine if either of numbers is even.&quot;&quot;&quot;</span>
<span class="go"> 13  -&gt;     assert val1 % 2 == 0 or val2 % 2 == 0</span>
<span class="go">[EOF]</span>
<span class="gp gp-VirtualEnv">(Pdb)</span> <span class="go">p val1, val1 % 2, val2 % 2</span>
<span class="gp gp-VirtualEnv">(1, 1, 1)</span>
<span class="gp gp-VirtualEnv">(Pdb)</span>
</pre></div>
</div>
<p>エラーの発生とは関係なく、特定の箇所でステップ実行を有効にする方法もある。まずはステップ実行したいコードを含むモジュールで
<code class="code docutils literal notranslate"><span class="pre">from</span> <span class="pre">nose.tools</span> <span class="pre">import</span> <span class="pre">set_trace</span></code> をする。それから対象コードの直前で
<code class="code docutils literal notranslate"><span class="pre">set_trace()</span></code> すればよい。</p>
</section>
<section id="with-coverage">
<h4><a class="toc-backref" href="#id22" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">with-coverage</span></code> オプション – コードカバレッジ</a><a class="headerlink" href="#with-coverage" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">--with-coverage</span></code> オプションでテスト結果と共にコードカバレッジを測定できる。いつものテスト結果を出力した直後に、カバレッジを出力する。</p>
<p>チューニングの材料になるわけで、いずれ大掛かりなライブラリーを開発するつもりならば、この機能は覚えていて損はない。</p>
<p>この機能を利用するには、別途 <a class="reference external" href="http://nedbatchelder.com/code/coverage">coverage</a> という別のパッケージが必要だ。インストールは難しくないので、Nose 環境の一部とみなして導入しておくとよさそうだ。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ nosetests --with-coverage -v testrandom.py</span>
<span class="go">test_choice (testrandom.TestSequenceFunctions) ... ok</span>
<span class="go">test_sample (testrandom.TestSequenceFunctions) ... ok</span>
<span class="go">test_shuffle (testrandom.TestSequenceFunctions) ... ok</span>

<span class="go">Name         Stmts   Miss  Cover   Missing</span>
<span class="go">------------------------------------------</span>
<span class="go">... この行にファイルパスの情報が入るが省略 ...</span>
<span class="go">testrandom      21      3    86%   25, 30-31</span>
<span class="go">----------------------------------------------------------------------</span>
<span class="go">Ran 3 tests in 0.010s</span>

<span class="go">OK</span>
</pre></div>
</div>
</section>
<section id="with-profile">
<h4><a class="toc-backref" href="#id23" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">with-profile</span></code> オプション – プロファイリング</a><a class="headerlink" href="#with-profile" title="Permalink to this heading">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>筆者環境では Nose 1.3.3 でこの機能が利用できなくなっている。</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">--with-profile</span></code> オプションでテストに関係した全関数に対する呼び出しの回数や時間の統計を取れる。いつものテスト結果を出力した直後に、プロファイル結果を出力する。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">         4101 function calls (4084 primitive calls) in 0.201 CPU seconds</span>

<span class="go">   Ordered by: cumulative time</span>

<span class="go">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span>
<span class="go">      7/1    0.000    0.000    0.201    0.201 d:\python26\lib\site-packages\nose\suite.py:175(__call__)</span>
<span class="go">      7/1    0.002    0.000    0.201    0.201 d:\python26\lib\site-packages\nose\suite.py:196(run)</span>
<span class="go">        1    0.000    0.000    0.200    0.200 d:\python26\lib\unittest.py:463(__call__)</span>
<span class="go">        1    0.000    0.000    0.200    0.200 d:\python26\lib\site-packages\nose\suite.py:70(run)</span>
<span class="go">       25    0.000    0.000    0.121    0.005 d:\python26\lib\site-packages\nose\suite.py:92(_get_tests)</span>
<span class="go">...</span>
</pre></div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--profile-sort=SORT</span></code> オプションで、ソート順を何にするかを指定できる。オプション自体を指定しない場合は <code class="docutils literal notranslate"><span class="pre">cumulative</span></code> がデフォルト扱いとなる。</p>
<p>なお <code class="docutils literal notranslate"><span class="pre">SORT</span></code> に指定する値は Python Standard Library の <code class="docutils literal notranslate"><span class="pre">Stats.sort_stats</span></code>
の引数と同じ。</p>
</li>
</ul>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id24" role="doc-backlink">オプションメモ</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-h</span></code> または <code class="docutils literal notranslate"><span class="pre">--help</span></code> でヘルプ表示。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-V</span></code> または <code class="docutils literal notranslate"><span class="pre">--version</span></code> で <code class="file docutils literal notranslate"><span class="pre">nosetests</span></code> のバージョンを表示。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-v</span></code> または <code class="docutils literal notranslate"><span class="pre">--verbosity</span></code> で表示を少々やかましくできる。テスト名確認時にはこれを併用するだろう。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">REGEX</span></code> 系オプションで「テストとみなしたいファイル・ディレクトリー・関数・クラス名にマッチする」正規表現を指定できる。</p>
<p>デフォルトで <code class="regexp docutils literal notranslate"><span class="pre">(?:^|[\b_\.\-])[Tt]est</span></code> になっていることを押させておけばよい。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">-p</span></code> または <code class="docutils literal notranslate"><span class="pre">--plugins</span></code> オプションで、有効なプラグインの一覧を表示。ただし出力順が何で決まるのかわからないので、適当に <strong class="program">grep</strong> や
<strong class="program">sort</strong> にパイプして見やすくするべし。</p></li>
</ul>
</section>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">ライブラリー</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h3>
<section id="id8">
<h4><a class="toc-backref" href="#id26" role="doc-backlink">テストの書き方</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p>テストは <code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> のサブクラスの形で用意しなくてもよい。</p></li>
<li><p>ただし <code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> のサブクラスからはテストを無条件にロードする。</p></li>
<li><p>テスト関数はモジュールの先頭から出現順に走らせる。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TestCase</span></code> サブクラスまたはその他のテストクラスは、名前のアルファベット順に走らせる。</p></li>
<li><p>Fixture について</p>
<ul class="simple">
<li><p>どうやら setup/teardown ペアのことを test fixture と呼ぶらしい。</p></li>
<li><p>Nose はパッケージレベル、モジュールレベル、クラスレベル、関数レベルで
fixture をサポートしている。言い換えれば、これらの各レベルでテストの概念がある。</p></li>
</ul>
</li>
<li><p>テストパッケージ</p>
<ul class="simple">
<li><p>Nose はテストをパッケージの形に編成することを認めている。</p></li>
<li><p>パッケージレベルでの setup/teardown の概念が存在する。それらはいずれも
<code class="file docutils literal notranslate"><span class="pre">__init__.py</span></code> で関数の形で用意しておくと、 Nose がそれを適切なタイミングで拾ってくれる。</p>
<ul>
<li><p>setup 関数の名前は次のいずれかとなる：
<code class="docutils literal notranslate"><span class="pre">setup</span></code>, <code class="docutils literal notranslate"><span class="pre">setup_package</span></code>, <code class="docutils literal notranslate"><span class="pre">setUp</span></code>, <code class="docutils literal notranslate"><span class="pre">setUpPackage</span></code></p></li>
<li><p>teardown 関数の名前は次のいずれかとなる：
<code class="docutils literal notranslate"><span class="pre">teardown</span></code>, <code class="docutils literal notranslate"><span class="pre">teardown_package</span></code>, <code class="docutils literal notranslate"><span class="pre">tearDown</span></code>, <code class="docutils literal notranslate"><span class="pre">tearDownPackage</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>テストモジュール</p>
<ul class="simple">
<li><p>モジュール名がテストっぽいものはテストモジュールである。</p></li>
<li><p>モジュールレベルでの setup/teardown の概念が存在する。それ用の関数名も上述のパッケージのそれから類推できる名前になっている。</p></li>
<li><p>モジュールのテストが起動するタイミングは、Nose がすべてのテストを集めた後になる。</p></li>
</ul>
</li>
<li><p>テストクラス</p>
<ul>
<li><p>テストモジュール内に定義されている、次のいずれかの条件を満たすクラスである：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> のサブクラスすべて - (A)</p></li>
<li><p>Nose の <code class="docutils literal notranslate"><span class="pre">testMatch</span></code> にマッチする名前を持つクラスすべて - (B)</p></li>
</ul>
</li>
<li><p>(B) タイプのクラスでも <code class="docutils literal notranslate"><span class="pre">setUp</span></code> と <code class="docutils literal notranslate"><span class="pre">tearDown</span></code> を定義することができ、
Nose はそれらを (A) タイプのそれのように呼び出すことになる。</p></li>
<li><ol class="upperalpha simple" start="2">
<li><p>タイプは (A) タイプよりも以下の点で優遇される：</p></li>
</ol>
<ul class="simple">
<li><p>ジェネレーターメソッドを持つことができる。</p></li>
<li><p>クラスレベルの setup/teardown を定義することができる。いずれもクラスメソッドである必要がある。</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">setup_class</span></code>, <code class="docutils literal notranslate"><span class="pre">setupClass</span></code>, <code class="docutils literal notranslate"><span class="pre">setUpClass</span></code>, <code class="docutils literal notranslate"><span class="pre">setupAll</span></code>, <code class="docutils literal notranslate"><span class="pre">setUpAll</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">teardown_class</span></code>, <code class="docutils literal notranslate"><span class="pre">teardownClass</span></code>, <code class="docutils literal notranslate"><span class="pre">tearDownClass</span></code>,
<code class="docutils literal notranslate"><span class="pre">teardownAll</span></code>, <code class="docutils literal notranslate"><span class="pre">tearDownAll</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>テスト関数</p>
<ul class="simple">
<li><p>テストモジュール内に定義されている、Nose の <code class="docutils literal notranslate"><span class="pre">testMatch</span></code> にマッチする名前を持つ関数がテスト関数となる。</p></li>
<li><p>関数にも setup/teardown を適用することができる。自分で定義した関数をデコレーター <code class="docutils literal notranslate"><span class="pre">with_setup</span></code> を利用して取り付ける。これがたいへん便利だ。</p></li>
</ul>
</li>
<li><p>そして Nose を利用するとジェネレーターをもテストできる。自分ではよく使わないので今のところはパス。</p></li>
</ul>
</section>
<section id="nose-tools">
<h4><a class="toc-backref" href="#id27" role="doc-backlink">nose.tools</a><a class="headerlink" href="#nose-tools" title="Permalink to this heading">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ちょっと利用方法が理解できないものがあるため、後回し。</p>
</div>
</section>
<section id="id9">
<h4><a class="toc-backref" href="#id28" role="doc-backlink">テストの発見および起動法則</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h4>
<p>さっきも書いたが、それ以外について。</p>
<ul class="simple">
<li><p>Nose はテストに見えないディレクトリーかつパッケージでないものは検査しない。</p></li>
<li><p>Nose はモジュールを import する際に、そのモジュールがあるディレクトリーパスを
<code class="docutils literal notranslate"><span class="pre">sys.path</span></code> 変数に追加してしまう。モジュールが何かパッケージのものである場合、<code class="docutils literal notranslate"><span class="pre">package.module</span></code> として import されることになる。</p></li>
<li><p>もしあるオブジェクトが属性 <code class="docutils literal notranslate"><span class="pre">__test__</span></code> を有し、かつそれが <code class="docutils literal notranslate"><span class="pre">True</span></code> と評価しないようなものならば、そのオブジェクトはテストとして集められないし、さらにそのオブジェクトを含むどんなオブジェクトも集められない。</p></li>
</ul>
</section>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">プラグイン</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>Nose のバージョンが上がってから勉強しに行こう。</p>
</section>
</section>
<section id="id11">
<h2><a class="toc-backref" href="#id30" role="doc-backlink">雑多なメモ</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h2>
<ul>
<li><p>Further Reading より：</p>
<ul>
<li><p>Jason Pellerin という人物が作者のようだ。2005 年からコピーライトが発生している。</p></li>
<li><p>Nose という名前はどうして付いたのか。作者は discover の同義語を類語辞書で調べたようで、短くてマヌケな名前で、なおかつ spy の意味を含まぬものを採用したらしい。</p>
<p>nose は動詞だとクンカクンカするとかいう意味なのでは。</p>
</li>
<li><p>Nose は <a class="reference external" href="http://codespeak.net/py/current/doc/test.html">py.test</a> というテスティングフレームワークにインスパイヤされて作ったとある。以前の py.test はインストールが難しく、unittest ベースでなかったとのこと。</p></li>
<li><p>Nose のライセンスは LGPL とかいうものらしい。バージョン 2 以降ならば、利用者が好きなライセンスを選択してよいとか。</p></li>
</ul>
</li>
<li><p>nosetests の変な使い方。</p>
<ul>
<li><p>他人様の作ったパッケージのテスト構成を探るのに最適なツールかもしれない。例えば <a class="reference external" href="http://jinja.pocoo.org/">Jinja2</a> の <code class="docutils literal notranslate"><span class="pre">testsuite</span></code> フォルダーの各ファイルからテストを全部抽出してリストを作成できたりする。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ cd site-packages/jinja2/</span>
<span class="go">bash$ python34 -c &#39;import jinja2; print(jinja2.__version__)&#39;</span>
<span class="go">2.7.3</span>
<span class="go">bash$ nosetests --collect-only --with-id -v testsuite/*.py</span>
<span class="gp">#</span><span class="m">1</span><span class="w"> </span>Failure:<span class="w"> </span>TypeError<span class="w"> </span><span class="o">(</span>find_all_tests<span class="o">()</span><span class="w"> </span>missing<span class="w"> </span><span class="m">1</span><span class="w"> </span>required<span class="w"> </span>positional<span class="w"> </span>argument:<span class="w"> </span><span class="s1">&#39;suite&#39;</span><span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">2</span><span class="w"> </span>test_autoescape_autoselect<span class="w"> </span><span class="o">(</span>jinja2.testsuite.api.ExtendedAPITestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">3</span><span class="w"> </span>test_cycler<span class="w"> </span><span class="o">(</span>jinja2.testsuite.api.ExtendedAPITestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">4</span><span class="w"> </span>test_expressions<span class="w"> </span><span class="o">(</span>jinja2.testsuite.api.ExtendedAPITestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="gp">#</span><span class="m">5</span><span class="w"> </span>test_finalizer<span class="w"> </span><span class="o">(</span>jinja2.testsuite.api.ExtendedAPITestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok
<span class="go">... 省略 ...</span>
<span class="gp">#</span><span class="m">311</span><span class="w"> </span>test_markup_leaks<span class="w"> </span><span class="o">(</span>jinja2.testsuite.utils.MarkupLeakTestCase<span class="o">)</span><span class="w"> </span>...<span class="w"> </span>ok

<span class="go">----------------------------------------------------------------------</span>
<span class="go">Ran 311 tests in 0.139s</span>

<span class="go">OK</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>最近の Jinja2 のインストールには <code class="docutils literal notranslate"><span class="pre">testsuite</span></code> フォルダーがない。</p>
</div>
</li>
<li><p><a class="reference external" href="https://matplotlib.org/">Matplotlib</a> の <code class="file docutils literal notranslate"><span class="pre">tests</span></code> フォルダーはテストパッケージの構成になっている。
<strong class="program">nosetests</strong> の実験場としては面白い。</p></li>
<li><p><a class="reference external" href="https://www.numpy.org/">NumPy</a> は Nose をうまく使いこなしているようだ。
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy;</span> <span class="pre">help(numpy.test)</span></code> してみよう。テストの単位をわかりやすく分類する努力を払っているのがわかる。</p>
<p>例えば線形代数サブパッケージだけテストしたいのならば、Python インタープリターから次のようにタイプしてみるだけでよい。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">Running unit tests for numpy.linalg</span>
<span class="go">NumPy version 1.11.1</span>
<span class="go">NumPy relaxed strides checking option: False</span>
<span class="go">NumPy is installed in D:\Miniconda3\lib\site-packages\numpy</span>
<span class="go">Python version 3.5.2 |Continuum Analytics, Inc.| (default, Jul  5 2016, 11:41:13) [MSC v.1900 64 bit (AMD64)]</span>
<span class="go">nose version 1.3.7</span>
<span class="go">test_lapack (test_build.TestF77Mismatch) ... SKIP: Skipping test: test_lapack: Skipping fortran compiler mismatch on non Linux platform</span>
<span class="go">Check mode=&#39;full&#39; FutureWarning. ... ok</span>
<span class="go">test_linalg.TestBoolPower.test_square ... ok</span>
<span class="go">test_linalg.TestCond2.test_sq_cases ... ok</span>
<span class="go">test_linalg.TestCond2.test_stacked_arrays_explicitly ... ok</span>
<span class="go">test_linalg.TestCondInf.test ... ok</span>
<span class="go">test_linalg.TestCondSVD.test_sq_cases ... ok</span>
<span class="go">test_linalg.TestCondSVD.test_stacked_arrays_explicitly ... ok</span>
<span class="go">test_linalg.TestDet.test_sq_cases ... ok</span>
<span class="go">... more results ...</span>
<span class="go">test_svd_build (test_regression.TestRegression) ... ok</span>
<span class="go">test_svd_no_uv (test_regression.TestRegression) ... ok</span>

<span class="go">----------------------------------------------------------------------</span>
<span class="go">Ran 134 tests in 17.999s</span>

<span class="go">OK (SKIP=2)</span>
<span class="go">&lt;nose.result.TextTestResult run=134 errors=0 failures=0&gt;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>未調査項目</p>
<ul class="simple">
<li><p>プラグイン周りを調べていない。</p></li>
<li><p>ログ設定周りを調べていない。</p></li>
<li><p>Windows 環境ゆえ、マルチプロセステストが試せないのは残念。</p></li>
</ul>
</li>
</ul>
</section>
</section>


          </div>
    <div class="related bottom">
      &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="python-restview.html" title="Previous">Restview 利用ノート</a>
        </li>
      
        <li>
          <a href="python-ipython.html" title="Next">IPython 利用ノート</a>
          &rarr;
        </li>
    </ul>
  </nav>
    </div>

      </div>
      <div class="clearer"></div>
    </div>
<div class="footer">
  <ul>
    <li id="footer_logo">
      <a class="image-reference" href="index.html" title="読書ノート Home"><img src="_images/logo.svg"/></a>
    </li>
    <li id="footer_copyright">
      Copyright &copy; 1999-2024, プレハブ小屋 All rights reserved.
    </li>
  </ul>
</div>
  </body>
</html>