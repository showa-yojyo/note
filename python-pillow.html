
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Pillow 利用ノート &#8212; 読書ノート v1.5dev</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/prefab.css" />
    
    <script src="_static/mathjax-v3.js"></script>
    <script src="_static/mermaid.js"></script>
    
    <link rel="next" title="Matplotlib 利用ノート" href="python-matplotlib/index.html" />
    <link rel="prev" title="PIL 利用ノート [obsolete]" href="python-pil.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="python-matplotlib/index.html" title="Matplotlib 利用ノート"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="python-pil.html" title="PIL 利用ノート [obsolete]"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">読書ノート</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Pillow 利用ノート</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="pillow">
<h1><a class="toc-backref" href="#id35">Pillow 利用ノート</a><a class="headerlink" href="#pillow" title="Permalink to this heading">¶</a></h1>
<p>Python で画像処理といえば、長い間 <a class="reference external" href="https://www.pythonware.com/products/pil">PIL</a> が活躍していた。だがここ最近は <a class="reference external" href="https://python-pillow.github.io/">Pillow</a> というフォークパッケージが主流になっているらしい。とある別の作図パッケージのアップグレードの際に、それが Pillow に依存していることに気付いて世代交代を知ったのだった。</p>
<p>そこで、本稿では Pillow の導入方法と、既存の PIL 利用コードの移行手順について記す。なお、PyOpenGL や Pygame との連携で PIL を利用していた既存コードのそれについては、各ノートにて言及していく。</p>
<div class="contents topic" id="id1">
<p class="topic-title">ノート目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#pillow" id="id35">Pillow 利用ノート</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id36">関連リンク</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id37">関連ノート</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id38">インストール</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id39">アップグレード</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id40">バージョン確認</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id41">ドキュメント</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id42">画像処理基本</a></p>
<ul>
<li><p><a class="reference internal" href="#id9" id="id43">画像ファイルフォーマット変換（単発）</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id44">画像ファイルフォーマット変換（バッチ処理）</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id45">Pillow がサポートする画像フォーマットを知る</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id46">画像データをバイト配列として扱う</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id47">簡易ビューワー</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id48">ジャギー解消</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id49">イメージモノクロ化</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id50">画像生成</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id17" id="id51">色の表現</a></p>
<ul>
<li><p><a class="reference internal" href="#id18" id="id52">色名による色指定</a></p></li>
<li><p><a class="reference internal" href="#rgb" id="id53">色名から RGB 値に変換する</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id19" id="id54">透過</a></p>
<ul>
<li><p><a class="reference internal" href="#id20" id="id55">透過画像生成</a></p></li>
<li><p><a class="reference internal" href="#png" id="id56">アルファチャンネルを持つ PNG 画像を青地背景上に重ねたい</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id21" id="id57">グラデーション</a></p>
<ul>
<li><p><a class="reference internal" href="#id22" id="id58">線形グラデーション（透過なし）</a></p></li>
<li><p><a class="reference internal" href="#id23" id="id59">線形グラデーション（単色にグレースケール透過）</a></p></li>
<li><p><a class="reference internal" href="#id24" id="id60">線形グラデーション（さらなる応用）</a></p></li>
<li><p><a class="reference internal" href="#id25" id="id61">放射状グラデーション</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id26" id="id62">テキスト</a></p>
<ul>
<li><p><a class="reference internal" href="#hello-world" id="id63">Hello, world</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id64">日本語テキスト</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id28" id="id65">応用</a></p>
<ul>
<li><p><a class="reference internal" href="#id29" id="id66">スクリーンショット</a></p></li>
<li><p><a class="reference internal" href="#id30" id="id67">上下左右ループ壁紙パターン生成</a></p></li>
<li><p><a class="reference internal" href="#imagepath" id="id68">モジュール <code class="docutils literal notranslate"><span class="pre">ImagePath</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id31" id="id69">コマンドラインユーティリティー</a></p>
<ul>
<li><p><a class="reference internal" href="#id32" id="id70">フォーマット変換</a></p></li>
<li><p><a class="reference internal" href="#id33" id="id71">リサイズ</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>OS</p>
<ul>
<li><p>Windows 7 Home Premium x64 SP1</p></li>
<li><p>Windows 10 Home x64</p></li>
</ul>
</li>
<li><p>本稿において、利用した各パッケージのバージョンは次のとおり。</p>
<ul>
<li><p><a class="reference external" href="https://www.python.org/">Python</a>: 3.4.1, 3.5.0, 3.5.2</p></li>
<li><p><a class="reference external" href="https://python-pillow.github.io/">Pillow</a>: 2.5.1, 2.8.1, 3.0.0, 3.2.0</p></li>
</ul>
</li>
</ul>
</div>
<section id="id2">
<h2><a class="toc-backref" href="#id36">関連リンク</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><a class="reference external" href="https://python-pillow.github.io/">Pillow</a></dt><dd><p>公式パッケージ・インストーラー配布元。</p>
</dd>
<dt><a class="reference external" href="https://www.lfd.uci.edu/~gohlke/pythonlibs/">Python Extension Packages for Windows - Christoph Gohlke</a></dt><dd><p>非公式インストーラー配布元。</p>
</dd>
</dl>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id37">関連ノート</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><a class="reference internal" href="python-pyopengl/index.html"><span class="doc">PyOpenGL 利用ノート</span></a></dt><dd><p>Pillow はテクスチャーデータを生成するのに大いに有用だ。</p>
</dd>
</dl>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id38">インストール</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h2>
<p><a class="reference internal" href="python-miniconda.html#python-pkg-proc"><span class="std std-ref">一般のサードパーティー製 Python パッケージのインストール手順</span></a> の方針に従ってインストールする。</p>
<p>ちなみに PIL が既に環境に居座っている場合は、Pillow をインストールする前に
PIL をアンインストールする必要があるようだ。公式サイトの Installation ページに PIL と Pillow が共存できない旨が明記されている。</p>
<section id="id5">
<h3><a class="toc-backref" href="#id39">アップグレード</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p><a class="reference external" href="https://docs.continuum.io/anaconda/">Anaconda</a> または <a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a> で Python 環境を管理しているのであれば、コマンドラインで Pillow をアップグレードすることは容易い。単に <code class="code docutils literal notranslate"><span class="pre">conda</span> <span class="pre">update</span> <span class="pre">Pillow</span></code> と入力するだけでよい。</p>
<p>それ以外の環境では <a class="reference external" href="https://pip.pypa.io/">pip</a> を用いることになる。</p>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id40">バージョン確認</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p><a class="reference external" href="https://docs.continuum.io/anaconda/">Anaconda</a> または <a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a> で Python 環境を管理していて、コマンドラインで作業をしているならば、次のように <strong class="program">conda</strong> ツールを用いる。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>conda list Pillow
<span class="gp"># </span>packages <span class="k">in</span> environment at D:<span class="se">\M</span>iniconda3:
<span class="gp">#</span>
<span class="go">pillow                    3.2.0                    py35_1</span>
</pre></div>
</div>
<p>Python インタラクティブシェル（長いので、以下単にインタープリターと書く）でインストール直後の Pillow のバージョンを確認するならば次のようにする。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">PIL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">PIL</span><span class="o">.</span><span class="n">VERSION</span>
<span class="go">&#39;1.1.7&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">PIL</span><span class="o">.</span><span class="n">PILLOW_VERSION</span>
<span class="go">&#39;3.0.0&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id41">ドキュメント</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h2>
<p>まずは <a class="reference external" href="https://python-pillow.github.io/">Pillow</a> 公式サイトの Guides を一読するとよい。それほどしっかりと読み込む必要はなく、使えそうな機能だけをつまみ読みでよい。</p>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id42">画像処理基本</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h2>
<p>ここでは基本モジュール <code class="docutils literal notranslate"><span class="pre">Image</span></code> のクラスと関数を利用した、初歩的な画像処理の実例をいくつか挙げる。</p>
<p>以下の説明で、単にメソッドという用語が現れる場合は、クラス <code class="docutils literal notranslate"><span class="pre">Image</span></code> のメソッドの意である。また、次のイメージを各操作デモの原像として多用している。</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/illvelo.png"><img alt="イルベロ" src="_images/illvelo.png" style="width: 128.0px; height: 126.0px;" /></a>
</figure>
<section id="id9">
<h3><a class="toc-backref" href="#id43">画像ファイルフォーマット変換（単発）</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<p>GIF 画像ファイル <code class="file docutils literal notranslate"><span class="pre">image.gif</span></code> を PNG 形式に変換して、ファイル <code class="file docutils literal notranslate"><span class="pre">image.png</span></code> として保存するコードを示す。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;image.gif&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;image.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>関数 <code class="docutils literal notranslate"><span class="pre">open</span></code> に画像ファイルパスを渡すと、画像オブジェクトが生成する。</p></li>
<li><p>メソッド <code class="docutils literal notranslate"><span class="pre">save</span></code> で画像ファイルをファイルシステム上に作成する。</p>
<ul>
<li><p>上のコードのようにファイルパスだけを指定する場合、ファイルの画像フォーマットは拡張子に基づいて Pillow が決定する。</p></li>
<li><p>拡張子に頼らずに画像フォーマットを指定する場合は、キーワード引数 <code class="docutils literal notranslate"><span class="pre">format</span></code> から文字列により指定できる。</p></li>
</ul>
</li>
</ul>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id44">画像ファイルフォーマット変換（バッチ処理）</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>カレントディレクトリー内の GIF ファイルを PNG ファイルに変換、保存する処理のコードはこうなる。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;batch.py: Demonstrate converting GIF files to PNG files.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.gif&quot;</span><span class="p">):</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ちなみに、自分でわざわざ上のようなコードを用意する必要はほぼないだろう。後述するように、
Python の Scripts ディレクトリーにインストールされている <code class="file docutils literal notranslate"><span class="pre">pilconvert.py</span></code> を使う手がある。</p></li>
<li><p>公式サイトのドキュメントでは、同様の方式によるサムネイル画像ファイルを一括作成する例が紹介されている。メソッド <code class="docutils literal notranslate"><span class="pre">open</span></code> と <code class="docutils literal notranslate"><span class="pre">save</span></code> の呼び出しの間にメソッド <code class="docutils literal notranslate"><span class="pre">thumbnail</span></code> 呼び出しをはさむとそうなる。</p></li>
</ul>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id45">Pillow がサポートする画像フォーマットを知る</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>Pillow のインストールディレクトリーで <code class="code docutils literal notranslate"><span class="pre">grep</span> <span class="pre">Image.register_</span> <span class="pre">*.py</span></code> するとよい。</p>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id46">画像データをバイト配列として扱う</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<p>画像データをバイト配列として扱うには、メソッド <code class="docutils literal notranslate"><span class="pre">tobytes</span></code> を用いる。
PyOpenGL のプログラムで画像ファイルからテクスチャーを生成する際に必須の方法だ。</p>
<ul class="simple">
<li><p>戻り値として <code class="docutils literal notranslate"><span class="pre">bytes</span></code> オブジェクトが得られる。</p></li>
<li><p>メモリレイアウトはキーワード引数 <code class="docutils literal notranslate"><span class="pre">encoder_name</span></code> で指定できるが、生のままでよい。例えば透過 PNG ファイルから <code class="docutils literal notranslate"><span class="pre">Image</span></code> オブジェクトを生成したときは、
<code class="docutils literal notranslate"><span class="pre">tobytes</span></code> は RGBARGBA… のようなデータ構造になる。</p></li>
<li><p>旧メソッド名は <code class="docutils literal notranslate"><span class="pre">tostring</span></code> だったが、現在 deprecated となっている。昔のコードを再利用するときに置換しておこう。</p></li>
</ul>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id47">簡易ビューワー</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>インタープリターで Pillow を試しているときに、クラス <code class="docutils literal notranslate"><span class="pre">Image</span></code> のオブジェクトをビューワーで確認したくなることがよくある。メソッド <code class="docutils literal notranslate"><span class="pre">show</span></code> はこういう場合に利用するのに相応しい。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Windows 版ビルドでは Windows のフォトビューワーが起動して、画像の内容が表示された。おそらくファイル拡張子に関連付けられたプログラムが起動されるものと思われる。</p>
<ul class="simple">
<li><p>オブジェクトが既存のファイルから得られたものでない場合にも通用する。</p></li>
<li><p>ドキュメントによると、このメソッドは効率が悪いらしい。場合によってはオブジェクトをファイルに保存しつつ、再読み込み機能がある画像ビューワーを開いたままにして、デバッグ作業するのもありか。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Linux では <code class="docutils literal notranslate"><span class="pre">im.show()</span></code> は ImageMagick の <strong class="program">display</strong> を介して画像を表示する。特に WSL では <a class="reference external" href="http://vcxsrv.sourceforge.net/">VcXsrv X Server</a> などの Windows 用サービスプログラムが
Windows 側で稼働していることを必要とする。
<code class="docutils literal notranslate"><span class="pre">im.show()</span></code> の呼び出しでエラーメッセージが出るようなら、次を確認する：</p>
<ul class="simple">
<li><p>(Windows) VcXsrv などのサービスはインストールされているか</p></li>
<li><p>(Windows) VcXsrv などに対するファイアーウォールを無効にしたか。</p></li>
<li><p>(WSL) ImageMagick はインストールされているか</p></li>
<li><p>(WSL) 環境変数 <code class="docutils literal notranslate"><span class="pre">DISPLAY</span></code> を正しくセットしたか</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">DISPLAY</span><span class="o">=</span><span class="k">$(</span>grep -oP <span class="s2">&quot;(?&lt;=nameserver ).+&quot;</span> /etc/resolv.conf<span class="k">)</span>:0.0
</pre></div>
</div>
</div>
</section>
<section id="id14">
<h3><a class="toc-backref" href="#id48">ジャギー解消</a><a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h3>
<p>メソッド <code class="docutils literal notranslate"><span class="pre">resize</span></code> や <code class="docutils literal notranslate"><span class="pre">thumbnail</span></code> を利用するのならば、キーワード引数 <code class="docutils literal notranslate"><span class="pre">resample</span></code> の実引数をデフォルトの
<code class="docutils literal notranslate"><span class="pre">Image.NEAREST</span></code> 以外の値にすることを検討するとよい。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Image.ANTIALIAS</span></code> はドキュメントからは消えているが、単に <code class="docutils literal notranslate"><span class="pre">Image.LANCZOS</span></code> の別名である。</p></li>
</ul>
</section>
<section id="id15">
<h3><a class="toc-backref" href="#id49">イメージモノクロ化</a><a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-illvelo-monochrome.png"><img alt="イルベロ" src="_images/pillow-illvelo-monochrome.png" style="width: 128.0px; height: 126.0px;" /></a>
</figure>
<p>メソッド <code class="docutils literal notranslate"><span class="pre">convert</span></code> を引数 <code class="docutils literal notranslate"><span class="pre">&quot;L&quot;</span></code> で呼び出す。各ピクセルの RGB 値を次の式でグレースケール化してモノクロ化するようだ。</p>
<div class="math notranslate nohighlight">
\begin{align*}
L = \frac{299}{1000} R + \frac{587}{1000} G + \frac{114}{1000} B
\end{align*}</div><div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;illvelo.png&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3><a class="toc-backref" href="#id50">画像生成</a><a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h3>
<p>ゼロから画像オブジェクトを生成するのに、関数 <code class="docutils literal notranslate"><span class="pre">Image.new</span></code> を利用することができる。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>引数 <code class="docutils literal notranslate"><span class="pre">mode</span></code> でよく指定する値は <code class="docutils literal notranslate"><span class="pre">'RGB'</span></code> か <code class="docutils literal notranslate"><span class="pre">'RGBA'</span></code> のどちらかになる。</p></li>
<li><p>引数 <code class="docutils literal notranslate"><span class="pre">size</span></code> は画素単位の画像サイズ。幅、高さの順に要素が並ぶ <code class="docutils literal notranslate"><span class="pre">tuple</span></code> オブジェクトで指定する。</p></li>
<li><p>キーワード引数 <code class="docutils literal notranslate"><span class="pre">color</span></code> でいわゆる背景色を指定できる。デフォルトは黒。</p></li>
</ul>
</section>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id51">色の表現</a><a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h2>
<p>Pillow はコードでの色の表現手段を多数サポートしている。詳しくはモジュール <code class="docutils literal notranslate"><span class="pre">ImageColor</span></code> の内容を見るとよい。</p>
<section id="id18">
<h3><a class="toc-backref" href="#id52">色名による色指定</a><a class="headerlink" href="#id18" title="Permalink to this heading">¶</a></h3>
<p>Pillow のメソッドで色を引数に取るものについては、色成分を列挙した <code class="docutils literal notranslate"><span class="pre">list</span></code> や <code class="docutils literal notranslate"><span class="pre">tuple</span></code> だけでなく、モジュール <code class="docutils literal notranslate"><span class="pre">ImageColor</span></code> で決められている色名で指定することもできる。色名の型はプログラマーにやさしい形式、つまり文字列である。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">),</span> <span class="s1">&#39;deeppink&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>色名は <code class="docutils literal notranslate"><span class="pre">colormap</span></code> という <code class="docutils literal notranslate"><span class="pre">dict</span></code> インスタンスに保持されている。興味があれば列挙してみるとよい。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageColor</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ImageColor</span><span class="o">.</span><span class="n">colormap</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">(&#39;aliceblue&#39;, &#39;#f0f8ff&#39;)</span>
<span class="go">(&#39;antiquewhite&#39;, &#39;#faebd7&#39;)</span>
<span class="go">(&#39;aqua&#39;, &#39;#00ffff&#39;)</span>
</pre></div>
</div>
<p>後半略。全部で 147 項目あるのでかなり長い。</p>
</section>
<section id="rgb">
<h3><a class="toc-backref" href="#id53">色名から RGB 値に変換する</a><a class="headerlink" href="#rgb" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">ImageColor.getrgb</span></code> を利用するほうが早い。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL.ImageColor</span> <span class="kn">import</span> <span class="n">getrgb</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">getrgb</span><span class="p">(</span><span class="s1">&#39;deeppink&#39;</span><span class="p">)</span>
<span class="go">(255, 20, 147)</span>
</pre></div>
</div>
<p>PyOpenGL プログラムなどで A 値も欲しい場合は関数 <code class="docutils literal notranslate"><span class="pre">getcolor</span></code> を用いるという手もある。このとき引数 <code class="docutils literal notranslate"><span class="pre">mode</span></code> の明示的な指定を必要とする。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL.ImageColor</span> <span class="kn">import</span> <span class="n">getcolor</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">getcolor</span><span class="p">(</span><span class="s1">&#39;deeppink&#39;</span><span class="p">,</span> <span class="s1">&#39;RGBA&#39;</span><span class="p">)</span>
<span class="go">(255, 20, 147, 255)</span>
</pre></div>
</div>
</section>
</section>
<section id="id19">
<h2><a class="toc-backref" href="#id54">透過</a><a class="headerlink" href="#id19" title="Permalink to this heading">¶</a></h2>
<section id="id20">
<h3><a class="toc-backref" href="#id55">透過画像生成</a><a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">new</span></code> で生成する画像オブジェクトを透過対応する方法は、引数 <code class="docutils literal notranslate"><span class="pre">mode</span></code> を <code class="docutils literal notranslate"><span class="pre">'RGBA'</span></code> にすることだ。</p>
<p>さらに、引数 <code class="docutils literal notranslate"><span class="pre">color</span></code> を、例えば 4 成分の array-like オブジェクトを渡すとしよう。この場合 <code class="docutils literal notranslate"><span class="pre">color[0:3]</span></code> はそれぞれ今までどおり R, G, B 値を指定する。さらなる成分 <code class="docutils literal notranslate"><span class="pre">color[3]</span></code> はアルファー値といい、アルファベットの A で示す。この A 値は下限値の 0 が完全透明を意味し、上限値の 0xFF は完全不透明を意味する（ところで英語には opaque という単語があるが、日本語だと否定形で表現するしかなさそうだ）。その中間の値は、まあまあ透明という意味だ。実際はアルファブレンディングという手法で最終的な RGB 色を決定するための値である。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>このようにすると、真っ黒だが透明という画像オブジェクト <code class="docutils literal notranslate"><span class="pre">img</span></code> が生成する。</p>
</section>
<section id="png">
<h3><a class="toc-backref" href="#id56">アルファチャンネルを持つ PNG 画像を青地背景上に重ねたい</a><a class="headerlink" href="#png" title="Permalink to this heading">¶</a></h3>
<p>要するに、透過ピクセルを含む画像をブルーバックの画像の上に乗せると思って欲しい。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;alphapaste.py: Demonstrate how to composite two images with alpha values.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">SOURCE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../../_images/illvelo.png&#39;</span><span class="p">)</span>

<span class="c1"># Layer 1 in Photoshop.</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">SOURCE_PATH</span><span class="p">)</span>

<span class="c1"># Background layer in Photoshop.</span>
<span class="n">bkgnd</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Blend images with the transparency mask from img.split()[3].</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">alpha_composite</span><span class="p">(</span><span class="n">bkgnd</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>いちばん楽なのは関数 <code class="docutils literal notranslate"><span class="pre">alpha_composite</span></code> を用いることだ。自分でメソッド <code class="docutils literal notranslate"><span class="pre">split</span></code> を呼んでバンドオブジェクトを用意したり、マスクを指定して関数 <code class="docutils literal notranslate"><span class="pre">paste</span></code> を呼ばずに済む。</p>
<p>元画像と処理後の画像はこうなる。ここで、元画像のキャラクターの輪郭の外側は完全透明色、内側領域は完全不透明色である。</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-illvelo-blueback.png"><img alt="イルベロ" src="_images/pillow-illvelo-blueback.png" style="width: 128.0px; height: 126.0px;" /></a>
</figure>
</section>
</section>
<section id="id21">
<h2><a class="toc-backref" href="#id57">グラデーション</a><a class="headerlink" href="#id21" title="Permalink to this heading">¶</a></h2>
<p>Pillow は直接的にはグラデーションをサポートしていなそうなので、描きたいときは自作する。ここではグラデーションパターンの生成について、いくつかコツを記す。</p>
<section id="id22">
<h3><a class="toc-backref" href="#id58">線形グラデーション（透過なし）</a><a class="headerlink" href="#id22" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-gradient-opaque.png"><img alt="線形グラデーション（透過なし）" src="_images/pillow-gradient-opaque.png" style="width: 160.0px; height: 120.0px;" /></a>
</figure>
<p>幅 <span class="math notranslate nohighlight">\(1 \times 256\)</span> ピクセルのイメージを作成し、ピクセルカラーをその位置に応じてセットしていく方針で絵を描く。まずは <code class="docutils literal notranslate"><span class="pre">putpixel</span></code> メソッドを利用してこれを行い、それから目的のサイズにイメージを拡縮する。</p>
<p>次に示すコードは、サイズが <span class="math notranslate nohighlight">\(320 \times 240\)</span> で、上部が赤で下部が青の線形グラデーションとなるイメージを作成する。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;gradient1.py: Demonstrate drawing linear gradient.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="n">ImageColor</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">COLOR_START</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getrgb</span><span class="p">(</span><span class="s1">&#39;antiquewhite&#39;</span><span class="p">)</span>
<span class="n">COLOR_STOP</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getrgb</span><span class="p">(</span><span class="s1">&#39;deeppink&#39;</span><span class="p">)</span>
<span class="n">IMAGE_WIDTH</span><span class="p">,</span> <span class="n">IMAGE_HEIGHT</span> <span class="o">=</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span>
<span class="n">WORK_SIZE</span> <span class="o">=</span> <span class="mh">0x100</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">WORK_SIZE</span><span class="p">))</span>
<span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">WORK_SIZE</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">COLOR_START</span><span class="p">,</span> <span class="n">COLOR_STOP</span><span class="p">)],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rgb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
    <span class="n">img</span><span class="o">.</span><span class="n">putpixel</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rgb</span><span class="p">))</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">IMAGE_WIDTH</span><span class="p">,</span> <span class="n">IMAGE_HEIGHT</span><span class="p">))</span>
<span class="n">img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>線形補間の計算コード記述の手間を少々省くため、<a class="reference external" href="https://www.numpy.org/">NumPy</a> の関数 <code class="docutils literal notranslate"><span class="pre">linspace</span></code> を利用した。</p></li>
</ul>
</section>
<section id="id23">
<h3><a class="toc-backref" href="#id59">線形グラデーション（単色にグレースケール透過）</a><a class="headerlink" href="#id23" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-gradient-greyscale.png"><img alt="線形グラデーション（単色にグレースケール透過）" src="_images/pillow-gradient-greyscale.png" style="width: 160.0px; height: 120.0px;" /></a>
</figure>
<p>メソッド <code class="docutils literal notranslate"><span class="pre">putalpha</span></code> 利用版グラデーション。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;gradient2.py: Demonstrate drawing linear gradient.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">BASE_COLOR</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
<span class="n">IMAGE_WIDTH</span><span class="p">,</span> <span class="n">IMAGE_HEIGHT</span> <span class="o">=</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span>
<span class="n">WORK_SIZE</span> <span class="o">=</span> <span class="mh">0x100</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">IMAGE_WIDTH</span><span class="p">,</span> <span class="n">IMAGE_HEIGHT</span><span class="p">),</span> <span class="n">BASE_COLOR</span><span class="p">)</span>
<span class="n">gradient</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">WORK_SIZE</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">WORK_SIZE</span><span class="p">):</span>
    <span class="n">gradient</span><span class="o">.</span><span class="n">putpixel</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">WORK_SIZE</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

<span class="n">img</span><span class="o">.</span><span class="n">putalpha</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
<span class="n">img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>出力は上部が赤で、下部に至るにつれて透過していく線形グラデーションイメージとなる。</p>
</section>
<section id="id24">
<h3><a class="toc-backref" href="#id60">線形グラデーション（さらなる応用）</a><a class="headerlink" href="#id24" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-illvelo-gradient.png"><img alt="イルベロ" src="_images/pillow-illvelo-gradient.png" style="width: 128.0px; height: 126.0px;" /></a>
</figure>
<p>イメージ 3 枚重ね。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;gradient3.py: Demonstrate drawing linear gradient on an image.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">WORK_SIZE</span> <span class="o">=</span> <span class="mh">0x100</span>
<span class="n">SOURCE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../../_images/illvelo.png&#39;</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">SOURCE_PATH</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">img</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;RGBA&#39;</span>

<span class="n">gradient</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">WORK_SIZE</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">WORK_SIZE</span><span class="p">):</span>
    <span class="n">gradient</span><span class="o">.</span><span class="n">putpixel</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>

<span class="n">final</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">final</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
<span class="n">final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id25">
<h3><a class="toc-backref" href="#id61">放射状グラデーション</a><a class="headerlink" href="#id25" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-gradient-radial.png"><img alt="放射状グラデーション" src="_images/pillow-gradient-radial.png" style="width: 128.0px; height: 128.0px;" /></a>
</figure>
<p>放射状のグラデーションを実現する例を示す。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;gradient4.py: Demonstrate drawing radial gradient.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="n">ImageColor</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">COLOR_START</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getrgb</span><span class="p">(</span><span class="s1">&#39;antiquewhite&#39;</span><span class="p">)</span>
<span class="n">COLOR_STOP</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getrgb</span><span class="p">(</span><span class="s1">&#39;deeppink&#39;</span><span class="p">)</span>
<span class="n">WORK_SIZE</span> <span class="o">=</span> <span class="mh">0x100</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">WORK_SIZE</span><span class="p">,</span> <span class="n">WORK_SIZE</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">WORK_SIZE</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">COLOR_START</span><span class="p">,</span> <span class="n">COLOR_STOP</span><span class="p">)],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rgb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">ellipse</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">WORK_SIZE</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">WORK_SIZE</span> <span class="o">-</span> <span class="n">i</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rgb</span><span class="p">))</span>

<span class="n">img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>クラス <code class="docutils literal notranslate"><span class="pre">ImageDraw.Draw</span></code> のメソッド <code class="docutils literal notranslate"><span class="pre">ellipse</span></code> をバウムクーヘン方式に描画する。バウムクーヘンを外側から内側に向かって、少しずつ色を変えて塗れば、遠目からはグラデーションのように見えるだろう。</p>
<ul class="simple">
<li><p>RGB 値の算出に <code class="docutils literal notranslate"><span class="pre">np.linspace</span></code> を用いるのは、前述の方法論による。</p></li>
<li><p>楕円の形状指定方法は、そのバウンディングボックスを与えることによる。そして、ボックスの形状指定方法は、その左上頂点座標と右下頂点座標を与えることによる。</p></li>
</ul>
</section>
</section>
<section id="id26">
<h2><a class="toc-backref" href="#id62">テキスト</a><a class="headerlink" href="#id26" title="Permalink to this heading">¶</a></h2>
<p>テキストを画像として動的に生成する方法を見ていこう。ここでインポートする Pillow のモジュールは <code class="docutils literal notranslate"><span class="pre">Image</span></code> のほかにも
<code class="docutils literal notranslate"><span class="pre">ImageDraw</span></code> と <code class="docutils literal notranslate"><span class="pre">ImageFont</span></code> がある。</p>
<section id="hello-world">
<h3><a class="toc-backref" href="#id63">Hello, world</a><a class="headerlink" href="#hello-world" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-hello-world.png"><img alt="Hello, world" src="_images/pillow-hello-world.png" style="width: 96.0px; height: 24.0px;" /></a>
</figure>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;text1.py: Demonstrate how to draw a text with PIL.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">)</span>

<span class="n">IMAGE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">BKGND_COLOR</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
<span class="n">TEXT_COLOR</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="n">IMAGE_SIZE</span><span class="p">,</span> <span class="n">BKGND_COLOR</span><span class="p">)</span>
<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Hello, world&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">TEXT_COLOR</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>上のコードを動作させると、黒地に白い字で <code class="docutils literal notranslate"><span class="pre">Hello,</span> <span class="pre">world</span></code> と書かれた画像が生成する。これだけだとかなり不満がある。</p>
<ul class="simple">
<li><p>テキストのサイズ等の情報が事前に予測不可能。</p></li>
<li><p>フォントを指定したい。</p></li>
</ul>
</section>
<section id="id27">
<h3><a class="toc-backref" href="#id64">日本語テキスト</a><a class="headerlink" href="#id27" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-karous-paradise.png"><img alt="カラス出会い系メールの文面" src="_images/pillow-karous-paradise.png" style="width: 423.0px; height: 144.0px;" /></a>
</figure>
<p>コツは 3 つある。</p>
<ul class="simple">
<li><p>関数 <code class="docutils literal notranslate"><span class="pre">ImageFont.truetype</span></code> で日本語対応のフォントオブジェクトを作成する。</p></li>
<li><p>その際に <code class="docutils literal notranslate"><span class="pre">encoding</span></code> 引数に適切なエンコーディングを指示する。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">text</span></code> メソッドの引数にそのフォントを与える。</p></li>
</ul>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;text2.py: Demonstrate how to draw multi-line text using ImageFont.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span><span class="p">)</span>

<span class="n">TEXT</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;どうしても会ってもらえませんか？</span>
<span class="s1">私はこんなにあなたに会いたいのに…。</span>
<span class="s1">お金には余裕があるので心配しないで</span>
<span class="s1">ください。</span>
<span class="s1">コード780の1102番で、</span>
<span class="s1">あなたを待っています。</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">TEXT_COLOR</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
<span class="n">BKGND_COLOR</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
<span class="n">FONT</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s1">&#39;HGRME.TTC&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">BKGND_COLOR</span><span class="p">)</span>
<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">TEXT</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">line</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">FONT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">TEXT_COLOR</span><span class="p">)</span>

    <span class="n">ext</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">textsize</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">FONT</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">+=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Trim extra margin of right and bottom.</span>
<span class="n">final</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
<span class="n">final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>トリム処理を加えることで、出力画像の大きさはテキストにフィットする最小の矩形になるはずだ。</p>
</section>
</section>
<section id="id28">
<h2><a class="toc-backref" href="#id65">応用</a><a class="headerlink" href="#id28" title="Permalink to this heading">¶</a></h2>
<p>少し手間をかけて、画像を加工することを試そう。</p>
<section id="id29">
<h3><a class="toc-backref" href="#id66">スクリーンショット</a><a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-grab.png"><img alt="スクリーンキャプチャー" src="_images/pillow-grab.png" style="width: 256.0px; height: 143.0px;" /></a>
</figure>
<p>モジュール <code class="docutils literal notranslate"><span class="pre">ImageGrab</span></code> を用いると、画面イメージキャプチャーが得られる。このスクリーンショット取得機能は Pillow の Windows 版にだけある。</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;grabdemo.py: Demonstrate how to use function ImageGrab.grab.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="n">ImageGrab</span><span class="p">)</span>

<span class="c1"># Take a snapshot of the whole screen.</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">ImageGrab</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>

<span class="c1"># For the purpose of display, make it to a thumbnail.</span>
<span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id30">
<h3><a class="toc-backref" href="#id67">上下左右ループ壁紙パターン生成</a><a class="headerlink" href="#id30" title="Permalink to this heading">¶</a></h3>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/pillow-illvelo-wallpaper.png"><img alt="イルベロ" src="_images/pillow-illvelo-wallpaper.png" style="width: 128.0px; height: 126.0px;" /></a>
</figure>
<p>気がついたら Pillow のドキュメントにこの技法が載っていたが、ここでは少々凝ったやり方で壁紙の繰り返し単位部分を生成する。</p>
<ol class="arabic simple">
<li><p>元画像を <span class="math notranslate nohighlight">\(2 \times 2\)</span> 分割して対角線上の区域を入れ替える。</p></li>
<li><p>そこへ元画像をブレンドなりオーバーレイなりして重ね合わせる。</p></li>
</ol>
<p>スクリプトのリポジトリーを移転したので、次のリンク先を参照。
<a class="reference external" href="https://github.com/showa-yojyo/sketchbook/blob/develop/tools/pattern.py">pattern.py</a></p>
</section>
<section id="imagepath">
<h3><a class="toc-backref" href="#id68">モジュール <code class="docutils literal notranslate"><span class="pre">ImagePath</span></code></a><a class="headerlink" href="#imagepath" title="Permalink to this heading">¶</a></h3>
<p>これはユーザーが直接利用するのではなさそうなので使うのをやめた。</p>
<p>モジュール <code class="docutils literal notranslate"><span class="pre">ImagePath</span></code> は、ドキュメントがないモジュール <code class="docutils literal notranslate"><span class="pre">ImageDraw2</span></code> の描画機能（点列のアフィン変換）のために、補助データ構造を提供するもののようだ。</p>
</section>
</section>
<section id="id31">
<h2><a class="toc-backref" href="#id69">コマンドラインユーティリティー</a><a class="headerlink" href="#id31" title="Permalink to this heading">¶</a></h2>
<p>Pillow をインストールすると、パッケージの他に一連のスクリプトファイル群が
Python ディレクトリーの <code class="file docutils literal notranslate"><span class="pre">Scripts</span></code> フォルダーに格納される。これらのスクリプトは Pillow の機能を応用した、画像操作のためのささやかなコマンドラインユーティリティーだ。</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 92%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>スクリプト</p></th>
<th class="head"><p>何をするのか</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="file docutils literal notranslate"><span class="pre">pilconvert.py</span></code></p></td>
<td><p>画像ファイルの画像フォーマットや色モードを変換する。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="file docutils literal notranslate"><span class="pre">pildriver.py</span></code></p></td>
<td><p>画像ファイルの画像の操作をする。対話モードあり。</p></td>
</tr>
<tr class="row-even"><td><p><code class="file docutils literal notranslate"><span class="pre">pilfile.py</span></code></p></td>
<td><p>画像ファイルの鑑定をする。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="file docutils literal notranslate"><span class="pre">pilfont.py</span></code></p></td>
<td><p>フォントファイルを PIL のラスターフォントフォーマットに変換する。</p></td>
</tr>
<tr class="row-even"><td><p><code class="file docutils literal notranslate"><span class="pre">pilprint.py</span></code></p></td>
<td><p>画像ファイルを PostScript プリンターに出力する。うまく動かない？</p></td>
</tr>
</tbody>
</table>
<section id="id32">
<h3><a class="toc-backref" href="#id70">フォーマット変換</a><a class="headerlink" href="#id32" title="Permalink to this heading">¶</a></h3>
<p>コマンドラインで <code class="file docutils literal notranslate"><span class="pre">pilconvert.py</span></code> を利用する。例えば <code class="docutils literal notranslate"><span class="pre">sample.gif</span></code> から PNG 形式のファイル <code class="docutils literal notranslate"><span class="pre">sample.png</span></code> を作成するには次のように入力する。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pilconvert.py sample.gif sample.png
</pre></div>
</div>
<p>カレントディレクトリーのすべての GIF ファイルから PNG ファイルに変換したいならばこうなる。ちなみにシェルは bash である。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="k">for</span> name <span class="k">in</span> *.gif <span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
<span class="gp">&gt; </span>  pilconvert.py <span class="nv">$name</span> <span class="si">${</span><span class="nv">name</span><span class="p">%.*</span><span class="si">}</span>.png <span class="p">;</span> <span class="se">\</span>
<span class="gp">&gt; </span><span class="k">done</span>
</pre></div>
</div>
</section>
<section id="id33">
<h3><a class="toc-backref" href="#id71">リサイズ</a><a class="headerlink" href="#id33" title="Permalink to this heading">¶</a></h3>
<p>コマンドラインで <code class="file docutils literal notranslate"><span class="pre">pildriver.py</span></code> を利用する。以前にも記したが、バッチモードとインタラクティブモードがある。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pildriver.py
<span class="go">PILDriver says hello.</span>
<span class="go">pildriver&gt; open illvelo.png</span>
<span class="go">[&lt;PIL.PngImagePlugin.PngImageFile image mode=RGBA size=256x252 at 0xBEF800&gt;]</span>
<span class="go">pildriver&gt; thumbnail 64 64</span>
<span class="go">[&lt;PIL.PngImagePlugin.PngImageFile image mode=RGBA size=64x63 at 0xBEF800&gt;]</span>
<span class="go">pildriver&gt; show</span>
<span class="go">[]</span>
<span class="go">pildriver&gt;</span>
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="python-matplotlib/index.html" title="Matplotlib 利用ノート"
             >next</a></li>
        <li class="right" >
          <a href="python-pil.html" title="PIL 利用ノート [obsolete]"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">読書ノート</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Pillow 利用ノート</a></li> 
      </ul>
    </div>
    <div id="footer">
      <div id="footer_logo">
        <a class="imga" href="https://showa-yojyo.github.io/" title="プレハブ小屋 Since 1999"><img src="_static/logos.png" width="88" height="31" /></a>
      </div>
      <div id="footer_copyright">
        Since 1999<br />
        Copyright &copy; 1999-2022, プレハブ小屋 All rights reserved.
      </div>
    </div>
  </body>
</html>