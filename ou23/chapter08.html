<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Chapter 08: File System &#8212; 読書ノート 1.5dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=1a9a5cd9" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=91898170"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/mermaid.js?v=578dbed1"></script>
    <link rel="next" title="Chapter 09: Minor Features" href="chapter09.html" />
    <link rel="prev" title="Chapter 07: Parallelism and Concurrency" href="chapter07.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="chapter07.html" title="Previous document">Chapter 07: Parallelism and Concurrency</a>
        </li>
        <li>
          <a href="chapter09.html" title="Next document">Chapter 09: Minor Features</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section id="chapter-08-file-system">
<h1><a class="toc-backref" href="#id18" role="doc-backlink">Chapter 08: File System</a><a class="headerlink" href="#chapter-08-file-system" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="https://changkun.de/modern-cpp/en-us/08-filesystem/">Chapter 08: File System</a>
についてのノートなのだが、本文が実質空なので読者自身で学習するかもしれない。</p>
<p>ファイルシステムライブラリーは、ファイルシステム、パス、正規ファイル、ディレクトリーなどの操作に関する機能を備えている。正規表現ライブラリーと同様に、Boost 由来ライブラリーの一つで、最終的には C++ 標準に統合された。</p>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#chapter-08-file-system" id="id18">Chapter 08: File System</a></p>
<ul>
<li><p><a class="reference internal" href="#document-and-link" id="id19">8.1 Document and Link</a></p></li>
<li><p><a class="reference internal" href="#std-filesystem" id="id20">8.2 <code class="docutils literal notranslate"><span class="pre">std::filesystem</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id21">本ライブラリーで用いられる諸概念</a></p></li>
<li><p><a class="reference internal" href="#path" id="id22">クラス <code class="docutils literal notranslate"><span class="pre">path</span></code></a></p></li>
<li><p><a class="reference internal" href="#id2" id="id23">パスの取得と操作</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id24">ファイル属性を参照または設定する</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id25">アクセス権を操作する</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id26">その他のファイル情報を取得する</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id27">ディレクトリー内のファイルを一つ一つ処理する</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id28">ファイルの存在を確かめる</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id29">ファイル種別が特定のものであるかどうかを確かめる</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id30">ファイル作成</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id31">ファイル複製</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id32">ファイル移動</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id33">ファイル削除</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id34">異常時処理</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#further-readings" id="id35">Further Readings</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="document-and-link">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">8.1 Document and Link</a><a class="headerlink" href="#document-and-link" title="Permalink to this heading">¶</a></h2>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>なんにのない。何を述べるのかも不明。</p>
</div>
</section>
<section id="std-filesystem">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">8.2 <code class="docutils literal notranslate"><span class="pre">std::filesystem</span></code></a><a class="headerlink" href="#std-filesystem" title="Permalink to this heading">¶</a></h2>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>本節も内容が空なので、次の節まで好きなことを勝手に記す。種本は
cppreference.com の文章だろうから、それを私なりに要約していく。</p>
</div>
<figure class="align-center" id="id14">
<div class="mermaid">
            flowchart LR
    directory_entry -.-&gt; file_status &amp; path
    D[&quot;{,recursive_}directory_iterator&quot;] -.-&gt; path &amp; directory_entry &amp; directory_options

    ss[[&quot;{,symlink_}status&quot;]] -.-&gt; file_status &amp; path
    file_status -.-&gt; file_type &amp; perms

    cc[[&quot;copy{,_file}&quot;]] -.-&gt; path &amp; copy_options
    permissions[[permissions]] -.-&gt; path &amp; perms &amp; perm_options
    space[[space]] -.-&gt; path &amp; space_info

    L[[last_write_time]] -.-&gt; file_time_type &amp; path

    A[[&quot;Most\nNon-member\nFunctions&quot;]] -..-&gt; path
        </div><figcaption>
<p><span class="caption-text">Dependency of std::filesystem components</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<section id="id1">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">本ライブラリーで用いられる諸概念</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<p>C++ の言葉というより、ファイルシステムのそれだ：</p>
<dl>
<dt>ファイル (file)</dt><dd><p>ファイルシステムの主な構成要素であるオブジェクトだ。ファイルには名前、属性、種別がある。ファイル種別は次のようなものだ。</p>
<dl class="simple">
<dt>ディレクトリー (directory)</dt><dd><p>ファイルの容器となるファイル。他のディレクトリーを入れ子にすることができる。</p>
</dd>
<dt>通常ファイル (regular file)</dt><dd><p>ディレクトリーに入っているファイルであって、名前と存在するファイルを関連付ける物（ハードリンク）。</p>
</dd>
<dt>シンボリックリンク (symbolik link, symlink)</dt><dd><p>ディレクトリーに入っているファイルであって、名前とパスを関連付ける物。パスは実際に存在しなくてもよい。</p>
</dd>
</dl>
<p>この他にもファイル種別はあるが、省略。</p>
</dd>
<dt>ファイル名 (file name)</dt><dd><p>ファイル名を表す文字列。利用可能な文字、大文字小文字の区別、最大長は実装定義。文字列 <code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code> および <code class="docutils literal notranslate"><span class="pre">&quot;..&quot;</span></code> は当ライブラリーで特別な意味がある。</p>
</dd>
<dt>パス (path)</dt><dd><p>ファイルを識別するための一連の要素。パス名は、オプションのルート名で始まり、0 個以上のファイル名の連なりだ。パスの文字列表現（パス名）のネイティブ書式（例：セパレーターが何か）や文字エンコーディングは実装依存なのだが、本ライブラリーは可搬性のあるパス表現を与える。</p>
<dl>
<dt>絶対パス (absolute path)</dt><dd><p>ファイルの場所を一義的に特定する示すパス。</p>
<dl class="simple">
<dt>正規パス (canonical path)</dt><dd><p>シンボリックリンク、<code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;..&quot;</span></code> のいずれも含まない絶対パス。</p>
</dd>
</dl>
</dd>
<dt>相対パス (relative path)</dt><dd><p>ファイルシステム上のある場所からの相対的なファイルの位置を特定するためのパス。<code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code> や <code class="docutils literal notranslate"><span class="pre">&quot;..&quot;</span></code> を含むのが普通。</p>
</dd>
</dl>
</dd>
</dl>
</section>
<section id="path">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">クラス <code class="docutils literal notranslate"><span class="pre">path</span></code></a><a class="headerlink" href="#path" title="Permalink to this heading">¶</a></h3>
<p>当ライブラリー最重要コンポーネントであるクラスは <code class="docutils literal notranslate"><span class="pre">path</span></code> だ。
<code class="docutils literal notranslate"><span class="pre">std::filesystem</span></code> にあるほとんどのクラスメンバー関数、フリー関数、演算子各種がこのクラスのオブジェクトを引数に取る。</p>
<p>パスオブジェクトを得る方法はいくつかある：</p>
<ul class="simple">
<li><p>パスを表現する文字列を引数としてコンストラクターを呼び出す</p></li>
<li><p>特別なパスを返すフリー関数を呼び出す</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">directory_entry</span></code> オブジェクトからメンバー関数 <code class="docutils literal notranslate"><span class="pre">path</span></code> を呼び出す</p></li>
<li><p>既存の <code class="docutils literal notranslate"><span class="pre">path</span></code> オブジェクトを加工してオブジェクトを新しく生成する</p></li>
</ul>
<p>パスに関する操作を目的で分類し、興味のあるものから習得すればいいだろう：</p>
<dl>
<dt>結合</dt><dd><p>パス二つを結合して一つのパスにする操作だ。ファイルシステムの観点ではディレクトリーにファイルを指定することに対応するものと、ディレクトリーの名前を文字列として末尾に付け足すことに対応する操作がある。前者にはメンバー関数
<code class="docutils literal notranslate"><span class="pre">append</span></code>, <code class="docutils literal notranslate"><span class="pre">operator/=</span></code>, フリー関数 <code class="docutils literal notranslate"><span class="pre">operator/</span></code> いずれかを、後者にはメンバー関数 <code class="docutils literal notranslate"><span class="pre">concat</span></code>, <code class="docutils literal notranslate"><span class="pre">operaor+=</span></code> のいずれかをそれぞれ用いる。</p>
</dd>
<dt>修正</dt><dd><p>ディレクトリーセパレーターをプラットフォームに相応しいものに変換するメソッド
<code class="docutils literal notranslate"><span class="pre">make_preferred</span></code>, パスからファイル名を除去するメソッド <code class="docutils literal notranslate"><span class="pre">remove_filename</span></code>,
ファイル名や拡張子を置換するメソッド <code class="docutils literal notranslate"><span class="pre">replace_filename</span></code>, <code class="docutils literal notranslate"><span class="pre">replace_extension</span></code>,
パスを空にするメソッド <code class="docutils literal notranslate"><span class="pre">clear</span></code> などがある。</p>
</dd>
<dt>変換</dt><dd><p>パス形式を正規形に変換するメソッド <code class="docutils literal notranslate"><span class="pre">lexically_normal</span></code> や、基準パスを指定して相対パスに変換するメソッド <code class="docutils literal notranslate"><span class="pre">lexically_relative</span></code> がある。何が lexically
なのかというと、パスが実際に意味のある位置を指すか否かは不問だからだ。</p>
</dd>
<dt>分解</dt><dd><p>メソッド名から操作内容は解る。名前だけ並べると <code class="docutils literal notranslate"><span class="pre">root_name</span></code>,
<code class="docutils literal notranslate"><span class="pre">root_directory</span></code>, <code class="docutils literal notranslate"><span class="pre">root_path</span></code>, <code class="docutils literal notranslate"><span class="pre">relative_path</span></code>, <code class="docutils literal notranslate"><span class="pre">parent_path</span></code>,
<code class="docutils literal notranslate"><span class="pre">filename</span></code>, <code class="docutils literal notranslate"><span class="pre">stem</span></code>, <code class="docutils literal notranslate"><span class="pre">extension</span></code>.</p>
</dd>
<dt>照会</dt><dd><p>オブジェクトが初期状態かどうかはメソッド <code class="docutils literal notranslate"><span class="pre">empty</span></code> でテストする。</p>
<p>パスが絶対パス、相対パスかを調べるにはメソッド <code class="docutils literal notranslate"><span class="pre">is_absolute</span></code>,
<code class="docutils literal notranslate"><span class="pre">is_relative</span></code> をそれぞれ確認する。</p>
<p>メソッド名が <code class="docutils literal notranslate"><span class="pre">has_</span></code> で始まるものは、その目的語部分がパスにあるかどうかを返す。例えば <code class="docutils literal notranslate"><span class="pre">has_extension</span></code> はパスが拡張子を有するかどうかを返す。</p>
</dd>
</dl>
<p>二つのパスを比較演算子で辞書式比較することができる。</p>
<p>パスオブジェクトをシフト演算子で <code class="docutils literal notranslate"><span class="pre">std::ostream</span></code> に作用させることができる。すなわち <code class="docutils literal notranslate"><span class="pre">std::cout</span></code> にパスを出力することができる。</p>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">パスの取得と操作</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p>クラス <code class="docutils literal notranslate"><span class="pre">path</span></code> のメンバーでない機能をいくつか記す。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">equivalent</span></code> は指定された二つのパスが同じファイルシステム実体を指すものかどうかをチェックする。どちらかが存在しない場合にはエラーが得られる。それに加え、
<code class="docutils literal notranslate"><span class="pre">operator==</span></code> 系や <code class="docutils literal notranslate"><span class="pre">compare</span></code> という、パスが文字列的に等しいかをテストする関数も用意されている。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">current_path</span></code> は用途が二つある。戻り値を返す方はシェルコマンド
<strong class="command">pwd</strong> が出力するようなパスを絶対パスで返す。引数として <code class="docutils literal notranslate"><span class="pre">path</span></code> を取る方はシェルコマンド <strong class="command">cd path</strong> のように振る舞う。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">absolute</span></code> は指定パスと同じファイルシステムの場所を参照する絶対パスを返す。指定パスにファイルが存在するかどうかは考慮されない。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">canonical</span></code> は指定パスを正規パスに変換してそれを返す。指定パスが絶対パスでない場合、この関数は <code class="docutils literal notranslate"><span class="pre">absolute</span></code> によって最初に絶対パスにされたかのように動作する。こちらの関数は指定パスはファイルシステム上に存在しなければならない。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">relative</span></code> は基準パスに対する指定パスへの相対パスを返す。他の処理に先立って、引数のパスを正規化する。</p>
<p>あとは <code class="docutils literal notranslate"><span class="pre">is_regular_file</span></code>, <code class="docutils literal notranslate"><span class="pre">is_directory</span></code> など、<code class="docutils literal notranslate"><span class="pre">is_</span></code> から始まる一連の述語関数がある。</p>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">ファイル属性を参照または設定する</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<figure class="align-center" id="id15">
<div class="mermaid">
            flowchart LR
  subgraph ss [functions]
    direction LR
    m1[[status]]
    m2[[symlink_status]]
  end
  ss -.-&gt; file_status &amp; path
  file_status -.-&gt; file_type &amp; perms
        </div><figcaption>
<p><span class="caption-text">Dependency of status and symlinks</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>関数 <code class="docutils literal notranslate"><span class="pre">status</span></code>, <code class="docutils literal notranslate"><span class="pre">symlink_status</span></code> は指定パスのファイル属性を返す。後者はシンボリックリンクをたどらず、リンク自身の属性を返す。これらの関数はクラス
<code class="docutils literal notranslate"><span class="pre">file_status</span></code> のオブジェクトを返す。この戻り値から次に述べるファイル種別とアクセス権を取得したり設定したりすることになる：</p>
<ul class="simple">
<li><p>ファイル種別を操作するにはメソッド <code class="docutils literal notranslate"><span class="pre">type</span></code> を呼び出す。</p></li>
<li><p>アクセス権を操作するにはメソッド <code class="docutils literal notranslate"><span class="pre">permissions</span></code> を呼び出す。</p></li>
</ul>
<p>どちらのメソッドも取得用と設定用オーバーロードがある。</p>
<p><code class="docutils literal notranslate"><span class="pre">std::filesystem</span></code> では、ファイル種別を次の列挙型の値で表現する。各定数の値はどれをとっても互いに等しくない：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">file_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">none</span><span class="p">,</span>
<span class="w">    </span><span class="n">not_found</span><span class="p">,</span>
<span class="w">    </span><span class="n">regular</span><span class="p">,</span>
<span class="w">    </span><span class="n">directory</span><span class="p">,</span>
<span class="w">    </span><span class="n">symlink</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">アクセス権を操作する</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>メソッド <code class="docutils literal notranslate"><span class="pre">file_status::permissions</span></code> の他に、フリー関数の <code class="docutils literal notranslate"><span class="pre">permissions</span></code> でもファイルのアクセス権を操作することが可能だ。</p>
<figure class="align-center" id="id16">
<div class="mermaid">
            flowchart LR
    permissions[[permissions]] -.-&gt; path &amp; perms &amp; perm_options
        </div><figcaption>
<p><span class="caption-text">Dependency of permissions</span><a class="headerlink" href="#id16" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p><code class="docutils literal notranslate"><span class="pre">std::filesystem</span></code> では、ファイルに対するアクセス権を次の列挙型の値で表現する。各定数はビット演算が効くように定義されている。UNIX の <strong class="command">chmod</strong> と同じと思っていい：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">perms</span><span class="p">{</span>
<span class="w">    </span><span class="n">none</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">owner_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0400</span><span class="p">,</span>
<span class="w">    </span><span class="n">owner_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0200</span><span class="p">,</span>
<span class="w">    </span><span class="n">owner_exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0100</span><span class="p">,</span>
<span class="w">    </span><span class="n">owner_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0700</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0777</span><span class="p">,</span>
<span class="w">    </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">07777</span><span class="p">,</span>
<span class="w">    </span><span class="n">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffff</span>
<span class="p">};</span>
</pre></div>
</div>
<p>さらにオプション指定のために列挙型 <code class="docutils literal notranslate"><span class="pre">perm_opsions</span></code> がある。意味が通じる限りはメンバーの論理ビット演算が許されるようだ：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">perm_options</span><span class="p">{</span>
<span class="w">    </span><span class="n">replace</span><span class="p">,</span>
<span class="w">    </span><span class="n">add</span><span class="p">,</span>
<span class="w">    </span><span class="n">remove</span><span class="p">,</span>
<span class="w">    </span><span class="n">nofollow</span>
<span class="p">};</span>
</pre></div>
</div>
<p>用例を引用しておく：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">permissions</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;test.txt&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">perms</span><span class="o">::</span><span class="n">owner_all</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">perms</span><span class="o">::</span><span class="n">group_all</span><span class="p">,</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">perm_options</span><span class="o">::</span><span class="n">add</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">その他のファイル情報を取得する</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">file_size</span></code> は指定パスにある通常ファイルのサイズをバイト単位で返す。パスがシンボリックリンクの場合は、実体のサイズを返す。ディレクトリーなど、それら以外の場合は結果は実装定義とされる。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">space</span></code> は指定パスに関する利用可能な空き容量を返す。戻り値は次の構造体オブジェクトだ：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">space_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="kt">uintmax_t</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="kt">uintmax_t</span><span class="w"> </span><span class="n">free</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="kt">uintmax_t</span><span class="w"> </span><span class="n">available</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>関数 <code class="docutils literal notranslate"><span class="pre">last_write_time</span></code> は指定ファイルのおそらく mtime を取得または変更する。</p>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>後者の操作については、時刻の指定方法を別途習わねばならない。</p>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">ディレクトリー内のファイルを一つ一つ処理する</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>ディレクトリーを指定してファイルを訪問するための反復子クラスが二つ用意されている。それぞれの違いは名前のとおりであるので述べない。</p>
<figure class="align-center" id="id17">
<div class="mermaid">
            flowchart LR
  subgraph Iterators[iterator classes]
    direction LR
    directory_iterator
    recursive_directory_iterator
  end
Iterators -.-&gt; path &amp; directory_entry &amp; directory_options
directory_entry -.-&gt; path &amp; file_status
        </div><figcaption>
<p><span class="caption-text">Dependency of iterator classes</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>オブジェクトをいったん生成すると、<code class="docutils literal notranslate"><span class="pre">for</span></code> ループで関連ファイルにアクセスするという装置だ。オブジェクトはコンストラクターを直接呼び出すことで生成する。普通はディレクトリーを指示するパスを指定する。オプションとして次の列挙型の値を与えてもよい：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">directory_options</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">none</span><span class="p">,</span>
<span class="w">    </span><span class="n">follow_directory_symlink</span><span class="p">,</span>
<span class="w">    </span><span class="n">skip_permission_denied</span>
<span class="p">};</span>
</pre></div>
</div>
<p>反復子はクラス <code class="docutils literal notranslate"><span class="pre">directory_entry</span></code> のオブジェクトを指す。メンバーとしてパスを格納し、ディレクトリーの反復中にファイル属性（ハードリンク数、ステータス、シンボリックリンク、ファイルサイズ、最終書き込み時間）を追加的に格納することもできる。例コードを引用する：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">path</span><span class="w"> </span><span class="n">sandbox</span><span class="w"> </span><span class="cm">/* = ... */</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">recursive_directory_iterator</span><span class="p">{</span><span class="n">sandbox</span><span class="p">})</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">process_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p><code class="docutils literal notranslate"><span class="pre">recursive_directory_entry</span></code> の訪問順序は DFS とも BFS とも指定されていない。内容物それぞれがただ一度ずつ訪問されることしか指定されていない。</p>
</div>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">ファイルの存在を確かめる</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">exists</span></code> は指定されたパス（または <code class="docutils literal notranslate"><span class="pre">file_status</span></code> 値）がファイルシステムの既存ファイルに対応するかどうかを <code class="docutils literal notranslate"><span class="pre">bool</span></code> 値で返す。</p>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">ファイル種別が特定のものであるかどうかを確かめる</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<p>対象となるファイルを <code class="docutils literal notranslate"><span class="pre">path</span></code> または <code class="docutils literal notranslate"><span class="pre">file_status</span></code> オブジェクトとして持っているならば、そのファイルを次の関数の引数に与えて呼び出すことで述語判定できる：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">is_regular_file</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_directory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_symlink</span></code></p></li>
<li><p>etc.</p></li>
</ul>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>一連の判定関数は実践的には例外を送出しないと考えられるが、関数署名上
<code class="docutils literal notranslate"><span class="pre">noexcept</span></code> 修飾がないオーバーロードがあることを心に留めておく？</p>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">ファイル作成</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<p>まず、通常ファイルを作成するには従来どおり <code class="docutils literal notranslate"><span class="pre">std::ofstream</span></code> が使えることに注意する。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">create_directory</span></code> または <code class="docutils literal notranslate"><span class="pre">create_directories</span></code> はパスを与えてディレクトリーを新規作成する。いずれもシェルコマンド <strong class="command">mkdir -p</strong> のように振る舞うと読める。既存のパスを引数に取るオーバーロードもあり、それらは属性を複製するためのものだ。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">create_symlink</span></code> と <code class="docutils literal notranslate"><span class="pre">create_directory_symlink</span></code> はシェルコマンド
<strong class="command">ln -s</strong> のように振る舞う。対象がディレクトリーであるか否かを気にする OS
向けにこれらの関数が用意されている。</p>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">ファイル複製</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">copy</span></code> はファイルとディレクトリーを複製する。一方、関数 <code class="docutils literal notranslate"><span class="pre">copy_file</span></code> は単一ファイルの内容を複製する。列挙型 <code class="docutils literal notranslate"><span class="pre">copy_options</span></code> を組み合わせてオプションを指定することが可能なオーバーロードもある。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">copy_symlink</span></code> はシンボリックリンクをシンボリックリンクとして複製する。関数 <code class="docutils literal notranslate"><span class="pre">create_symlink</span></code> や <code class="docutils literal notranslate"><span class="pre">create_directory_symlink</span></code> を使い分けることなく呼び出せる利点がある。</p>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">ファイル移動</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">rename</span></code> はシェルコマンド <strong class="command">mv old new</strong> のように振る舞う。シンボリックリンクに対しては、それ自身の名前を変えるように動作し、対象は変わらない。</p>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">ファイル削除</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<p>関数 <code class="docutils literal notranslate"><span class="pre">remove</span></code> はファイルまたは空ディレクトリーをファイルシステムから削除する。シェルコマンドの <strong class="command">rm filepath</strong> や <strong class="command">rmdir dirpath</strong> に相当する。</p>
<p>関数 <code class="docutils literal notranslate"><span class="pre">remove_all</span></code> はディレクトリーを指定する場合、それとそのすべてのサブディレクトリーの内容を再帰的に削除する。シェルコマンドの <strong class="command">rm -r dirpath</strong> 相当。</p>
<p>これらの関数のいずれもシンボリックリンクはそれ自身に作用し、リンク対象を削除するものではない。</p>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">異常時処理</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>節の最後になったが、操作時に異常が発生したときの関数の振る舞いについてまとめておく。<code class="docutils literal notranslate"><span class="pre">std::filesystem</span></code> にある失敗する可能性のある関数のすべてに対して、次の性質を持つオーバーロードのペアが用意されている：</p>
<ol class="arabic simple">
<li><p>失敗時に例外 <code class="docutils literal notranslate"><span class="pre">std::filesystem_error</span></code> オブジェクトを送出するもの</p></li>
<li><p>失敗時に関数呼び出し時に参照渡しをされた <code class="docutils literal notranslate"><span class="pre">std::error_code</span></code> オブジェクトにエラーを報告するもの</p></li>
</ol>
<p>後者の関数は前者が送出する型ではない型の例外オブジェクトを送出するものとしないものがある。パスを扱う関係で <code class="docutils literal notranslate"><span class="pre">std::bad_alloc</span></code> を送出する可能性がある。</p>
</section>
</section>
<section id="further-readings">
<h2><a class="toc-backref" href="#id35" role="doc-backlink">Further Readings</a><a class="headerlink" href="#further-readings" title="Permalink to this heading">¶</a></h2>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<dl class="simple">
<dt><a class="reference external" href="https://en.cppreference.com/w/cpp/filesystem">Filesystem library (since C++17) - cppreference.com</a></dt><dd><p>この資料からとりあえず学ぶ。</p>
</dd>
</dl>
</div>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="chapter07.html" title="Previous document">Chapter 07: Parallelism and Concurrency</a>
        </li>
        <li>
          <a href="chapter09.html" title="Next document">Chapter 09: Minor Features</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
      </div>
      <div class="clearer"></div>
    </div>
<div class="footer">
  <ul>
    <li id="footer_logo">
      <a class="image-reference" href="https://showa-yojyo.github.io/" title="プレハブ小屋 Since 1999"><img src="../_static/logos.png"/></a>
    </li>
    <li id="footer_copyright">
      Copyright &copy; 1999-2023, プレハブ小屋 All rights reserved.
    </li>
  </ul>
</div>
  </body>
</html>