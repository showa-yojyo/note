
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>ffmpeg ノート &#8212; 読書ノート 1.5dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/mermaid.js"></script>
    <link rel="next" title="フィルターノート" href="filters.html" />
    <link rel="prev" title="ffplay ノート" href="ffplay.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="ffplay.html" title="Previous document"><strong class="program">ffplay</strong> ノート</a>
        </li>
        <li>
          <a href="filters.html" title="Next document">フィルターノート</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section id="ffmpeg">
<h1><a class="toc-backref" href="#id17" role="doc-backlink"><strong class="program">ffmpeg</strong> ノート</a><a class="headerlink" href="#ffmpeg" title="Permalink to this heading">¶</a></h1>
<p><strong class="program">ffmpeg</strong> のマニュアルを読み取る。コマンドパイプラインの構造、フィルターグラフ、ストリーム選択の仕組みについて述べる。また、ここで述べる事実には
<strong class="program">ffplay</strong> と共通するものがある。</p>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ffmpeg" id="id17"><strong class="program">ffmpeg</strong> ノート</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id18">コマンドの構造</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id19">フィルターグラフ</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id20">単純フィルターグラフ</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id21">複雑フィルターグラフ</a></p></li>
<li><p><a class="reference internal" href="#copy" id="id22">ストリーム <code class="docutils literal notranslate"><span class="pre">copy</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id23">ストリーム選択</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id24">自動ストリーム選択</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id25">手動ストリーム選択</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id26">複雑フィルターグラフ</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id27">ストリーム処理</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id28">ストリーム選択の例</a></p>
<ul>
<li><p><a class="reference internal" href="#id12" id="id29">自動ストリーム選択の例</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id30">自動字幕選択の例</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id31">ラベルなしフィルターグラフ出力の例</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id32">ラベルありフィルターグラフ出力の例</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="id1">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">コマンドの構造</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p><strong class="program">ffmpeg</strong> のコマンドラインの書式は次のように定められている：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ffmpeg [global_options] {[input_file_options] -i input_url} ... {[output_file_options] output_url} ...
</pre></div>
</div>
<p>要点はこういう感じだろうか：</p>
<ul class="simple">
<li><p>全体オプション、入力、出力の順番に指定する必要がある。</p></li>
<li><p>入力も出力も複数指定することが可能だ。</p></li>
<li><p>入力も出力もファイルシステムのパスでもインターネット上の URL でもいい。</p></li>
<li><p>入力ファイルそれぞれの直前に <code class="docutils literal notranslate"><span class="pre">-i</span></code> を明示する必要がある。一方、出力ファイルにはそのようなものがない。</p></li>
</ul>
<p>コマンド処理のパイプラインは次のグラフのように表される：</p>
<div class="mermaid">
            flowchart LR
  input[input]
  epackets[encoded\ndata\npackets]
  frames[frames]
  dpackets[decoded\ndata\npackets]
  output[output]

  input --demuxer--&gt; epackets
  epackets --decoder--&gt; frames --encoder--&gt; dpackets
  dpackets --muxer--&gt; output
        </div><ol class="arabic simple">
<li><p><strong class="program">ffmpeg</strong> は libavformat ライブラリーを呼び出して入力ファイルを読み、それらからエンコードされたデータを含むパケットを得る。入力ファイルが複数ある場合もある。</p></li>
<li><p>エンコード済みパケットは、decoder に渡される。非圧縮フレームを生成し、フィルターによってさらに処理することができる。</p></li>
<li><p>フィルターの後、フレームは encoder に渡され、それらをエンコードし、エンコード済みパケットを出力する。</p></li>
<li><p>最後に、エンコード済みパケットは muxer に渡され、出力ファイルに書き出される。</p></li>
</ol>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">フィルターグラフ</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<p>エンコードする前に libavfilter ライブラリーのフィルターを使って生の音声・映像フレームを処理することができる。フィルターの連鎖がフィルターグラフを形成する。<strong class="program">ffmpeg</strong> はフィルターグラフを simple と complex の二種類に分類して扱う。利用者の立場からするとコマンドラインの書き方が変わってくる。後者のほうが文字通り複雑になる。</p>
<section id="id3">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">単純フィルターグラフ</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>入力と出力がそれぞれ一つずつあり、両方とも同じ型であるフィルターグラフを単純フィルターグラフ (simple graph) という。最初の図における decode と encode の間に段階を追加するだけで、それを表現することができる。</p>
<div class="mermaid">
            flowchart LR
  frames --simple filtergraph --&gt; filtered\nframes -- encoder --&gt; encoded\ndata\npackets
        </div><p>単純フィルターグラフは、ストリームごとにオプション <code class="docutils literal notranslate"><span class="pre">-filter</span></code> で設定する。次のような別名もあるので覚えておく：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-filter:v</span></code>, <code class="docutils literal notranslate"><span class="pre">-vf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-filter:a</span></code>, <code class="docutils literal notranslate"><span class="pre">-af</span></code></p></li>
</ul>
<p>例えば次のようなコマンドでは、オプション <code class="docutils literal notranslate"><span class="pre">-vf</span> <span class="pre">yadif,scale=256:224</span></code> 部分が単純フィルターグラフを構成している：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i input.mp4 -vf yadif,scale=256:224 output.mp4</span>
</pre></div>
</div>
<p>ここでは映像フィルター <code class="docutils literal notranslate"><span class="pre">yadif</span></code> と <code class="docutils literal notranslate"><span class="pre">scale</span></code> を順番に適用している。カンマ <code class="docutils literal notranslate"><span class="pre">,</span></code>
でフィルターを区切って列挙するだけでいい。各フィルターには固有の引数を与えることもある（この例では <code class="docutils literal notranslate"><span class="pre">scale</span></code> でそうしている）。どのフィルターオプションにおいても次の書式になると思っていい：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>filtername=param1=arg1:param2=arg2:...
filtername=arg1:arg2:...
</pre></div>
</div>
<p>このコマンドを図式化したものを記す：</p>
<div class="mermaid">
            flowchart LR
  input --&gt; yadif --&gt; scale --&gt; output
        </div><p>フレームのプロパティーを変更するフィルターもあるが、普通はフレームの内容には触れない。例えば、フィルター <code class="docutils literal notranslate"><span class="pre">fps</span></code> はフレーム数を変更するものの、その内容には触れない。もう一つの例はフィルター <code class="docutils literal notranslate"><span class="pre">setpts</span></code> だ。これはタイムスタンプを設定するだけで、それ以外はフレームを変更せずに通過させる。</p>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">複雑フィルターグラフ</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>入出力ストリームが複数あり得るものを複雑フィルターグラフ (complex filtergraph)
という。模式的に書くと例えば：</p>
<div class="mermaid">
            flowchart LR
  input0 --&gt; complex\nfilter\ngraph --&gt; output0
  input1 --&gt; complex\nfilter\ngraph --&gt; output1
  input2 --&gt; complex\nfilter\ngraph
        </div><p>複雑フィルターグラフはオプション <code class="docutils literal notranslate"><span class="pre">-filter_complex</span></code> で構成する。その性質上、単一ストリームやファイルに一義的に関連付けることができないため、このオプションは
global だ。</p>
<p>オプション <code class="docutils literal notranslate"><span class="pre">-lavfi</span></code> は <code class="docutils literal notranslate"><span class="pre">-filter_complex</span></code> と同じだ。</p>
<p>複雑なフィルターグラフの明らかな例はフィルター <code class="docutils literal notranslate"><span class="pre">overlay</span></code> だ。二つのビデオ入力と一つのビデオ出力を持ち、一方のビデオが他方のビデオの上に重なっているものだ。その音声版に相当するのがフィルター <code class="docutils literal notranslate"><span class="pre">amix</span></code> だ。例については別途述べる。</p>
</section>
<section id="copy">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">ストリーム <code class="docutils literal notranslate"><span class="pre">copy</span></code></a><a class="headerlink" href="#copy" title="Permalink to this heading">¶</a></h3>
<p>ストリームコピーとはオプション <code class="docutils literal notranslate"><span class="pre">-codec:</span> <span class="pre">copy</span></code> で機能するモードだ。意味としては基本図式の decoder と encoder の段階を省き、demuxer と muxer のみを機能させるということだ。用途としては、コンテナー形式を変換したり、コンテナーレベルのメタデータを変更したりするものだ。この状況での <strong class="program">ffmpeg</strong> コマンドパイプラインの基本図式は次のように単純になる：</p>
<div class="mermaid">
            flowchart LR
  input -- demuxer --&gt; encoded\ndata\npackets --muxer--&gt; output
        </div><p>符号化や復号化処理がないため、たいへん高速で品質劣化もない。フィルターを適用することは当然不可能だ（フィルターは非圧縮データに対して機能するものだ）。</p>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id23" role="doc-backlink">ストリーム選択</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<p>オプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> の値として指定する記号を理解するのにこの知識が要る。</p>
<p><strong class="program">ffmpeg</strong> には各出力ファイルのストリーム選択を手動で制御するためのオプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> がある。しかし、利用者は <code class="docutils literal notranslate"><span class="pre">-map</span></code> を明示的に与えるのを省略して、以下に述べられるように <strong class="program">ffmpeg</strong> 自身にストリームを自動的に選択させることができる。オプション</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-vn</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-an</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-sn</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-dn</span></code></p></li>
</ul>
<p>は、複雑なフィルタグラフー出力であるストリームを除き、手動で <code class="docutils literal notranslate"><span class="pre">-map</span></code> されたか自動的に選択されたかにかかわらず、映像、音声、字幕、データストリームを含めるのを省略するのに使用できる。例えば <code class="docutils literal notranslate"><span class="pre">-vn</span></code> を与えると、入力映像ストリームを一切無視する。</p>
<section id="id6">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">自動ストリーム選択</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>特定の出力ファイルにオプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> がない場合、<strong class="program">ffmpeg</strong> は出力フォーマットを検査し、映像、音声、字幕など、どの種類のストリームを含められるかを検査する。許容されるストリーム種別ごとに、入力すべてから一つのストリームを（利用可能である限り）選択する。</p>
<p>ストリーム選択基準は次に基づく：</p>
<ul class="simple">
<li><p>映像は最も解像度の高いストリーム</p></li>
<li><p>音声は最も多くのチャンネルを含むストリーム</p></li>
<li><p>字幕は、最初に発見した副字幕ストリームになる。注意：出力形式の既定の字幕エンコーダーは、文字ベースか画像ベースのどちらかで、同じ種類の字幕ストリームだけが選択される。</p></li>
</ul>
<p>同種のストリームで等しく評価されるものが複数ある場合、最低インデックスストリームが選択される。</p>
<p>データまたは添付ストリームに関しては自動的に選択されることはない。オプション
<code class="docutils literal notranslate"><span class="pre">-map</span></code> 指定時にしか採用されない。</p>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">手動ストリーム選択</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h3>
<p>オプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> が使用された場合、ユーザーマップストリームしか出力ファイルに含まれない。ただし、以下で述べられるフィルターグラフ出力に関する例外がある。</p>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">複雑フィルターグラフ</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<p>ラベルのないパッドを持つ複雑なフィルターグラフ出力ストリームがある場合、それらは最初の出力ファイルに追加される。これは、そのストリーム種別が出力フォーマットで対応されていない場合、致命的なエラーになる。</p>
<ul class="simple">
<li><p>オプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> がない場合、これらのストリームを含めると、その種別のストリーム自動選択が飛ばされることになる。</p></li>
<li><p>オプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> が存在する場合、マップされたストリームに加えて、これらのフィルターグラフストリームが含まれる。</p></li>
</ul>
<p>ラベル付きパッドを持つ複雑なフィルターグラフ出力ストリームは、一度だけ、正確にマップされなければならない。</p>
<div class="admonition-todo admonition" id="id9">
<p class="admonition-title">Todo</p>
<p>パッドとは？</p>
</div>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">ストリーム処理</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>ストリーム処理はストリーム選択に依存しない（例外は字幕）。ストリーム処理は、特定の出力ファイル内のストリームに指定されたオプション <code class="docutils literal notranslate"><span class="pre">-codec</span></code> によって設定される。特に、当オプションはストリーム選択処理の後に <strong class="program">ffmpeg</strong> が適用するため、後者に影響を与えない。オプション <code class="docutils literal notranslate"><span class="pre">-codec</span></code> が指定されていないストリーム種別に対しては、<strong class="program">ffmpeg</strong> は出力ファイルの muxer によって登録された既定の
encoder を選択する。</p>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id28" role="doc-backlink">ストリーム選択の例</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>以降の例は <strong class="program">ffmpeg</strong> のストリーム選択方法の動作、癖、制限を説明するためのものだ。いずれも次のような入力ファイルがあるとする。この三つすべてを入力とする：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>input file &#39;A.avi&#39;
    stream 0: video 640x360
    stream 1: audio 2 channels
input file &#39;B.mp4&#39;
    stream 0: video 1920x1080
    stream 1: audio 2 channels
    stream 2: subtitles (text)
    stream 3: audio 5.1 channels
    stream 4: subtitles (text)
input file &#39;C.mkv&#39;
    stream 0: video 1280x720
    stream 1: audio 2 channels
    stream 2: subtitles (image)
</pre></div>
</div>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>このような情報はファイルに対して <strong class="program">ffprobe</strong> を実行すれば確認できる。
<a class="reference internal" href="ffprobe.html"><span class="doc">ffprobe ノート</span></a> 参照。</p>
</div>
<section id="id12">
<h4><a class="toc-backref" href="#id29" role="doc-backlink">自動ストリーム選択の例</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i A.avi -i B.mp4 \</span>
<span class="go">  out1.mkv \</span>
<span class="go">  out2.wav \</span>
<span class="go">  -map 1:a -c:a copy out3.mov</span>
</pre></div>
</div>
<p>出力ファイルは三つ指定されている。最初の二つ <code class="file docutils literal notranslate"><span class="pre">out1.mkv</span></code>, <code class="file docutils literal notranslate"><span class="pre">out2.wav</span></code>
はオプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> がないので、これらのファイルストリームを <strong class="program">ffmpeg</strong>
自身が決定する。</p>
<p>出力ファイル <code class="file docutils literal notranslate"><span class="pre">out1.mkv</span></code> はコンテナーファイルで、映像、音声、字幕のストリームを受け付ける。よって、<strong class="program">ffmpeg</strong> は各種別の一つを選択しようとする：</p>
<ul class="simple">
<li><p>映像：すべての入力映像ストリームの中で最も解像度の高いものは <code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> のストリーム 0 であるので、それを選択する。</p></li>
<li><p>音声：チャンネル数が最も多い <code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> からストリーム 3 を選択する。</p></li>
<li><p>字幕：<code class="file docutils literal notranslate"><span class="pre">A.avi</span></code> と <code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> のうち最初の字幕ストリームである
<code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> からストリーム 2 を選択する。</p></li>
</ul>
<p>出力ファイル <code class="file docutils literal notranslate"><span class="pre">out2.wav</span></code> は音声ストリームのみを受け付ける形式なので、<code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> のストリーム 3 のみが選択される。</p>
<p>出力ファイル <code class="file docutils literal notranslate"><span class="pre">out3.mov</span></code> ではオプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> が設定されているため、ストリーム自動選択は行われない。オプション <code class="docutils literal notranslate"><span class="pre">-map</span> <span class="pre">1:a</span></code> により、二番目（序数はゼロから）の入力である <code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> から音声ストリームのすべてがオプション
<code class="file docutils literal notranslate"><span class="pre">-c:a</span> <span class="pre">copy</span></code> 指定により選択される。この出力ファイルは、これ以外のどのストリームも含まない。</p>
<p>最初の二つの出力では、含まれるストリームのすべてが transcode される。選択される
encoder は各出力フォーマットで登録された既定のもので、選択された入力ストリームの
codec と一致しない場合がある。</p>
<p>三番目の出力では、音声ストリームの <code class="docutils literal notranslate"><span class="pre">-codec</span></code> オプションが <code class="docutils literal notranslate"><span class="pre">copy</span></code> に設定されているため、decoding - filtering - encoding の処理は発生しないはずだが、その可能性はある。選択ストリームパケットは入力ファイルから伝達されて、出力ファイル内で混合されなければならない。</p>
</section>
<section id="id13">
<h4><a class="toc-backref" href="#id30" role="doc-backlink">自動字幕選択の例</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i C.mkv out1.mkv -c:s dvdsub -an out2.mkv</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">out1.mkv</span></code> は字幕ストリームも受け入れる Matroska コンテナーファイルだが、映像と音声のストリームのみが選択されなければならないものとする。<code class="file docutils literal notranslate"><span class="pre">C.mkv</span></code> の字幕ストリームは画像ベースであり、Matroska muxer の既定の字幕 encoder はテキストベースなので、字幕の transcode 操作は失敗すると予想され、したがってストリームは選択されないのだ。</p>
<div class="admonition- admonition">
<p class="admonition-title">読者ノート</p>
<p>ここでは字幕コピーオプションを明示しないと失敗する挙動を逆用しているということ。</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-c:s dvdsub -an out2.mkv
</pre></div>
</div>
<p>一方、<code class="file docutils literal notranslate"><span class="pre">out2.mkv</span></code> ではコマンドに字幕 encoder が指定されている (<code class="docutils literal notranslate"><span class="pre">-c:s</span>
<span class="pre">dvdsub</span></code>) ので、映像ストリームに加えて、字幕ストリームが選択される。音声ストリームは <code class="docutils literal notranslate"><span class="pre">-an</span></code> を指定してあるので含まれない。</p>
</section>
<section id="id14">
<h4><a class="toc-backref" href="#id31" role="doc-backlink">ラベルなしフィルターグラフ出力の例</a><a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i A.avi -i C.mkv -i B.mp4 \</span>
<span class="go">  -filter_complex &quot;overlay&quot; \</span>
<span class="go">  out1.mp4 out2.srt</span>
</pre></div>
</div>
<p>オプション <code class="docutils literal notranslate"><span class="pre">-filter_complex</span></code> を使って、単一の映像フィルターからなるフィルターグラフを設定している。フィルター <code class="docutils literal notranslate"><span class="pre">overlay</span></code> は、ちょうど二つの映像入力を必要とするものだが、何も指定されていないので、最初に利用可能な映像ストリーム二つ、
<code class="file docutils literal notranslate"><span class="pre">A.avi</span></code> と <code class="file docutils literal notranslate"><span class="pre">C.mkv</span></code> が選ばれる。</p>
<p>フィルターの出力パッドにはラベルがないので、最初の出力ファイル <code class="file docutils literal notranslate"><span class="pre">out1.mp4</span></code>
に送られる。このため、映像ストリームの自動選択は飛ばされ、<code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> のストリームが選択されるはずだった。音声ストリームは、<code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> のストリーム 3 など、最も多くのチャンネルを持つストリームが自動選択される。しかし、MP4 形式には既定の字幕 encoder が登録されておらず、利用者が字幕 encoder を指定していないため、字幕ストリームは選択されない。</p>
<div class="admonition-todo admonition" id="id15">
<p class="admonition-title">Todo</p>
<p>パッドが何を指すのかわからない。</p>
</div>
<p>2 番目の出力ファイルである <code class="file docutils literal notranslate"><span class="pre">out2.srt</span></code> は、文字ベースの字幕ストリームのみを受け付ける。したがって、最初に利用可能な字幕ストリームは <code class="file docutils literal notranslate"><span class="pre">C.mkv</span></code> にあるが、それは画像ベースであるため無視される（さっきと同じ理由）。選択ストリームである <code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> のストリーム 2 は、最初の文字ベースの字幕ストリームだ。</p>
</section>
<section id="id16">
<h4><a class="toc-backref" href="#id32" role="doc-backlink">ラベルありフィルターグラフ出力の例</a><a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i A.avi -i B.mp4 -i C.mkv \</span>
<span class="go">    -filter_complex &quot;[1:v]hue=s=0[outv];overlay;aresample&quot; \</span>
<span class="go">    -map &#39;[outv]&#39; -an        out1.mp4 \</span>
<span class="go">                             out2.mkv \</span>
<span class="go">    -map &#39;[outv]&#39; -map 1:a:0 out3.mkv</span>
</pre></div>
</div>
<p>ラベル <code class="docutils literal notranslate"><span class="pre">[outv]</span></code> の付いた出力パッドが二度 <code class="docutils literal notranslate"><span class="pre">-map</span></code> されているので、上記のコマンドは失敗する。どの出力ファイルも処理されない。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i A.avi -i B.mp4 -i C.mkv \</span>
<span class="go">    -filter_complex &quot;[1:v]hue=s=0[outv];overlay;aresample&quot; \</span>
<span class="go">    -an        out1.mp4 \</span>
<span class="go">               out2.mkv \</span>
<span class="go">    -map 1:a:0 out3.mkv</span>
</pre></div>
</div>
<p>上記のコマンドも失敗する。フィルター <code class="docutils literal notranslate"><span class="pre">hue</span></code> の出力は <code class="docutils literal notranslate"><span class="pre">[outv]</span></code> というラベルがありながら、どこにも <code class="docutils literal notranslate"><span class="pre">-map</span></code> されていない。次が修正済みコマンドだ：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bash$ ffmpeg -i A.avi -i B.mp4 -i C.mkv \</span>
<span class="go">    -filter_complex &quot;[1:v]hue=s=0,split=2[outv1][outv2];overlay;aresample&quot; \</span>
<span class="go">    -map &#39;[outv1]&#39; -an        out1.mp4 \</span>
<span class="go">                              out2.mkv \</span>
<span class="go">    -map &#39;[outv2]&#39; -map 1:a:0 out3.mkv</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">[1:v]</span></code> 指定により、<code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> の映像ストリームはフィルター <code class="docutils literal notranslate"><span class="pre">hue</span></code> に送られ、その出力はフィルター <code class="docutils literal notranslate"><span class="pre">split</span></code> でいったん複製され、双方の出力にラベルが付けられる。そして、複製のそれぞれが出力ファイル <code class="file docutils literal notranslate"><span class="pre">out1.mp4</span></code>, <code class="file docutils literal notranslate"><span class="pre">out3.mkv</span></code>
それぞれに <code class="docutils literal notranslate"><span class="pre">-map</span></code> される。</p>
<p>フィルター <code class="docutils literal notranslate"><span class="pre">overlay</span></code> は、映像入力を二つ必要とし、最初の未使用の映像ストリーム二つを使用する。ここでは <code class="file docutils literal notranslate"><span class="pre">A.avi</span></code> と <code class="file docutils literal notranslate"><span class="pre">C.mkv</span></code> のストリームだ。<code class="docutils literal notranslate"><span class="pre">overlay</span></code> 出力はラベルが付いていないので、オプション <code class="docutils literal notranslate"><span class="pre">-map</span></code> の有無にかかわらず、最初の出力ファイル <code class="file docutils literal notranslate"><span class="pre">out1.mp4</span></code> に送信される。</p>
<p>フィルター <code class="docutils literal notranslate"><span class="pre">aresample</span></code> は、最初の未使用の音声ストリーム <code class="file docutils literal notranslate"><span class="pre">A.avi</span></code> を送信する。このフィルター出力もラベルが付いていないため、最初の出力ファイルに
<code class="file docutils literal notranslate"><span class="pre">-map</span></code> される。オプション <code class="file docutils literal notranslate"><span class="pre">-an</span></code> は音声ストリームの自動的または手動的なストリーム選択を無効にするだけで、フィルターグラフから送信される出力は抑制しない。マップされたストリームはどちらも <code class="file docutils literal notranslate"><span class="pre">out1.mp4</span></code> の <code class="docutils literal notranslate"><span class="pre">-map</span></code> されたストリームの前に並べられる（この説明の最後に注意）。</p>
<p><code class="file docutils literal notranslate"><span class="pre">out2.mkv</span></code> に <code class="docutils literal notranslate"><span class="pre">-map</span></code> される映像、音声、字幕ストリームは（出力オプションが何もないので）すべて自動選択によって決定する。</p>
<p><code class="file docutils literal notranslate"><span class="pre">out3.mkv</span></code> はフィルター <code class="docutils literal notranslate"><span class="pre">hue</span></code> から出力された複製映像 (<code class="docutils literal notranslate"><span class="pre">[outv2]</span></code>) と、
<code class="file docutils literal notranslate"><span class="pre">B.mp4</span></code> の最初の音声ストリーム (<code class="docutils literal notranslate"><span class="pre">-map</span> <span class="pre">1:a:0</span></code>) から構成されている。</p>
<p>問題：では <code class="file docutils literal notranslate"><span class="pre">out2.mkv</span></code> の映像ストリームの具体的な内容は？</p>
</section>
</section>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="ffplay.html" title="Previous document"><strong class="program">ffplay</strong> ノート</a>
        </li>
        <li>
          <a href="filters.html" title="Next document">フィルターノート</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">読書ノート</a></h1>



<p class="blurb">個人的な読書、学習、研究ノート。</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mathseminar72.html">数学 100 の発見 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gamma95/index.html">オブジェクト指向における再利用のためのデザインパターン改訂版 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hunt00/index.html">達人プログラマー 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sutter00.html">Exceptional C++ 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alexandrescu01/index.html">Modern C++ Design 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meyers01.html">Effective STL 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sutter02.html">More Exceptional C++ 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../joel04/index.html">Joel on Software 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../graham04.html">ハッカーと画家 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../angel05/index.html">OpenGL: A Primer Second Edition 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yamamoto05/index.html">入門 xyzzy 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../newham05/index.html">入門 bash 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tsuboi05/index.html">幾何学 I 多様体入門 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../subramaniam06.html">アジャイルプラクティス 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../asaoka06.html">SE・製造技術者・理工系学生のための技術文書の作り方・書き方 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../levin06/index.html">Shaping Functions 学習ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tsuboi08/index.html">幾何学 III 微分形式 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../loeliger09.html">実用 Git 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../griffiths10.html">プログラミング C# 第 6 版 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onodera10.html">ORACLE MASTER Bronze 11g SQL 基礎 I 必修教本 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hosoda10/index.html">Python 入門［２＆３対応］読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nishiyama12/index.html">幾何学と不変量 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../omg15/index.html">Unified Modeling Language 2.5 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gorelick14.html">ハイパフォーマンス Python 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stroustrup14.html">C++ のエッセンス 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stepanov15.html">その数式、プログラムできますか？ 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../khronos15/index.html">WebGL Specification 1.0 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vivo15/index.html">The Book of Shaders 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../saha16.html">Python からはじめる数学入門 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../slatkin16.html">Effective Python 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guntheroth16.html">Optimized C++ 下読みノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../speinellis17.html">Effective Debugging 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bancila18.html">Modern C++ チャレンジ 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../haverbeke18/index.html">Eloquent JavaScript 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../khronos18/index.html">OpenGL Shading Language 4.60 Specification 読書ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kantor22/index.html">The Modern JavaScript Tutorial 読書ノート</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preliminary2014.html">ノート準備中書籍群 2014 年編</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preliminary2015.html">ノート準備中書籍群 2015 年編</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preliminary2016.html">ノート準備中書籍群 2016 年編</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preliminary2017.html">ノート準備中書籍群 2017 年編</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preliminary2018.html">ノート準備中書籍群 2018 年編</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bash-v2.html">What’s New In Bash 2 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bash-v3.html">What’s New In Bash 3 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bash-v4.html">What’s New In Bash 4 ノート</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cpp11/index.html">What’s New In C++11 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpp14/index.html">What’s New In C++14 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpp17/index.html">What’s New In C++17 ノート</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python-3.0.html">What’s New In Python 3.0 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.1.html">What’s New In Python 3.1 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.2.html">What’s New In Python 3.2 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.3.html">What’s New In Python 3.3 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.4.html">What’s New In Python 3.4 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.5.html">What’s New In Python 3.5 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.6.html">What’s New In Python 3.6 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.7.html">What’s New In Python 3.7 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.8.html">What’s New In Python 3.8 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.9.html">What’s New In Python 3.9 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-3.10.html">What’s New In Python 3.10 ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pip.html">pip 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pylint.html">Pylint 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-docutils/index.html">Docutils 解読ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-restview.html">Restview 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-nose.html">Nose 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-ipython.html">IPython 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-jupyter.html">Jupyter 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-numpy/index.html">NumPy 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-scipy/index.html">SciPy 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-sympy/index.html">SymPy 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-apgl.html">Another Python Graph Library (APGL) 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pil.html">PIL 利用ノート [obsolete]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pillow.html">Pillow 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-matplotlib/index.html">Matplotlib 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-networkx/index.html">NetworkX 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-quaternion.html">Quaternion 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-jinja2.html">Jinja2 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pygments.html">Pygments 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-bs4.html">BeautifulSoup4 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-selenium.html">Selenium 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-scrapy.html">Scrapy 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-twitter/index.html">Python Twitter Tools 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-isbn-hyphenate.html">isbn-hyphenate 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pyopengl/index.html">PyOpenGL 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pyqt4.html">PyQt4 利用ノート [obsolete]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pyqt5.html">PyQt5 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pandas/index.html">Pandas 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pygame.html">Pygame 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-pytube.html">Pytube 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../youtube-dl.html">youtube-dl 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-py2exe.html">Py2exe 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-upgrade.html">Python 移行ノート [obsolete]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-miniconda.html">Miniconda 利用ノート</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../freeware.html">Windows 用フリーウェア 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../google-ime.html">Google 日本語入力利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deepl-translator.html">DeepL Translator 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../winget.html">Windows Package Manager CLI 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powertoys/index.html">Microsoft PowerToys 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows-terminal.html">Windows Terminal 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wsl.html">Windows Subsystem for Linux 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vscode/index.html">Visual Studio Code 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cygwin.html">Cygwin 利用ノート [obsolete]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chrome.html">Chrome DevTools 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/index.html">Git 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../twitter.html">Twitter 利用ノート [obsolete]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inkscape/index.html">Inkscape 利用ノート</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">FFmpeg 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mathjax.html">MathJax 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../javascript-mermaid/index.html">Mermaid 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../css-selector.html">CSS セレクター学習ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xpath.html">XPath 学習ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hxutils.html">HTML-XML-utils 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webgl.html">WebGL 学習ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pandoc.html">Pandoc 利用ノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zoom.html">Zoom Cloud Meetings 利用ノート</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../milestone09/index.html">ラジルギノア プレイノート</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">FFmpeg 利用ノート</a><ul>
      <li>Previous: <a href="ffplay.html" title="previous chapter"><strong class="program">ffplay</strong> ノート</a></li>
      <li>Next: <a href="filters.html" title="next chapter">フィルターノート</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="footer">
  <ul>
    <li id="footer_logo">
      <a class="image-reference" href="https://showa-yojyo.github.io/" title="プレハブ小屋 Since 1999"><img src="../_static/logos.png"/></a>
    </li>
    <li id="footer_copyright">
      Copyright &copy; 1999-2023, プレハブ小屋 All rights reserved.
    </li>
  </ul>
</div>
  </body>
</html>