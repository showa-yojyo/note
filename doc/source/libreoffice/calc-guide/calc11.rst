======================================================================
Calc Guide Chapter 11 Linking Data ノート
======================================================================

.. include:: ./calc-inc.txt

.. contents:: 章見出し
   :local:

Using multiple sheets
======================================================================

Why use multiple sheets?
----------------------------------------------------------------------

ワークシート同士に何らかの関係が定義されれば、情報表現が強力になるだろう。

今さらだが、Calc がスプレッドシートという術語を用いる場合、それは MS Excel で言
うところのワークブックに対応する概念だ。

Setting up multiple sheets
----------------------------------------------------------------------

スプレッドシートに複数のシートを設定する方法は Chapter 1 で学習した。

Identifying sheets
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

新規スプレッドシートを開くと、:guilabel:`Sheet1` という名前のシートが一枚含まれ
る。この挙動を Calc オプション :menuselection:`LibreOffice Calc --> Defaults` で
変更可能だ：

* 新規文書が含むシートの数
* 新規シートの接頭辞

スプレッドシートの下部にあるタブを使ってシートを管理する。

Inserting new sheets
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

複数ある方法のどれを選ぶかは利用者次第だ。

* シートタブ左の :guilabel:`+` をクリックする
* メニューから :menuselection:`&Sheet --> Insert &Sheet...` を実行する
* メニューから :menuselection:`&Sheet --> Insert Sheet at End` を実行する
* メニューから :menuselection:`&Sheet --> Insert Shee&t from File...` を実行する
* シートタブ右クリックメニューから :menuselection:`Insert &Sheet...` を実行する

これらの方法のうち :guilabel:`Insert Sheet` ダイアログボックスが開くものについて
は、次のオプションを使ってもよい：

* 新規シートの挿入位置を現在シートの前か次のいずれにするか
* 新規シートの枚数
* 新規シートがただ一枚の場合に限り、新規シートの名前

または :guilabel:`Append Sheet` ダイアログボックスが開くものについては、新規シー
トの :guilabel:`&Name` を既定の名前以外のものに指定可能だ。

本文のチュートリアル？は気が向いたら実施すればいい。明らかに容易な課題だ。

Inserting sheets from a different spreadsheet
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

さらに、:guilabel:`Insert Sheet` ダイアログボックスには :guilabel:`&From file` オ
プションがある。シートを追加する手順は：

1. :guilabel:`&Browse...` ボタンを押すとファイルダイアログボックスが開く
2. 別の Calc ファイルなどを選択する
3. シート一覧が現れる
4. 追加するシートを選択する

:guilabel:`&Link` をオンにすると、参照様式がシートのコピーではなくリンクになる。

* 他のスプレッドシートから生きたデータを取り込むことを実現する。
* リンクを更新するには :menuselection:`&Edit --> Lin&ks to External Files...` を
  実行する。
* 自動更新にしたければオプション設定だ。:menuselection:`LibreOffice Calc -->
  General` の :guilabel:`Update links when opening` ラジオボタングループを好みの
  項目に変えろ。

Renaming sheets
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

シートには意味がある名前を与えろ。既存シートの名前を変える方法：

* シートタブをダブルクリックする
* シートタブを :kbd:`Alt` を押しながらクリックする
* シートタブ右クリックメニューから :menuselection:`Rename S&heet...` を実行する
* メニューから :menuselection:`&Sheet --> Rename S&heet...` を実行する

以上のいずれの操作でも :guilabel:`Rename Sheet` ダイアログボックスが開く。ここで
新しい名前を :guilabel:`&Name` 欄に入力しろ。

Referencing other sheets
----------------------------------------------------------------------

他のシートのセルを参照する方法は二つはある：

* キーボードを使って数式を直接入力する
* マウスを使って入力する

Creating the reference with the mouse
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. 参照元セルをクリックする
#. 数式バー左の :guilabel:`+` アイコンをクリックする
#. 参照先セルを含むシートに対するシートタブをクリックする
#. 参照先セルをクリックする
#. 数式バー左の :guilabel:`✓` アイコンをクリックする

Creating the reference with the keyboard
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

マウス操作手順で最終的に参照元セルに現れる数式と同じ文字列をキーボードで直接入力
する。

Protect spreadsheet structure
----------------------------------------------------------------------

文書のシート構成に満足したら、次のシート操作を禁止したい：

* シートを追加
* シートを削除
* シートの順序を変更
* シートの名前を変更

このためには、メニューの :menuselection:`&Tools --> Protect &Spreadsheet
Structure...` を実行して構造を固定する。パスワード入力ダイアログボックスが開く。
パスワードを適当に入力して :guilabel:`&OK` を押す。上記の操作が不可になる。

シート操作を解禁するにはこのコマンドを再度実行し、指定のパスワードを入力して
:guilabel:`&OK` を押す。

Referencing other documents
======================================================================

Creating the reference with the mouse
----------------------------------------------------------------------

マウスを使って参照を作成するには、スプレッドシートを両方開いておく必要がある。

#. 数式を入力するセルを含むほうのスプレッドシートに切り替える。
#. 数式を入力するセルを選択する。
#. 数式バーの左にある :guilabel:`=` アイコンをクリックする。
#. もう一方のスプレッドシートに切り替える。
#. 参照先シートを選択し、参照先セルを選択する。この時点で :kbd:`Enter` を押せば
   確定。
#. 参照元シートに切り替えて数式バーの左にある :guilabel:`✓` アイコンをクリックす
   る。

以上の手順により、セルの内容が適切な参照式になる。

Creating the reference with the keyboard
----------------------------------------------------------------------

参照元セルの内容として、参照先セルに対する参照式を直接入力すればいい。次のような
数式となるはずだ：

   :samp:`='file://{/path/to/ods}'#$'{SheetName}'.CellReference`

Using hyperlinks and URLs
======================================================================

スプレッドシート内から別の場所にジャンプするためにハイパーリンクを使用する。次の
ジャンプ先が実現可能だ：

* 現在のファイルの他の部分
* 別のファイル
* Web ページ

Relative and absolute hyperlinks
----------------------------------------------------------------------

ファイル内ハイパーリンクは相対パスまたは絶対パスのどちらかだ。

* 絶対リンクは対象が移動すると機能しなくなる。
* 相対リンクは開始位置と対象位置が相対的に変わると機能しなくなる。

設定ダイアログの :menuselection:`Load/Save --> General` 以下に関連オプション項目
アリ。

* ファイルリンクには相対リンクを使うのがよい。
* 相対リンクは、作業中のファイルがリンク先と同じドライブにある場合に限り可能。
* Calc は内部的に絶対パス名を使用するので、ハイパーリンク上にマウスポインタを置
  くと、ツールチップには絶対参照が示される。

Creating hyperlinks
----------------------------------------------------------------------

スプレッドシートにハイパーリンクを挿入する方法は複数ある：

* セルまたはセル内のテキストを選択し、またはキャレットを挿入位置に置き、

  * メニューから :menuselection:`&Insert --> Hyperlink...` を実行するか、
  * キーバインド :kbd:`Ctrl` + :kbd:`K` を押して、

  :guilabel:`Hyperlink` ダイアログボックスを開く。
* Navigator ウィンドウ (:kbd:`F5`) からハイパーリンクを挿入したい箇所（シートタ
  ブやセルなど）に項目をドラッグ＆ドロップする。
* ハイパーリンクを挿入する場所に対象の URL を入力する。

入力文字列をハイパーリンク URL として Calc に自動認識させるには、メニューから
:menuselection:`&Tools --> &AutoCorrect Options...` を実行して、ダイアログボック
ス内の :guilabel:`Options` タブで :guilabel:`URL Recognition` をオンにする。

ハイパーリンクの色を変更するには、設定ダイアログ :menuselection:`LibreOffice -->
Application Colors` の次の項目の色を指定しろ：

* Unvisited links
* Visited links

Opening hyperlinks
----------------------------------------------------------------------

ハイパーリンクからジャンプする方法は、ホットテキストの場合は：

* 左クリックか、または :kbd:`Ctrl` を押しながら左クリックのいずれか
* 右クリックメニューから :menuselection:`&Open Hyperlink` を実行する

ことでジャンプする。左クリック絡みは設定ダイアログ :guilabel:`LibreOffice -->
Security` における :guilabel:`Security Options and Warnings` ダイアログボックス
での項目 :guilabel:`Ctrl-click required &to open hyperlinks` の状態によってどち
らの操作が有効であるかが決まる。

ボタンの場合は、Design Mode に入っていない場合には左クリックでジャンプ。Design
Mode へするには、次のいずれかのツールバーの :guilabel:`Design Mode` をオンにす
る：

* :menuselection:`&View --> Toolbars --> For&m Controls`
* :menuselection:`&View --> Toolbars --> Form Desi&gn`

Hyperlink dialog
----------------------------------------------------------------------

:menuselection:`&Insert --> Hyperlink...` 実行などの操作で開くダイアログボックス
の説明。

* 利用しそうなのは :guilabel:`Web` か :guilabel:`Document` しかない。

Editing hyperlinks
----------------------------------------------------------------------

既存のホットテキストに対するハイパーリンクを編集する方法はいくつかある：

* ホットテキストを含むセルをクリックし、:menuselection:`&Insert Hyperlink...` を
  実行するか、同等の操作を行う。
* ホットテキストを選択して右クリックメニュー :menuselection:`&Edit Hyperlink...`
  を実行する。

既存のボタンに対するハイパーリンクの場合、参照先を編集するにはスプレッドシートの
Form Design Mode が有効である必要がある。ボタンを選択した状態で：

* :menuselection:`&Insert Hyperlink...` を実行するか、同等の操作を行う。
* 右クリックメニュー :menuselection:`Con&trol Properties...` を実行し、
  :guilabel:`&Label` にある参照先を表す文字列を変更する。

複数のハイパーリンクを編集する場合、すべてを編集するまで :guilabel:`Hyperlink`
ダイアログボックスを開いたままにしておくことが可能。適宜 :guilabel:`&Apply` ボタ
ンを押せ。

Removing hyperlinks
----------------------------------------------------------------------

ホットテキストの場合は文字列を選択して右クリックメニューから
:menuselection:`&Remove Hyperlink` を実行しろ。ボタンの場合は編集時と同じ。

Linking to external data
======================================================================

他の文書のデータをリンクとしてスプレッドシートに挿入可能。

ファイルに名前付き範囲、データベース範囲、名前付きテーブルなどがあり、リンクした
い範囲やテーブルの名前がわかっている場合は、外部データダイアログを使う方法が早
い。

注意：リンク先のファイルの保存場所によっては、更新処理が完了するまでに数分かかる
ことがある。

Using the External Data dialog
----------------------------------------------------------------------

   The :guilabel:`External Data` dialog inserts data from an HTML, Calc,
   :abbr:`CSV (Comma-Separated Values)`, or Microsoft Excel file into the
   current sheet as a link. Calc utilizes a Web Page Query import filter,
   enabling you to insert tables from HTML documents.

この操作をインポートと便宜上呼ぶことにする。インポートの手順は：

#. 外部データインポート先となる ods ファイルを開く
#. インポート先セル範囲の左上セルを選択する
#. メニューから :menuselection:`&Sheet --> E&xternal Links...` を実行

ここで :guilabel:`External Data` ダイアログボックスが開く。

* :guilabel:`URL of &External Data Source` に場所を入力するか、
* ドロップダウンリストから項目を選択するか、
* :guilabel:`Browse` ボタンからアクセスできるファイル選択ダイアログ

からインポート元を選択しろ。インポート元のデータ種別により、以降 UI の挙動が異な
る。

* HTML ファイルを選択した場合、本書参照。
* CSV ファイルを選択した場合、:guilabel:`Text Import` ダイアログボックスが現れ
  る。Chapter 1 で述べられている手順に合流する。
* Calc または MS Excelファイルを選択した場合、インポート元に定義されている範囲名
  とデータベース範囲の一覧がダイアログの :guilabel:`&Available Tables/Ranges`
  に埋まる。挿入したい項目を選択しろ。

インポートにより、Navigator ウィンドウの :guilabel:`Linked areas` 欄に新しい項目
が追加する。このような項目を

* ダブルクリックするとシート内のリンクされたデータが強調表示される。
* マウスホバーするとツールチップにリンクされたデータのパスが表示される。

スプレッドシート内のすべての外部データリンクを一覧表示するには、メニュー
:menuselection:`&Edit --> Lin&ks to External Files...` を実行する。ダイアログ
ボックス :guilabel:`Edit Links` が開く。一般には、一覧の一部が外部リンクだ。

Using the Navigator
----------------------------------------------------------------------

#. インポート先スプレッドシートを開く。
#. インポート元ファイルを開く（上述のファイル形式が有効）。
#. インポート先で Navigator ウィンドウを開く。:kbd:`F5` 押しが早い。
#. Navigator ウィンドウ下部のドロップダウンリストからインポート元を選択する。
#. 必要な範囲名またはデータベース範囲項目を選択し、Navigator ウィンドウからイン
   ポート先シートにドラッグして、データ範囲の左上のセルに移動する。

How to find the required data range or table
----------------------------------------------------------------------

* :guilabel:`HTML_all`: HTML ファイル全体を指定
* :guilabel:`HTML_tables`: HTML ファイル内のテーブルすべてを指定

``TABLE`` 要素に ``ID`` 属性がある場合、連番を付けた範囲と共に、それらの属性値が
範囲名一覧に表示される。

そういう属性値がないインポート元については強調表示機能頼みになる。

.. admonition:: 読者ノート

   本書の例を真似ても掲載されている画像のようには現在、ならない。

Linking to registered data sources
======================================================================

さまざまなデータベースと Calc 文書をリンク可能だ。それにはまず LibreOffice に
データソースを登録する必要がある。

ODB ファイルを登録する手順は設定ダイアログを用いる。:menuselection:`LibreOffice
Base --> Databases` 内の :guilabel:`Registered databases` 一覧を管理する。
:guilabel:`&New...` ボタンを押してパスと名前の対応を登録する。

ODB ファイル以外のデータ元の登録手順：

#. :menuselection:`&File --> &New --> &Data&base...` を実行
#. :guilabel:`Connect to an &existing database` を選択
#. ドロップダウンリストから所望の項目を選択、:guilabel:`&Next >` を押す。

この後はデータベースの種別により異なるが、最後に :guilabel:`&Finish` を押す。

.. todo::

   データベース利用ノートと関連するので、試す価値はある。

Viewing data sources
----------------------------------------------------------------------

現在スプレッドシートで利用可能なデータ元を閲覧する方法：

:menuselection:`&View --> &Data Sources...` (:kbd:`Ctrl` + :kbd:`Shift` +
:kbd:`F4`) を実行する

これにより Data Sources ウィンドウがスプレッドシート上部に現れる。UI の説明は本文
参照。

* Table Data ツールバー
* Data Source Explorer ウィンドウ
* レコード（表の各行）
* 表示切り替えハンドル（最下部の細い矩形）

Editing data sources
----------------------------------------------------------------------

* Data Sources ウィンドウで編集できるのは、登録済みのデータソースのみ。
* 編集とはレコードの編集、追加、削除操作だ。
* 編集内容を保存できない場合は LibreOffice Base でデータベースを開き、そこで編集
  するしかない。
* 列を非表示にしたり、表示に変更を加えたりすることも可能。

Launching Base to work on data sources
----------------------------------------------------------------------

データベースの右クリックメニューから :menuselection:`Edit &Database File...` を
実行すると LibreOffice Base が起動する。ここで編集しろ。

Using data sources in Calc spreadsheets
----------------------------------------------------------------------

Data Sources ウィンドウの右側に表示されている表のデータは Calc 文書に配置可能
だ。

* レコード全体を選択してシートにドラッグ＆ドロップ（行を行に）
* レコード全体を選択してツールバーの :guilabel:`Data to Text` を実行（任意のセル
  に）

あとはフォームを利用する方法があるがノート割愛。

Embedding spreadsheets
======================================================================

* スプレッドシートを他の LibreOffice ファイルに埋め込むことが可能だ。
* スプレッドシートは :abbr:`OLE (Object Linking and Embedding)` オブジェクトまた
  は :abbr:`DDE (Dynamic Data Exchange)` オブジェクトとして埋め込み可能。

例えば、Calc スプレッドシートが DDE オブジェクトとして Writer 文書に貼り付けられ
ている場合、Writer 文書からスプレッドシートを編集することは不可能だ。ただし、元
スプレッドシートが更新されると Writer 文書で自動的に更新される。

例：スプレッドシートがリンクされた OLE オブジェクトとして Writer 文書に埋め込ま
れた場合、Writer でもスプレッドシートを編集でき、両者が互いに同期する。

Object Linking and Embedding (OLE)
----------------------------------------------------------------------

OLE オブジェクトの主な利点は：

* ダブルクリックするだけでその内容を素早く編集できる。
* オブジェクトへのリンクを挿入することもでき、その場合は図像として表示される。

リンクと埋め込みの差異は、元ファイルのその後の変更に追従するか否かだと思ってよ
い。後者はデータの静的コピーでしかない。

:menuselection:`&Insert --> &OLE Object --> &OLE Object...` を実行すると、スプ
レッドシートを OLE オブジェクトとして埋め込める（これは Calc 以外のアプリケー
ションのメニューから Calc 文書を埋め込むことを想定した説明になっている）。

:guilabel:`Insert OLE Object` ダイアログボックスの動作は UI を見れば自然に理解で
きる。

Other OLE objects
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Windows では :guilabel:`Insert OLE Object` ダイアログで :guilabel:`Create &new`
オプションを選択すると :guilabel:`Object &Type` 一覧に :guilabel:`Further
objects` という項目が追加される。

Non-linked OLE object
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

OLE オブジェクトがリンクされていない場合、新規文書で編集することが可能だ。例え
ば、スプレッドシートを Writer 文書に挿入した場合、基本的に Writer のテーブルと同
じように扱うことが可能だ。ダブルクリックで編集開始。

Linked OLE object
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

同期性を活用するといい。スプレッドシート OLE オブジェクトがリンクされていて、
Writer で変更すると Calc でも変更され、Calc で変更すると Writer でも変更される。
Writer ウィンドウだけを開いていればいいということになる。

ただし、一度に編集できるスプレッドシートのコピーは一つに限られる。複数の文書から
リンクされている場合、残りの文書からは参照先が読み取り専用扱いとなる。

Dynamic Data Exchange (DDE)
----------------------------------------------------------------------

文書 A で選択したデータを、リンクされたオリジナルの生コピーとして文書 B に貼り付
けることができる仕組みが DDE だ。DDE リンクにより、参照先が更新されると参照元も
更新されるため、エラーの可能性が低くなり、参照元文書を最新の状態に保つ作業が軽減
される。

* DDE は OLE の前身に当たる。
* DDE ではオブジェクトはファイル参照を通じてリンクされるが、埋め込まれない。

DDE link in Calc
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:guilabel:`Paste Special` ダイアログボックスの :guilabel:`As &Link` をオンにする
のが本質的だ。参照先セルを含むファイルを開いていないとこの操作ができない。

DDE link in Writer
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Writer で :guilabel:`Paste Special` ダイアログボックスを開き、一覧から
:guilabel:`Dynamic Data Exchange (DDE link)` を選択して :guilabel:`&OK` を押す。

XML Source
======================================================================

:menuselection:`&Data --> &XML Sources...` を実行するとダイアログボックスが開く。
ここで：

#. :guilabel:`Source File` にインポートする XML ファイルのパスを設定する。
#. :guilabel:`Map to Document` 欄にツリーコントロールが現れる。ここからレコード
   単位となるノードを選択する。
#. :guilabel:`&Mapped cell` 欄にスプレッドシートでデータを表示する領域の左上のセ
   ルを指定する。
#. :guilabel:`&Import` を押す。
