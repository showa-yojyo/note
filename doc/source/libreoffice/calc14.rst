======================================================================
Chapter 14 Calc as a Database ノート
======================================================================

.. contents::
   :local:

Introduction
======================================================================

LibreOffice Base 部品は包括的な RDB 機能を有している一方、Calc は単純かつ有能な
データベースのような土台として機能するのに十分な機能を有する。

当初は Calc スプレッドシートでデータを管理し、その後より包括的なデータベースシス
テムを使用することを決めた場合、Calc データを Base へ移行することは容易だ。反対
に、Calc の機能の一部を利用してデータの分析や表現を行いたい Base 利用者にとって
は、Calc 文書からリンクされたデータ範囲の作成、ピボット表分析、図式の原データと
して Base を使用することが可能だ。

A database primer
----------------------------------------------------------------------

一般的なデータベースでは、関連するデータは表に整理され、スプレッドシートに似た格
子状の行と列に配列される。

* 表の各行はデータレコードを表す。
* 表の各列は各レコード内のフィールドを表す。

  * フィールドの各セルは、名前のような個々のデータ項目または属性を含む。
  * 各レコードは、人のような単一の実体に対応する関連属性で構成される。
  * 表一つに対するフィールド数は一定であることが多いが、レコード数は決まっていな
    い。

テーブルには何百、何千という行があるかもしれないが、指定された条件を満たすレコー
ドを検索する情報要求を使って、個々のレコードを簡単に見出し、検索し、更新すること
が可能だ。スプレッドシートに対する利点の一つはこの検索性の良さにある。

本書では成績表を例示して解説している。

LibreOffice Base は完全な機能を備えた RDB システムだが、Calc は RDB モデルに対応
していない。

Calc as a database-like program
----------------------------------------------------------------------

* Calc は平坦な非 RDB 表に似ている。DB 表をシートに含めることも可能だ。
* 幅広いコマンドや関数を用いてデータを深く分析することが可能だ。

  * 並び替え
  * 絞り込み
  * ピボット
  * 2D/3D 図式などによる視覚的表現

Associating a range with a name
======================================================================

シート内にデータベース表を仕込むには、その表が占める領域が要る。その領域とは、一
つ以上のセルが連続するグループであるような範囲により表される。表に対する範囲にア
クセスしやすくするために、範囲に意味のある名前を与えることが可能だ。

名前の利点を挙げると：

* 範囲を特定しやすくなる。
* アドレスだけでなく名前でも参照可能。
* 名前付き範囲への名前による参照が範囲のアドレスが変更されるたびに自動的に更新
  される。
* 名前付き範囲はすべて Navigator (:kbd:`F5`) から閲覧可能かつアクセス可能。

Calc には二種類の名前付き範囲が存在する：

データベース範囲
   データベースのような操作の設定を保存する名前付き範囲
標準的範囲
   データベース範囲でない名前付き範囲

.. admonition:: 利用者ノート

   この分類はどういうことだ？

Named ranges
----------------------------------------------------------------------

以下、単一の行列のような（連結成分が一つしかない）セル範囲として定義された名前付
き範囲について述べられる。

新しい名前付き範囲を作成する簡単な方法は：

#. シートで関連するセルを選択
#. 数式バーの左にある :guilabel:`Name Box` 欄に名前を入力
#. 入力中に表示される :guilabel:`Define Name for Range` ツールチップに注目し、入
   力が終わったら :kbd:`Enter` を押す

:guilabel:`Define Name` ダイアログボックスを使う方法もある。次のどちらかで開く：

* メニュー :menuselection:`&Sheet --> &Named Ranges and Expressions -->
  &Define...` 実行
* :guilabel:`Manage Names` ダイアログボックスで :guilabel:`&Add...` を押す

:guilabel:`Manage Names` ダイアログボックスの開き方は：

* :kbd:`Ctrl` + :kbd:`F3` を押す
* 数式バーの左にある :guilabel:`Name Box` ドロップダウンリストで
  :menuselection:`Manage Names...` を実行

:guilabel:`Paste Names` ダイアログボックスを使えば、定義済み名前付き範囲を入力す
るのが楽になる。開き方は次のどちらかを実行：

* メニュー :menuselection:`&Insert --> &Named Ranges or Expressions...`
* メニュー :menuselection:`&Sheet --> &Named Ranges and Expressions -->
  &Insert...`

項目を選択して :guilabel:`&Paste` ボタンを押せば、現在のキャレット位置に選択した
名前付き範囲が貼り付く。

範囲については Chapter 7, 8 を参照しろ。

Creating named ranges using row or column headers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

メニュー :menuselection:`&Sheet --> &Named Ranges and Expressions -->
&Create...` コマンドの用途：

表ヘッダーから名前付き範囲を複数同時に作成可能だ。これらのヘッダーは、表の境界線
（上下の行、左右の列）から引くもので、ヘッダーに対応する各行または各列は名
前付き範囲自体の作成に使用される。

例えば、表の一番上の行に含まれるヘッダーから範囲を作成する場合、それぞれの範囲は
ヘッダーラベルそれぞれに対応する列から生成される。

ヘッダーセルはこのコマンドを使って生成された名前付き範囲には含まれない。

手順：

#. シートにて名前付き範囲を作成する表を選択する。ヘッダーの行や列も選択に含め
   ろ。
#. 上記メニューを実行して :guilabel:`Create Names` ダイアログボックスを開く。
#. チェックボックスのオンオフを確認する。
#. :guilabel:`&OK`

この挙動があるので、複数の行や列に同じラベルを付けてはいけない。

Database ranges
----------------------------------------------------------------------

データベース範囲はデータベースの表のように使用することを意図して設計されている。
各行はレコードを表し、各セルはレコード内のフィールドを表す。データベース範囲は名
前付き範囲と以下の点で異なる：

* データベース範囲は数式ではあり得ない。
* データベース範囲は単一の矩形セル範囲でしかあり得ない。
* データベース範囲では最初の行と最後の行を見出しと小計用途としてそれぞれ書式を有
  する。表のフィールドそれぞれに対して、セルの書式を保持することもできる。
* データベース範囲はシート内のアドレスからの相対参照不可。
* データベース範囲は、並び替え、絞り込み、小計、データインポートの設定を記述子と
  呼ばれるデータ構造に格納し、マクロを使用してアクセスすることが可能（データベー
  ス操作が実行されると記述子は更新される）。
* データベース範囲は外部データに接続することが可能（そこからデータをスプレッド
  シートに取り込む）。

データベース範囲の定義には :guilabel:`Define Database Range` ダイアログボックス
を使う。

#. （全範囲を自動決定させる場合）データベース表のセル領域内のセルを一つ選択する
#. メニュー :menuselection:`&Data --> &Define Range...` 実行
#. :guilabel:`Name` 欄に範囲名を入力する（変な字は使うな）
#. 必要なら :guilabel:`Options` を展開してオプションを指定する
#. :guilabel:`&Add` を押してデータベース範囲一覧に範囲を追加する
#. :guilabel:`&OK`

既存データベース範囲を変更する手順：

#. メニュー :menuselection:`&Data --> &Define Range...` 実行
#. 範囲一覧から項目を一つ選ぶ（または名前を直接指定）とボタンのラベルが
   :guilabel:`M&odify` に変化する
#. ダイアログボックス内 :guilabel:`Range` や :guilabel:`Options` で変更を加える
#. :guilabel:`M&odify`
#. :guilabel:`&OK`

既存データベース範囲を削除する手順：

#. メニュー :menuselection:`&Data --> &Define Range...` 実行
#. 範囲一覧から項目を一つ選ぶ（または名前を直接指定）
#. :guilabel:`&Delete`
#. :guilabel:`&Yes`
#. :guilabel:`&OK`

既存データベース範囲を選択する手順：

#. メニュー :menuselection:`&Data --> &Select Range...` 実行
#. 一覧から項目を選択
#. :guilabel:`&OK`

データ源からデータを取得して新規データベース範囲を作成する手順：

#. Data Sources Explorer を開く
#. 左窓で目的データ源ツリーを展開
#. 必要な表または問い合わせをクリックし、その構成データを右窓に表示する
#. 右窓の全データを選択
#. データの左上隅になるスプレッドシートセルにデータをドラッグ＆ドロップ

これでインポートされたデータのセル範囲を包含し、Import1, Import2 などの形式の既
定の名前を持つ新規データベース範囲が自動的に生成する。

メニュー :menuselection:`Data --> R&efresh Range` を選択すると、関連するデータ源
のデータが更新されればデータベース範囲の内容が更新される。シートのデータは外部
データベースのデータと一致するように更新される。リンク方法については Chapter 11
を参照しろ。

Sorting
======================================================================

   Sorting is the process of rearranging data in a range or a sheet according to
   a specified sort order.

単一列の値に基づいてデータベース表を並び替えるもっとも単純な方法：

#. 列のセルをどれでもよいので選択
#. 昇順に並び替えるならば次のいずれかを実行（降順の場合は対応する UI を使用）：

   * :menuselection:`&Data --> Sort &Ascending` を実行
   * 標準ツールバーの :guilabel:`Sort Ascending` 図像をクリック
   * AutoFilters を有効にしている場合は、関連列の AutoFilter コンボボックスで昇
     順並び替えを選択してもよい

これらの並べ替えコマンドは自動的に表が占めるセル範囲すべてを識別し、指示された列
の値のみに基づいて表全体を並べ替える。ただし、ヘッダー行はそれと認識され、並べ替
えの対象から外れる。

AutoFilter コンボボックスは次節で述べられるが、メニュー:menuselection:`Sort by
Color` に加え、:menuselection:`Sort Ascending` と :menuselection:`Sort
Descending` の項目もある。

複雑な並び替えを実現するには、メニュー :menuselection:`&Data --> &Sort...` を実
行して :guilabel:`Sort` ダイアログボックスを開く。開く前に表内のセルを一つ選択し
ておけ。

タブ :guilabel:`Sort Criteria` では並び替えを三段階指定することが可能。
:guilabel:`Sort Key` キー番号の小さいものから大きいのものへ順次並び替えられる。

タブ :guilabel:`Options` にはさらなる並び替えオプションが用意されている。これら
については Chapter 2 を参照しろ。

Filtering
======================================================================

   A filter is a tool that hides or displays records within a sheet based on a
   set of filtering criteria.

絞り込みは長いデータ一覧から特定の項目を発見するのに便利だ。三種類の絞り込みがあ
る：

* :menuselection:`&Data --> Auto&Filter`
* :menuselection:`&Data --> More &Filters --> &Standard Filter...`
* :menuselection:`&Data --> More &Filters --> &Advanced Filter...`

データベース表に適用されている絞り込みを解除したい場合には :menuselection:`&Data
--> More &Filters --> &Reset Filter` を実行。

Chapter 2 も参照しろ。

AutoFilter
----------------------------------------------------------------------

* もっとも簡単な絞り込み
* データ列の上部にある▼ボタンからコンボボックスにアクセス

データベース表の列すべてに AutoFilters を追加するには、

#. 表内のセルをどれでもいいからクリック
#. 次のいずれかを実行：

   * :menuselection:`&Data --> Auto&Filter`
   * :guilabel:`Standard` ツールバー :guilabel:`AutoFilter` 図像クリック
   * :kbd:`Ctrl` + :kbd:`Shift` + :kbd:`L` 押し

AutoFilter 全解除手順は次のいずれかを実行：

* :menuselection:`&Data --> Auto&Filter`
* :menuselection:`&Data --> More &Filters --> &Hide AutoFilter`
* :guilabel:`Standard` ツールバー :guilabel:`AutoFilter` 図像クリック
* :kbd:`Ctrl` + :kbd:`Shift` + :kbd:`L` 押し

コンボボックスのオプション：

* 昇順か降順で並び替え
* 背景色か文字色で並び替え
* 背景色か文字色で絞り込み
* :menuselection:`Filter by Condition -->` 以下にある絞り込み項目

  * :menuselection:`Empty`
  * :menuselection:`Not Empty`
  * :menuselection:`Top 10`
  * :menuselection:`Bottom 10`
* チェックボックス各種は値の絞り込みに対応
* 列に絞り込みが適用中の場合、:guilabel:`Clear Filter` で解除

Standard filters
----------------------------------------------------------------------

* 標準絞り込みは AutoFilters よりも複雑で、最大八つの絞り込み条件を設定可能。
* 強力絞り込みは正規表現により設定可能。
* 標準絞り込みはダイアログボックスを使用する。開き方は：

  * :menuselection:`&Data --> More &Filters --> &Standard Filter...`
  * AutoFilter コンボボックスの :menuselection:`Standard Filter...` オプション

Chapter 2 参照。

Advanced filters
----------------------------------------------------------------------

高度な絞り込みの判定基準は、ダイアログボックスに入力するのではなく、シートに保存
される。そのため、使う前にまず絞り込み基準を含むセル範囲を設定する必要がある。

判定基準範囲を設定する手順：

#. 絞り込む範囲の列見出しをシートの空き地にコピー（別シートでかまわない）
#. 判定基準範囲列見出しの下に絞り込み判定を入力する。

   * 同じ行の判定は AND で接続される
   * 各行の判定グループは OR で接続される
   * 空セルは無視される
   * 絞り込み一つあたり最大八行定義可能

ここまでやって高度な絞り込みを設定することになる：

#. 絞り込み対象セル範囲を選択（データベース表ならばセル一つでいい）
#. :menuselection:`&Data --> More &Filters --> &Advanced Filter...`
#. ダイアログボックス操作
#. :guilabel:`&OK`

個々の名前付き範囲に対して、:guilabel:`Define Name` と :guilabel:`Manage Names`
ダイアログボックスで :guilabel:`&Filter` にチェックを入れることができる。この方
法で絞り込みのためにマークされた名前付き範囲しか :guilabel:`Advanced Filter` ダ
イアログボックスの :guilabel:`Read Filter Criteria From` 欄のドロップダウンボッ
クスで選択できない。データベースの範囲はドロップダウンボックスで選択できない。

.. admonition:: 利用者ノート

   本文のこの辺にあるデモを再現しろ。データは：

   .. code:: text

      Student	HW #1	HW #2	HW #3	Quiz #1	Quiz #2	Test #1
      Andrew	90	100	82	90	88	92
      Bethany	95	100	82	80	88	93
      Charles	80	93	73	80	75	84
      David	75	86	91	40	88	79
      Emily	100	100	81	100	75	94
      Ferdinand	85	93	73	60	50	72
      Georgia	70	80	55	39	75	67
      Haley	85	93	82	70	75	76
      Ian	100	100	91	90	100	96
      Jennifer	85	93	73	80	100	90

Useful database-like functions
======================================================================

Database category functions
----------------------------------------------------------------------

Overview
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Database 区分にある関数 12 個はスプレッドシート内の矩形領域を占める単純なデータ
ベースを分析するのに役立つことを目的としており、データは各レコードごとに一行とし
て整理されている。各列のヘッダーセルには列の名前が表示され、通常、その列の各セル
の内容を示す。

Database 区分の関数は次の三つの引数を取る：

Database
   データベースのセル範囲
DatabaseField
   関数の計算に用いるデータを含む列
SearchCriteria
   検索条件を含む別領域セル範囲

Database function arguments
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. rubric:: Database

* 範囲の最初の行はフィールド名からなり、それ以降の行は対応するフィールド値を持つ
  レコードだ。
* セル範囲定義としては、矩形の左上と右下のセル参照をコロンで結合する。``A1:E10``
  のように。
* 名前付き範囲またはデータベース範囲名を指定してもよい。こちらのほうが可読性と保
  守性を向上する。

.. rubric:: DatabaseField

* 検索条件が適用されデータ行が選択された後、関数が計算に使用する列を指定する。
* この引数を指定する方法はいろいろある。

  * データベース領域内のヘッダーセルへの参照あるいは（有効な）名前を入力する。
  * データベース領域内の列を 1 から開始する（有効な）番号で指定する。
  * データベース範囲の最初の行から見出し名をリテラル文字列で指定する。
* ``DCOUNT``, ``DCOUNTA`` 以外の Database 関数ではこの引数は入力必須だ。

.. rubric:: SearchCriteria

* Database 引数と同様に、最初の行はフィールド名。それ以降の行は関連フィールドに
  ついての条件だ。
* Database 領域と SearchCriteria 領域は隣接している必要はない。同一シート内にあ
  る必要もない。
* セル範囲定義方法は Database 引数と同様。

Defining search criteria
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

* SearchCriteria 領域が占める列数は Database 領域の幅に一致する必要はない。
* SearchCriteria の最初の行に現れる見出しすべては Database のそれと一致する必要
  がある。
* 条件式は SearchCriteria 領域の二行目以降のセルに入力される。
* 比較演算子を用いて SearchCriteria 領域セルに条件を作成する。セルが空でなく、比
  較演算子で始まらないものは ``=`` とみなされる。

.. admonition:: 利用者ノート

   正規表現に関する事項と MS Excel との互換性に関する事項は割愛。

Example of Database function use
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

本書のスクリーンショットに倣え。

.. code:: text

   Name	Grade	Age	Distance (meters)	Weight (kg)
   Andy	3	9	150	40
   Betty	4	10	1000	42
   Charles	3	10	300	51
   Daniel	5	11	1200	48
   Eva	2	8	650	33
   Frank	2	7	300	42
   Greta	1	7	200	36
   Harry	3	9	1200	44
   Irene	2	8	1000	42

List of Database functions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

これらの関数は計算中、日付や論理値を数値として扱う。

DAVERAGE
   指定された検索条件に一致するすべての行について、指定された列のセル（フィール
   ド）の数値の平均を計算する。
DCOUNT, DCOUNTA
   指定された検索条件に一致するすべての行に対して、指定された列のうち

   * 数値を含むセルの数を返す。
   * 空でないセルの数を返す。

   列が指定されていない場合、内容に関係なく、指定された検索条件に一致するすべて
   のレコードの数を返す。
DGET
   指定された検索条件に一致する唯一の行に対して、指定された列のセル内容を返す。
DMAX, DMIN
   指定された検索条件に一致するすべての行について、数値を含む指定された列のセル
   全体の最大値、最小値を計算する。

   * 空白セルや数値以外の文字を含むセルは含まれない。
   * 一致するレコードが見つからない場合など、変な場合には 0 を返す。
DPRODUCT
   すべての数値の積を返す。
DSTDEV, DSTDEVP
   指定された検索条件に一致するすべての行について、指定列のセル内の数値に基づい
   て標本標準偏差、母集団標準偏差を計算する。数値以外の値は無視。
DSUM
   すべての数値の和を返す。
DVAR, DVARP
   標本分散、母集団分散。

Other database-like functions
----------------------------------------------------------------------

Calc に用意されている関数の中には、表形式のデータで使用することを意図したもの
(e.g. ``HLOOKUP``, ``VLOOKUP``) もあれば、どのような状況でも使用できるものもあ
る。

本書の表はデータベースに Calc の表を使用する場合に役立つ関数の一覧だ。その多く
は、データベース以外の状況で使用される典型的なスプレッドシート関数としておなじみ
のものだが、中にはデータベース表テーブルで特に役立つものもある。
