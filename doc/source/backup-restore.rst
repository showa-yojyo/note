======================================================================
バックアップ＆復旧ノート
======================================================================

本ノートは私の Windows PC 環境を復旧・復元可能な水準でバックアップする手順を述べ
るものだ。

.. contents::

目的と目標
======================================================================

OS は Windows 10 だが、OS をアップグレードしても旧環境の良さを持ち越したいので、
後述の手順すべてにおいてそれを念頭に置きたい。

再びホームレスになっても対応し易いようにノート PC であることを想定する。

バックアップと復旧の目標は盗難にあっても新 PC でなじみの環境を復旧できることだ。

バックアップ原則
======================================================================

* 手順を自動化しておくのが望ましい。
* 専門家のオンラインサービスを利用することを優先する。次の条件が望ましい：

  * 利用期間が設けられていない（一定期間後、サービスが対象ファイルを削除しない）
  * サービス側が対象ファイルの内容を検閲しない

* インターネットからダウンロード可能なファイルや、公開データから復元可能なファイ
  ルについては、成果物そのものをバックアップしないで URL を記録しておく。
* 機密情報は生データをバックアップしない。最低限パスワード付き圧縮ファイルに変換
  してバックアップする。
* テキストファイルは許す限り GitHub_ にリポジトリーを用意する。ただし Private
  モードに頼らない。
* ファイル以外の形式で保存される情報のバックアップを漏らさない。

全体バックアップ＆復元
======================================================================

本節の内容が毎回実現可能であれば、以降の節は実施しなくていい。

準備例
----------------------------------------------------------------------

HDD 250GB から SSD 500GB に以降した際の手順を記す。次に Windows 全体をバックアッ
プ＆復元する際にはこの手順を再現すればいいはずだ。

次の物品をまず用意する：

* ネジ回しセット
* 玄人志向 2.5 型ドライブケース
* SanDisk SSD (500GB)

.. figure:: /_images/ssd.jpg
   :align: center
   :alt: ネジ回し、ドライブケース、SSD の写真（なお USB 棒は今回は不使用）

ネジ回しとドライブケースは何度でも再利用可能。一度だけ調達すれば十分だ。肝腎の
SSD については新品を支度しろ。バックアップ元のドライブ容量より大きいことが望まし
い。

クローンソフトを利用する方法でバックアップした。次の Western Digital Corporation
のサイトからダウンロードできる Acronis True Image for Western Digital を利用し
た：

`WD 製品のソフトウェア、ファームウェア、およびドライバー <https://support-jp.wd.com/app/answers/detailweb/a_id/7225>`__

これを利用したいので SanDisk SSD を購入したのだ。ZIP ファイルの容量が 700MB くら
いあるので注意。

手順例
----------------------------------------------------------------------

.. rubric:: バックアップ

1. クローンソフトをダウンロードする。
2. 圧縮ファイルを解凍。Acronis True Image for Western Digital インストーラーを起
   動。

並行して次を進める：

1. 外付けドライブケースに SanDisk SSD を装着する。
2. PC と 2. のケースをケーブルで接続し、Windows に認識させる。
3. Windows 画面に戻り、Windows ボタンの右クリックメニューから
   :menuselection:`コンピューターの管理 --> 記憶域 --> ディスクの管理` でバック
   アップ先ストレージをフォーマット。

上の二工程を終えたら Acronis True Image for Western Digital でクローンを開始す
る。しばらくして進捗バーが表示される。処理時間見込みはあまりあてにならない。意外
に早く完了することがある。クローンに専念させたいので、Windows 側で稼働している他
のプログラムを可能な限り終了するといい。ネットワークも切断する。

以上で Windows 丸ごとのバックアップが完了したことになる。バックアップストレージ
を保管する。

.. rubric:: 復元

クローンが終了した後に次を行えば、復元は終了だ。

1. PC の電源を落とす。バッテリーを外して数分待つ。
2. PC をひっくり返し、ネジ回しで HDD 部分を開ける。構造を確認する。
3. もう一度ネジ回しで本体側ドライブに取り付けられているネジを外す。側面を覆う部
   品からもネジを外す。この部品にバックアップ SSD を取り付ける。
4. SSD を取り付けて PC の蓋と電源を復元。スイッチを入れる。

以上で復元完了となる。いつものように Windows にログインすればいい。復元後、スト
レージの内容を適宜整理する。

.. admonition:: 利用者ノート

   なお、Windows 11 以降にこの手順が適用可能であるか不透明だ。そのときに本項を改
   訂する。

部分的バックアップ＆復元
======================================================================

前節の内容を毎回実施可能ならば、本節は本質的には不要だ。

急所のデータ（主にファイル）だけをバックアップできれば十分という場合もある。全体
バックアップとは別に、個別にバックアップ可能であるものは追加的にそうしておきた
い。まずバックアップ対象を自分の中で確定してしまう。

* ソフトウェアおよびその設定
* ユーザーファイル (``%USERPROFILE%``)
* ブックマーク
* メール
* レジストリー
* 環境変数
* 機密データ
* WSL

ソフトウェアおよびその設定
----------------------------------------------------------------------

これはソフトウェア本体と設定を分けて考える必要がある。

Windows 標準のインストーラーを使ってインストールしたソフトに関しては、インストー
ラー配布場所を控えておいて、後でインストーラーを入手し、それを用いて復元可能だ。
とりわけ、:program:`winget` で管理しているものについては自動処理も視野に入れた操
作が容易だ。いつでも最新版の実行形式をインストールしたい場合にはこれでいい。

インターネット上ではすでに配布されていない版のソフトウェアが必要である場合、イン
ストーラーを適当な USB 棒にたいせつに保存しておく。もっとも、そういうソフトは利
用しないで済むのが望ましい。

.. seealso::

   :doc:`/winget`

設定はソフトウェアごとに保存方式が異なるので、バックアップ方法も異なる。場合分け
して実施する。

* :file:`%APPDATA%` など、設定ファイル用フォルダーのサブフォルダーにあるファイル
* レジストリーのソフトウェア固有のエントリー
* それ以外

:file:`%APPDATA%` からバックアップ対象のソフトウェアに関するフォルダーごとバック
アップストレージに保管する。フォルダーを上書きして復元する。

なお、:file:`%APPDATA%` 以外にも、次のフォルダーも気をつける：

* :file:`%HOME%`
* :file:`%HOME\\.config%`

レジストリーに設定を書き出すソフトウェアに関しては、レジストリーをエクスポートし
て ``reg`` ファイルをバックアップストレージに保管する。エクスポートのときに、ソ
フトウェアエントリー単位で行うと、ソフトウェアごとに復元することができて柔軟だ。

それ以外について、例えばインストールフォルダーの内部に設定ファイルを保存するよう
なものについてはバックアップは厄介だ。ファイルを個別にバックアップせねばならな
い。管理が煩雑だし、復元時も面倒だ。

ユーザーファイル
----------------------------------------------------------------------

基本的に、自作の書類、帳簿、ビデオなどはフォルダー :file:`%USERPROFILE%` の対応
するサブフォルダーに作成する習慣とする。これらのサブフォルダーについては、丸ごと
バックアップストレージにコピーして保管するのが理想的だ：

* :file:`%USERPROFILE%\\Desktop`
* :file:`%USERPROFILE%\\Documents`
* :file:`%USERPROFILE%\\Downloads`
* :file:`%USERPROFILE%\\Favorites`
* :file:`%USERPROFILE%\\Music`
* :file:`%USERPROFILE%\\Pictures`
* :file:`%USERPROFILE%\\Videos`

なお、そもそもデスクトップにファイルを配置しないほうがいい。それ以外のサブフォル
ダーに移す。

ファイルサイズが大きいはずなので、一部はバックアップ不能というのが普通だ。そうい
う場合は後述の（無料）ストレージサービスを利用するなどして分散保管する。それ以外
はフォルダーごとバックアップ先に保管する。

Windows PC を新規調達した場合には、これらのサブフォルダーを新環境の
:file:`%USERPROFILE%` にマージ上書きする。これで復元したことになる。

ブックマーク
----------------------------------------------------------------------

私は Windows 既定のブラウザーをいっさい利用していないので、上述の
:file:`%USERPROFILE%\\Favorites` バックアップでは不十分だ。Sleipnir のバックアッ
プで代える。

以下、Sleipnir のブックマークと RSS の簡易バックアップ方法を記す。ブックマークに
ついては次の手順で出力される HTML ファイルを適宜保管する：

1. :guilabel:`Sleipnir --> ブックマークのエクスポート (&E) ...` を選択
2. 保存先フォルダーをツリー上で選択して :guilabel:`OK` を押す

.. todo::

   復元手順が特殊なのでよく調べてから記す。いったん Internet Explorer か
   Microsoft Edge を経由する方法があると記憶している。

ブックマークの他に RSS リーダーもバックアップする。

1. :guilabel:`Sleipnir --> 表示 (&V) --> FeedReader を表示` を選択して表示状態に
   する
2. :guilabel:`すべてのアイテム` を選択状態にする
3. 歯車メニューから :guilabel:`インポートおよびエクスポート --> OPML 形式でエク
   スポート (&I)...` を選択
4. 保存先ファイルを決定して :guilabel:`保存 (&S)` を押す

保存先の既定パスが変なところにあるので注意すること。必ずバックアップ先に変えろ。
復元手順は上記手順のエクスポートの代わりにインポートを指示すれば後は自明だ。

メール
----------------------------------------------------------------------

メールは Hotmail 現 `Outlook.com`_, Gmail_ など、外部サーバーに保管してあるから
余計なことをしなければバックアップを考えないほうがいい。自分でバックアップするよ
り保管成功率がはるかに高い。

Thunderbird_ などのメールクライアント環境（設定）のバックアップと復元するには、上
述のソフトウェア一般に関する節で述べた方法を採用する。

Windows レジストリー
----------------------------------------------------------------------

レジストリーは基本的に一枚岩のファイルなので、全体バックアップでいいと思う。その
部分を後から抽出することは専用エディターで可能であるはず。試しにレジストリー全体
をエクスポートしたら 300MB を超える ``reg`` ファイルが生じた。

本番時に次の記事を参照すればいいだろう：

* `How to back up and restore the registry in Windows - Microsoft Support
  <https://support.microsoft.com/en-au/topic/how-to-back-up-and-restore-the-registry-in-windows-855140ad-e318-2a13-2829-d428a2ab0692>`__
* `特定のレジストリ・キー以下を素早くバックアップする － ＠IT
  <https://atmarkit.itmedia.co.jp/fwin2k/win2ktips/593regsave/regsave.html>`__

.. admonition:: 利用者ノート

   :kbd:`CapsLock` と左 :kbd:`Ctrl` を入れ替えるためにレジストリーを使っていて、
   そのバックアップと復元が気になているような場合、レジストリー操作手順が Google
   検索ですぐに見つかるので、バッアップしないで済む。

機密データ
----------------------------------------------------------------------

機密情報・データには次のものがある：

* 求人応募資料群（履歴書、職務経歴書、証明写真、応募履歴台帳）
* 報告書、家計簿、納税ファイル
* パスワード台帳、SSH 秘密鍵を含むテキストファイル、設定ファイルの機密情報部分

次のいずれかの形式で保管すること：

* パスワード付きスプレッドシート (Excel, LibreOffice, etc.)
* パスワード付き ZIP ファイル

これは通常時でもパスワードを付けて管理するのが安全保障上望ましい。解凍パスワード
は脳裡にのみ収めること。

暗号化ファイルの保管先はオンラインストレージが実はいい。自分で所有している USB
棒やドライブでは足りない。ホームレスのときにノート PC ごと盗難に遭った時にそれで
しのいだ実績がある。

WSL
----------------------------------------------------------------------

WSL 環境を丸ごとバックアップする方法は、それを含む Windows 環境を丸ごとバック
アップする方法を除けば次の記事のようにする：

`How to back up and restore a Windows Subsystem for Linux (WSL) distro
<https://www.xda-developers.com/how-back-up-restore-wsl/>`__

.. seealso::

   :doc:`/wsl` 内「Linux ディストリビューションをインポート・エクスポートする」

利用ツール
======================================================================

バックアップおよび復元の際に用いるツールおよび手順を述べる。

最近使っていないが、:program:`rsync` などのコマンドラインツールも組み合わせると
効率がいいかもしれない。

オンラインストレージ
----------------------------------------------------------------------

次のサービスをバックアップするファイルの性質によって使い分ける。無料プランでも
けっこうな容量を使わせてくれる。

`Dropbox <https://www.dropbox.com/>`__
   無料プランで 2GB 利用可。比較的ファイル容量の小さい個人情報ファイルを暗号化か
   つ圧縮して保管している。対象ファイルはローカルとリモートの両方に存在する方式
   だ。個人的には PC を盗まれた後にファイルを失わずに済んだ実績がある。盗難 PCか
   のアクセスを奪うことも可能だが、PC 本体内のストレージに同じファイルがあるの
   で、やはりパスワードを付けるのが肝要だ。

   Web ブラウザーからもファイルにアクセス可能。しかし、普通は Dropbox サービスを
   稼働させておき、Windows Explorer でファイル操作する運用だ。
`Google Drive`_
   私は未使用。Gmail_ などのサービスと利用可能容量が統合されていて、関係サービス
   全体で消費可能な容量の和の上限が 15GB ということだ。

   長期間（二年？）放置で、保管ファイルが削除されるという規約があるようだ。これ
   を逆用したい場合に利用しよう。
`Microsoft OneDrive <https://www.microsoft.com/ja-jp/microsoft-365/onedrive/online-cloud-storage>`__
   私は未使用。:file:`%USERPROFILE%\\OneDrive` フォルダーは空にしている。`Google
   Drive`_ と似たような制約がある。
pCloud_
   無料プランではサービス提供者の要望に応えられれば最高で 10GB 利用可。自分で収
   録、編集した音声・映像ファイルで当面出番がないものを保管する用途に充ててい
   る。

   Windows のドライブレターを一つ消費する形でストレージが生じる。対象ファイルは
   接続が有効な間のみアクセス可能であり、ローカルには残らない。接続がしょっちゅ
   う切断されるようで、パスワードを毎回入力して再接続するのが面倒だ。

.. admonition:: 利用者ノート

   オンラインストレージについては調査研究が足りていない。自力でバックアップスト
   レージを確保できないほど貧窮したら必要になるサービスであるのだが。

SNS
----------------------------------------------------------------------

プラットフォームそれぞれにおいて、特定の条件に従う限りファイル容量が事実上無制限
であることを利用することが考えられる。

GitHub_
   Git リポジトリーを設置するためのサービスだが、テキストファイルのバックアップ
   場所として捉えることも利用可能だ。仲間がいれば、リポジトリーをクローンしても
   らうと安心が増すことだろう。

   対象としては日記、備忘録、報告書、原稿置場として最適。一方で、特に容量が大き
   い画像、音声、映像ファイルはバックアップ用途には不向きだ。

   設定ファイル（ドットファイル）を集約したリポジトリーを設けるのは良い習慣だ。
   環境に対応するブランチを定義して管理するといい。
`Facebook <https://www.facebook.com/>`__
   私は未使用。バックアップストレージとして利用可能なのかどうかも承知していない
   が、後述の Twitter_ と同様の見方で保管先として運用することが可能なのではと考え
   ている。
Twitter_
   かなりの制約があるが、画像や映像ファイルを投稿しておくことでバックアップとす
   る場合がある。消失する可能性がないと断言できればもっと良い用途をひねり出す。
`YouTube <https://www.youtube.com/>`__
   私は未使用。自分が収録、編集した音声および映像ファイルのバックアップストレー
   ジとして応用することが考えられる。

ハードウェア
----------------------------------------------------------------------

USB 棒、携帯電話、外付け SSD などを所有していれば利用する。

USB 棒は一時的なバックアップ先という役目で使用している。用事が済んだらバックアッ
プのほうを消去。コンパクトさゆえに丸ごと紛失しやすいので、さらに守備的な運用にな
る。

本当に重要なファイルに限り、オンラインストレージに加え携帯電話内のストレージにも
複製を保存しておく。携帯電話にインストールされているオンラインストレージとの連携
アプリがクラウドに結局バックアップするから冗長であるという気がしないでもない。

外付け SSD については先述のとおり。新調するときにはジャンクショップではなく、量
販店で買い求めろ。遊び目的ではないのだ。

参考文献
======================================================================

偉大なる先人に深く感謝───。

* `File hosting service - Wikipedia
  <https://en.wikipedia.org/wiki/File_hosting_service>`__
* `Windows10ノートPCのHDDをクローンでSSDに交換・換装する方法
  <https://itojisan.xyz/%E3%83%91%E3%82%BD%E3%82%B3%E3%83%B3%E3%81%AE%E7%9F%A5%E8%AD%98/%E3%83%8E%E3%83%BC%E3%83%88pc%E3%81%AEssd%E6%8F%9B%E8%A3%85/#SSD>`__
* `HDDからSSDにシステムイメージで換装 クローンソフト不要 【完全無料 2023年版】激
  安のSSD「SUNEAST」 Windowsの標準機能で換装 - YouTube
  <https://www.youtube.com/watch?v=LYfIBbkGZgo>`__
* `Windows10のシステムイメージバックアップ(PC丸ごとバックアップ)のやり方 -
  YouTube <https://www.youtube.com/watch?v=mHTGYCLUDRM>`__
* `【最新版】無料で使えるクローンソフト「Acronis True Image for Western
  Digital」の紹介 | たびびとライフ
  <https://tarelife.com/acronis-clone-sandisk/>`__

.. _GitHub: https://github.com/
.. _Gmail: https://www.google.co.jp/intl/ja/gmail/about/
.. _`Google Drive`: https://www.google.com/drive/
.. _pCloud: https://www.pcloud.com/
.. _Thunderbird: https://www.thunderbird.net/
.. _Twitter: https://twitter.com/
.. _`Outlook.com`: http://outlook.com/
